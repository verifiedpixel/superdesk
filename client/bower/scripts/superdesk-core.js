!function(){"use strict";function a(a){a.dispatchEvent(new MouseEvent("click"))}function b(a){for(var b=a.parentNode;a.hasChildNodes();)b.insertBefore(a.childNodes.item(0),a);b.removeChild(a)}function c(a,c){for(var d=a.cloneNode(!0),e=d.getElementsByClassName(c);e.length;)b(e.item(0));return d.normalize(),d}function d(a,b){for(var c,d=document.createTreeWalker(a,NodeFilter.SHOW_TEXT),e=0,f=String.fromCharCode(65279);d.nextNode();){if(d.currentNode.textContent=d.currentNode.textContent.replace(f,""),c=d.currentNode.textContent.length,e+c>=b)return{node:d.currentNode,offset:b-e};e+=c}}function e(a){var b=[],c=-1;this.add=function(a){c+=1,b[c]=a,b.splice(c+1,b.length)},this.selectPrev=function(){c=Math.max(-1,c-1)},this.selectNext=function(){c=null!=b[c+1]?c+1:c},this.get=function(){var d=c>-1?b[c]:a;return d}}function f(a,b){function f(a){return c(a,p)}function g(a){var b=h(a);j(a,b,r)}function h(a){var b=[],c=s.settings.findreplace.needle||null;if(!c)return b;for(var d,e,f=document.createTreeWalker(a,NodeFilter.SHOW_TEXT),g=0;f.nextNode();){for(e=f.currentNode.textContent;(d=e.indexOf(c))>-1;)b.push({word:e.substr(d,c.length),index:g+d}),e=e.substr(d+c.length),g+=d+c.length;g+=e.length}return b}function i(b){a.errors(b).then(function(a){j(b,a,o)})}function j(a,b,c){s.storeSelection(a),angular.forEach(b,function(b){k(a,b,c)}),s.resetSelection(a)}function k(a,b,c){var e=d(a,b.index),f=d(a,b.index+b.word.length);e.node!==f.node&&(e.node=f.node,e.offset=0);var g=e.node.splitText(e.offset),h=document.createElement("span");h.classList.add(c),h.classList.add(p),g.splitText(f.offset-e.offset),h.textContent=g.textContent,g.parentNode.replaceChild(h,g)}function l(a,b){for(;a.length;){var c=a.item(0),d=document.createTextNode(b);c.parentNode.replaceChild(d,c),d.parentNode.normalize()}}function m(a){for(var b=a.getElementsByClassName("rangySelectionBoundary");b.length;){var c=b.item(0);c.parentNode.removeChild(c),c.parentNode.normalize()}return a}function n(a){var b=a.history.get();null!=b&&(a.node.innerHTML=b,a.model.$setViewValue(b))}this.settings={spellcheck:!0},this.KEY_CODES=Object.freeze({Y:"Y".charCodeAt(0),Z:"Z".charCodeAt(0)}),this.ARROWS=Object.freeze({33:1,34:1,35:1,36:1,37:1,38:1,39:1,40:1}),this.META=Object.freeze({16:1,17:1,18:1,20:1,91:1,93:1,224:1}),this.shouldIgnore=function(a){return s.ARROWS[a.keyCode]?!0:s.META[a.keyCode]?!0:a.shiftKey&&(a.ctrlKey||a.metaKey)?!0:!1};var o="sderror",p="sdhilite",q="sdactive",r="sdfindreplace",s=this,t=[];this.registerScope=function(a){t.push(a),a.history=new e(a.model.$viewValue),a.$on("$destroy",function(){var b=t.indexOf(a);t.splice(b,1)})},this.cleanScope=function(a){s.storeSelection(a.node);var b=f(a.node).innerHTML;return b=b.replace("\ufeff",""),a.node.innerHTML=b,s.resetSelection(a.node),b},this.renderScope=function(a,b){s.cleanScope(a),s.settings.findreplace?g(a.node):(s.settings.spellcheck||b)&&i(a.node)},this.render=function(){t.forEach(s.renderScope)},this.selectNext=function(){for(var a=document.body.getElementsByClassName(p),b=0;b<a.length;b++){var c=a.item(b);if(c.classList.contains(q))return c.classList.remove(q),void a.item((b+1)%a.length).classList.add(q)}a.length&&a.item(0).classList.add(q)},this.selectPrev=function(){for(var a=document.body.getElementsByClassName(p),b=0;b<a.length;b++){var c=a.item(b);if(c.classList.contains(q))return c.classList.remove(q),void a.item(0===b?a.length-1:b-1).classList.add(q)}},this.replace=function(a){t.forEach(function(b){var c=b.node.getElementsByClassName(q);l(c,a,b),s.commitScope(b)})},this.replaceAll=function(a){t.forEach(function(b){var c=b.node.getElementsByClassName(p);l(c,a),s.commitScope(b)})},this.storeSelection=function(){s.selection=window.rangy?window.rangy.saveSelection():null},this.resetSelection=function(a){s.selection&&(window.rangy.restoreSelection(s.selection),s.selection=null),m(a)},this.setSettings=function(a){s.settings=angular.extend({},s.settings,a)},this.isErrorNode=function(a){return a.classList.contains(o)},this.commit=function(){t.forEach(s.commitScope)},this.commitScope=function(a){var b=m(f(a.node)).innerHTML;b!==a.model.$viewValue&&(a.model.$setViewValue(b),a.history.add(a.model.$viewValue))},this.undo=function(a){a.history.selectPrev(),n(a)},this.redo=function(a){a.history.selectNext(),n(a)}}f.$inject=["spellcheck","$rootScope"],angular.module("superdesk.editor",["superdesk.editor.spellcheck"]).service("editor",f).directive("sdTextEditor",["editor","spellcheck","$timeout",function(b,c,d){function e(a){function b(a){return a.split("\n").length}for(var c=0;a;)a.childNodes.length&&a.childNodes[0].nodeType===Node.TEXT_NODE?c+=b(a.childNodes[0].wholeText):a.childNodes.length&&(c+=1),a=a.previousSibling;return c}function f(){var a,b,c=window.getSelection();if(c.anchorNode.nodeType===Node.TEXT_NODE){var d=c.anchorNode.wholeText.substring(0,c.anchorOffset),f=c.anchorNode;for(a=d.length+1;"P"!==f.nodeName;)f.previousSibling?(a+=f.previousSibling.wholeText?f.previousSibling.wholeText.length:f.previousSibling.textContent.length,f=f.previousSibling):f=f.parentNode;b=0+e(f)}else b=0+e(c.anchorNode),a=1;return{line:b,column:a}}var g={buttons:["bold","italic","underline","quote","anchor"],anchorInputPlaceholder:gettext("Paste or type a full link"),disablePlaceholders:!0,spellcheck:!1};return{scope:{type:"=",config:"=",language:"="},require:"ngModel",templateUrl:"scripts/superdesk/editor/views/editor.html",link:function(e,h,i,j){function k(a,c){b.renderScope(e,a),e.node.classList.remove(s),c&&c.preventDefault()}function l(){e.$applyAsync(function(){b.undo(e),b.renderScope(e)})}function m(){e.$applyAsync(function(){b.redo(e),b.renderScope(e)})}function n(){b.commitScope(e)}function o(){d.cancel(r),r=d(k,500,!1)}e.model=j,b.registerScope(e);var p,q,r,s="typing";j.$viewChangeListeners.push(o),j.$render=function(){function i(a){d.cancel(q),e.node.classList.add(s)}var o=angular.extend({},g,e.config||{});c.setLanguage(e.language),p=h.find("preformatted"===e.type?".editor-type-text":".editor-type-html"),p.empty(),p.html(j.$viewValue||""),e.node=p[0],e.model=j,e.medium=new window.MediumEditor(e.node,o),e.$on("spellcheck:run",k),e.$on("key:ctrl:shift:s",k);var r={};r[b.KEY_CODES.Z]=l,r[b.KEY_CODES.Y]=m,p.on("keydown",function(a){b.shouldIgnore(a)||i(a)}),p.on("keyup",function(a){return b.shouldIgnore(a)?void 0:(i(a),a.ctrlKey&&r[a.keyCode]?void r[a.keyCode]():void(q=d(n,800,!1)))}),p.on("contextmenu",function(f){if(b.isErrorNode(f.target)){f.preventDefault();var g=h[0].getElementsByClassName("dropdown-menu")[0],i=h[0].getElementsByClassName("dropdown-toggle")[0];return h.find(".dropdown.open").length&&a(i),e.suggestions=null,c.suggest(f.target.textContent).then(function(b){e.suggestions=b,e.replaceTarget=f.target,d(function(){g.style.left=f.target.offsetLeft+"px",g.style.top=f.target.offsetTop+f.target.offsetHeight+"px",g.style.position="absolute",a(i)},0,!1)}),!1}}),"preformatted"===e.type&&p.on("keydown keyup click",function(){e.$apply(function(){angular.extend(e.cursor,f())})}),e.$on("$destroy",function(){p.off(),c.setLanguage(null)}),e.cursor={},k()},e.replace=function(a){e.replaceTarget.parentNode.replaceChild(document.createTextNode(a),e.replaceTarget),b.commitScope(e)},e.addWordToDictionary=function(){var a=e.replaceTarget.textContent;c.addWordToUserDictionary(a),b.render()}}}}])}(),function(){"use strict";function a(a){var b=this;a.links().then(function(a){angular.extend(b,a)})}a.$inject=["urls"],angular.module("superdesk.features",["superdesk.api"]).service("features",a)}(),function(){"use strict";return angular.module("superdesk.asset",["superdesk.config"]).provider("asset",["$injector",function(a){this.templateUrl=function(b){var c=a.get("config"),d=b;return/^(https?:\/\/|\/\/|\/|.\/|..\/)/.test(b)||(d="scripts/"+d),!/^(https?:\/\/|\/\/)/.test(b)&&c.paths&&c.paths.superdesk&&(d=c.paths.superdesk+d),d=d.replace(/[^\/]+\/+\.\.\//g,"").replace(/\.\//g,"").replace(/(\w)\/\/(\w)/g,"$1/$2")},this.imageUrl=this.templateUrl,this.$get=function(){return this}}])}(),function(){"use strict";return angular.module("superdesk.imageFactory",[]).factory("imageFactory",function(){return{makeInstance:function(){return new Image}}})}(),function(){"use strict";function a(){return{link:function(a,b,c,d,e){function f(){g&&g.$destroy()}var g;a.$watch("item",function(){f(),g=a.$parent.$parent.$new(),g.item=a.item,g.items=a.items,g.extras=a.extras,g.$index=a.$index,e(g,function(a){b.empty(),b.append(a)})}),a.$on("$destroy",f)}}}var b=angular.module("superdesk.list",["superdesk.keyboard","superdesk.asset"]);return b.directive("sdListView",["$location","keyboardManager","asset",function(a,b,c){return{scope:{select:"&",extras:"=",items:"="},replace:!0,transclude:!0,templateUrl:c.templateUrl("superdesk/list/views/list-view.html"),link:function(c,d,e){function f(a){if(a){var b=_.find(c.items,{_id:a});b&&c.clickItem(b)}}function g(a){return function(){if(c.items){var b=_.indexOf(c.items,c.selected);if(-1===b)return c.clickItem(_.first(c.items));var d=_.max([0,_.min([c.items.length-1,b+a])]);return 0>d?c.clickItem(_.last(c.items)):c.clickItem(c.items[d])}}}function h(a,c){b.bind(a,c)}var i=-1,j=1;h("up",g(i)),h("left",g(i)),h("down",g(j)),h("right",g(j)),c.clickItem=function(a,b){c.selected=a,c.select({item:a}),b&&b.stopPropagation()},c.$watch("items",function(){f(a.search()._id),d.find(".list-view").focus()})}}}]),b.directive("sdSearchbar",["$location","asset",function(a,b){return{scope:!0,templateUrl:b.templateUrl("superdesk/list/views/searchbar.html"),link:function(b,c){var d=c.find("#search-input");b.q=a.search().q||null,b.flags={extended:!!b.q},b.search=function(){a.search("q",b.q||null),a.search("page",null)},b.close=function(){b.q=null,b.search(),d.focus()}}}}]),b.directive("sdListItem",a),b.directive("sdUpdown",["$location","keyboardManager","$anchorScroll",function(a,b,c){return{transclude:!0,template:"<div ng-transclude></div>",scope:{items:"=",select:"&"},link:function(d,e,f){function g(a){if(a){var b=_.find(d.items,{_id:a});b&&k(b)}}function h(b){a.hash(b),c()}function i(b){return function(){if(d.items){var c=_.findIndex(d.items,{_id:a.search()._id});if(-1===c)return k(_.first(d.items));var e=_.max([0,_.min([d.items.length-1,c+b])]);return 0>e?k(_.last(d.items)):(h(d.items[e]._id),k(d.items[e]))}}}function j(a,c){b.bind(a,c)}function k(a,b){d.select({item:a}),b&&b.stopPropagation()}var l=-1,m=1;j("up",i(l)),j("left",i(l)),j("down",i(m)),j("right",i(m)),d.$watch("items",function(){g(a.search()._id),e.find(".list-view").focus()})}}}]),b.directive("sdPagination",["$location","asset",function(a,b){return{templateUrl:b.templateUrl("superdesk/list/views/sdPagination.html"),scope:{items:"="},link:function(b,c,d){function e(){window.scrollTo(0,0)}var f=25;b.pgsizes=[25,50,100],b.$watch("items._meta",function(c){b.total=0,c&&(b.total=c.total,b.page=Number(a.search().page)||1,b.limit=Number(localStorage.getItem("pagesize"))||Number(a.search().max_results)||f,b.lastPage=b.limit?Math.ceil(b.total/b.limit):b.page,b.from=(b.page-1)*b.limit+1,b.to=Math.min(b.total,b.from+b.limit-1),b.pageChanged===!0&&(e(),b.pageChanged=null))}),b.setPage=function(c){a.search("page",c>1?c:null),b.pageChanged=!0},b.setLimit=function(c){localStorage.setItem("pagesize",c),b.setPage(0),a.search("max_results",null!=c?c:f)}}}}]),b.directive("sdPaginationAlt",["asset",function(a){return{templateUrl:a.templateUrl("superdesk/list/views/sdPaginationAlt.html"),scope:{page:"=",maxPage:"="}}}]),b}(),function(){"use strict";return angular.module("superdesk.keyboard",[]).run(["$rootScope","keyboardManager",function(a,b){a.$on("$routeChangeStart",function(){angular.forEach(b.keyboardEvent,function(a,c){a.opt.global||b.unbind(c)})})}]).run(["$rootScope","$document",function(a,b){b.on("keydown",function(b){var c=b.ctrlKey||b.metaKey,d=b.shiftKey,e=c&&d;if(b.target===document.body||e){var f=String.fromCharCode(b.which).toLowerCase(),g="";g+=c?"ctrl:":"",g+=d?"shift:":"",a.$broadcast("key:"+g+f,b)}})}]).service("keyboardManager",["$window","$timeout",function(a,b){var c=[],d={type:"keydown",propagate:!1,inputDisabled:!0,target:a.document,keyCode:!1,global:!1},e={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|"},f={esc:27,escape:27,tab:9,space:32,"return":13,enter:13,backspace:8,scrolllock:145,scroll_lock:145,scroll:145,capslock:20,caps_lock:20,caps:20,numlock:144,num_lock:144,num:144,pause:19,"break":19,insert:45,home:36,"delete":46,end:35,pageup:33,page_up:33,pu:33,pagedown:34,page_down:34,pd:34,left:37,up:38,right:39,down:40,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123};this.keyboardEvent={},this.bind=function(c,g,h){var i,j,k,l;h=angular.extend({},d,h),c=c.toLowerCase(),j=h.target,"string"==typeof h.target&&(j=document.getElementById(h.target)),i=function(d){if(d=d||a.event,h.inputDisabled){var i;if(d.target?i=d.target:d.srcElement&&(i=d.srcElement),3===i.nodeType&&(i=i.parentNode),"INPUT"===i.tagName||"TEXTAREA"===i.tagName)return}d.keyCode?k=d.keyCode:d.which&&(k=d.which);var j=String.fromCharCode(k).toLowerCase();188===k&&(j=","),190===k&&(j=".");for(var m=c.split("+"),n=0,o={shift:{wanted:!1,pressed:d.shiftKey?!0:!1},ctrl:{wanted:!1,pressed:d.ctrlKey?!0:!1},alt:{wanted:!1,pressed:d.altKey?!0:!1},meta:{wanted:!1,pressed:d.metaKey?!0:!1}},p=0,q=m.length;l=m[p],q>p;p++){switch(l){case"ctrl":case"control":n++,o.ctrl.wanted=!0;break;case"shift":case"alt":case"meta":n++,o[l].wanted=!0}l.length>1?f[l]===k&&n++:h.keyCode?h.keyCode===k&&n++:j===l?n++:e[j]&&d.shiftKey&&(j=e[j],j===l&&n++)}return n!==m.length||o.ctrl.pressed!==o.ctrl.wanted||o.shift.pressed!==o.shift.wanted||o.alt.pressed!==o.alt.wanted||o.meta.pressed!==o.meta.wanted||(b(function(){g(d)},1),h.propagate)?void 0:(d.cancelBubble=!0,d.returnValue=!1,d.stopPropagation&&(d.stopPropagation(),d.preventDefault()),!1)},this.keyboardEvent[c]={callback:i,target:j,event:h.type,_callback:g,opt:h,label:c},j.addEventListener?j.addEventListener(h.type,i,!1):j.attachEvent?j.attachEvent("on"+h.type,i):j["on"+h.type]=i},this.push=function(a,b,d){var e=this.keyboardEvent[a.toLowerCase()];e&&(c.push(e),this.unbind(a)),this.bind(a,b,d)},this.pop=function(a){this.unbind(a);var b=_.findLastIndex(c,{label:a.toLowerCase()});-1!==b&&(this.bind(a,c[b]._callback,c[b].opt),c.splice(b,0))},this.unbind=function(a){a=a.toLowerCase();var b=this.keyboardEvent[a];if(delete this.keyboardEvent[a],b){var c=b.event,d=b.target,e=b.callback;d.detachEvent?d.detachEvent("on"+c,e):d.removeEventListener?d.removeEventListener(c,e,!1):d["on"+c]=!1}}}])}(),function(){"use strict";function a(a,b,c){var d={};this.privileges=d,a.privileges=d,this.userHasPrivileges=function(a){for(var b in a)if(a[b]&&!d[b])return!1;return!0},this.setUserPrivileges=function(a){for(var b in a)a[b]?d[b]=1:d[b]=0;return d},this.loaded=c.getPrivileges().then(this.setUserPrivileges)}a.$inject=["$rootScope","$q","preferencesService"],angular.module("superdesk.privileges",["superdesk.preferences"]).service("privileges",a)}(),function(){"use strict";function a(a,b,c){var d=null,e=-1,f=5500,g=["user_disabled","user_inactivated","user_role_changed","user_type_changed","user_privileges_revoked","role_privileges_revoked","desk_membership_revoked","desk","stage","stage_visibility_updated"];if(b.server.ws){var h=function(){d=new WebSocket(b.server.ws),i()},i=function(){d.onmessage=function(b){var c=angular.fromJson(b.data);a.$broadcast(c.event,c.extra),_.contains(g,c.event)&&a.$broadcast("reload",c)},d.onerror=function(a){console.error(a)},d.onopen=function(b){c.cancel(e),a.$broadcast("connected")},d.onclose=function(b){a.$broadcast("disconnected"),c.cancel(e),e=c(function(){console.log("$interval"),d&&h()},f,0,!1)}};h()}}function b(a,b,c,d){var e,f,g=this;g.message=null,a.$on("disconnected",function(a){g.message="Disconnected to Notification Server, attempting to reconnect ...",d.cancel(f),f=d(function(){b.error(c(g.message))},100)}),a.$on("connected",function(a){g.message="Connected to Notification Server!",d.cancel(e),e=d(function(){b.success(c(g.message))},100)})}function c(a,b,c,d,e){var f=this;f.userDesks=[],f.result=null,f.activeDesk=null,d.fetchCurrentUserDesks().then(function(a){f.userDesks=a._items,f.activeDesk=d.active.desk});var g={user_disabled:"User is disabled",user_inactivated:"User is inactivated",user_role_changed:"User role is changed",user_type_changed:"User type is changed",user_privileges_revoked:"User privileges are revoked"},h={role_privileges_revoked:"Role role_privileges_revoked"},i={desk_membership_revoked:"User removed from desk",desk:"Desk is deleted/updated"},j={stage:"Stage is created/updated/deleted",stage_visibility_updated:"Stage visibility change"};b.$on("reload",function(a,b){f.result=f.reloadIdentifier(b),f.reload(f.result)}),this.reload=function(b){b.reload&&(null!=a.location.hash&&null!=a.location.hash.match("/authoring/")?f.broadcast(e(b.message)):a.location.reload(!0))},this.broadcast=function(a){b.$broadcast("savework",a)},this.reloadIdentifier=function(b){var d={reload:!1,message:null};return _.has(g,b.event)&&null!=b.extra.user_id&&-1!==b.extra.user_id.indexOf(c.identity._id)&&(d.message=g[b.event],d.reload=!0),_.has(h,b.event)&&-1!==b.extra.role_id.indexOf(c.identity.role)&&(d.message=h[b.event],d.reload=!0),_.has(i,b.event)&&null!=b.extra.desk_id&&null!=b.extra.user_ids&&null!=_.find(f.userDesks,{_id:b.extra.desk_id})&&-1!==b.extra.user_ids.indexOf(c.identity._id)&&(d.message=i[b.event],d.reload=!0),_.has(j,b.event)&&null!=b.extra.desk_id&&("stage_visibility_updated"===b.event?null!=_.find(f.userDesks,{_id:b.extra.desk_id})||null==a.location.hash.match("/search")&&null==a.location.hash.match("/authoring/")||(d.message=j[b.event],d.reload=!0):"stage"===b.event&&null!=_.find(f.userDesks,{_id:b.extra.desk_id})&&f.activeDesk===b.extra.desk_id&&(d.message=j[b.event],d.reload=!0)),d}}return a.$inject=["$rootScope","config","$interval"],b.$inject=["$rootScope","notify","gettext","$timeout"],c.$inject=["$window","$rootScope","session","desks","gettext"],angular.module("superdesk.notification",["superdesk.desks"]).service("reloadService",c).service("notifyConnectionService",b).run(a)}(),function(){"use strict";var a={endpoint:"search",pageSize:25,page:1,sort:[{_updated:"desc"}]};angular.module("superdesk.itemList",["superdesk.search"]).service("itemListService",["api","$q","search",function(b,c,d){function e(a){var c={source:{query:{filtered:{}}}};if(a.sortField&&a.sortDirection){var e={};e[a.sortField]=a.sortDirection,a.sort=[e]}if(a.repo&&(a.repos=[a.repo]),(a.types||a.notStates||a.states||a.creationDateBefore||a.creationDateAfter||a.modificationDateBefore||a.modificationDateAfter||a.provider||a.source||a.urgency||a.savedSearch)&&(c.source.query.filtered.filter={and:[]}),c.source.size=a.pageSize,c.source.from=(a.page-1)*a.pageSize,c.source.sort=a.sort,a.repos&&(c.repo=a.repos.join(",")),a.types&&c.source.query.filtered.filter.and.push({terms:{type:a.types}}),a.notStates&&_.each(a.notStates,function(a){c.source.query.filtered.filter.and.push({not:{term:{state:a}}})}),a.states){var f=[];_.each(a.states,function(a){f.push({term:{state:a}})}),c.source.query.filtered.filter.and.push({or:f})}var g={creationDate:"_created",modificationDate:"_updated"},h=null;_.each(g,function(b,d){(a[d+"Before"]||a[d+"After"])&&(h={},h[b]={lte:a[d+"Before"]||void 0,gte:a[d+"After"]||void 0},c.source.query.filtered.filter.and.push({range:h}))}),_.each(["provider","source","urgency"],function(b){if(a[b]){var d={};d[b]=a[b],c.source.query.filtered.filter.and.push({term:d})}});var i={headline:"headline",subject:"subject.name",keyword:"slugline",uniqueName:"unique_name",body:"body_html"},j=[];if(_.each(i,function(b,c){a[c]&&j.push(b+":(*"+a[c]+"*)")}),j.length&&(c.source.query.filtered.query={query_string:{query:j.join(" "),lenient:!1,default_operator:"AND"}}),a.related===!0){var k=[],l=[];l=a.keyword.split(" ");var m=l.length;k.push('slugline:("'+a.keyword+'")');for(var n=0;m>n;n++)a.keyword&&k.push("slugline:("+l[n]+")");k.length&&(c.source.query.filtered.query={query_string:{query:k.join(" "),lenient:!1,default_operator:"OR"}})}if(a.search){var o=[];_.each(_.values(i),function(b){o.push(b+":(*"+a.search+"*)")}),c.source.query.filtered.query={query_string:{query:o.join(" "),lenient:!1,default_operator:"OR"}}}return a.savedSearch&&a.savedSearch._links?b.get(a.savedSearch._links.self.href).then(function(a){var b=d.query(a.filter.query).getCriteria();return c.source.query.filtered.filter.and=c.source.query.filtered.filter.and.concat(b.query.filtered.filter.and),c.source.post_filter=b.post_filter,c}):c}this.fetch=function(d){return d=_.extend({},a,d),c.when(e(d)).then(function(a){return b(d.endpoint,d.endpointParam||void 0).query(a)})}}]).provider("ItemList",function(){this.$get=["itemListService",function(b){var c=function(){this.listeners=[],this.options=_.clone(a),this.result={},this.maxPage=0};return c.prototype.setOptions=function(a){return this.options=_.extend(this.options,a),this},c.prototype.addListener=function(a){return this.listeners.push(a),this},c.prototype.removeListener=function(a){return _.remove(this.listeners,function(b){return b===a}),this},c.prototype.fetch=function(){var a=this;return b.fetch(this.options).then(function(b){return a.result=b,a.maxPage=Math.ceil(b._meta.total/a.options.pageSize)||0,_.each(a.listeners,function(a){a(b)}),b})},c}]}).factory("itemPinService",["preferencesService",function(a){var b="pinned:items",c={items:null,listeners:{ingest:[],archive:[]},load:function(){var c=this;return a.get(b).then(function(a){c.items=a}).then(function(){c.updateListeners()})},save:function(){var c=this;this.items=_.uniq(this.items,function(a){return a._id});var d={};return d[b]=this.items,a.update(d,b).then(function(){c.updateListeners()})},get:function(a){return _.filter(this.items,{_type:a})},add:function(a,b){var c=this;b._type=a,this.load().then(function(){return c.items.push(b),c.save()}).then(function(){c.updateListeners()})},remove:function(a){var b=this;this.load().then(function(){return _.remove(b.items,{_id:a._id}),b.save()}).then(function(){b.updateListeners()})},isPinned:function(a,b){return!!_.find(this.items,{_type:a,_id:b._id})},addListener:function(a,b){this.listeners[a].push(b),b(this.get(a))},removeListener:function(a,b){_.remove(this.listeners[a],function(a){return a===b})},updateListeners:function(){var a=this;_.each(this.listeners,function(b,c){_.each(b,function(b){b(a.get(c))})})}};return c.load(),c}]).directive("sdItemListWidget",["ItemList","notify","itemPinService","gettext","$timeout",function(a,b,c,d,e){return{scope:{options:"=",itemListOptions:"=",actions:"="},templateUrl:"scripts/superdesk/itemList/views/item-list-widget.html",link:function(f,g,h){function i(){e.cancel(j),j=e(function(){l.fetch()},100,!1)}f.items=null,f.processedItems=null,f.maxPage=1,f.pinnedItems=[],f.selected=null;var j,k=null,l=new a;f.view=function(a){f.selected=a},f.toggleItemType=function(a){f.itemListOptions.types.indexOf(a)>-1?f.itemListOptions.types=_.without(f.itemListOptions.types,a):f.itemListOptions.types.push(a)},f.isItemTypeEnabled=function(a){return f.itemListOptions.types.indexOf(a)>-1},f.pin=function(a){c.add(f.options.pinMode,_.clone(a))},f.unpin=function(a){c.remove(a)},f.isPinned=function(a){return c.isPinned(f.options.pinMode,a)};var m=function(){f.items&&(f.options.pinEnabled?f.processedItems=f.pinnedItems.concat(f.items._items):f.processedItems=f.items._items)},n=function(){f.maxPage=l.maxPage,f.items=l.result,m()},o=function(a){f.pinnedItems=a,_.each(f.pinnedItems,function(a){a.pinnedInstance=!0}),m()};l.addListener(n),c.addListener(f.options.pinMode,o),f.$on("$destroy",function(){l.removeListener(n),c.removeListener(o)}),f.$watch("itemListOptions",function(){l.setOptions(f.itemListOptions),i()},!0),f.$watch("options.similar",function(){f.options.similar&&f.options.item?f.options.item.slugline?(k=f.itemListOptions.search,f.itemListOptions.search=f.options.item.slugline):(b.error(d("Error: Keywords required.")),f.options.similar=!1):f.itemListOptions.search=k||null})}}}]).directive("sdRelatedItemListWidget",["ItemList","notify","itemPinService","gettext",function(a,b,c,d){return{scope:{options:"=",itemListOptions:"=",actions:"="},templateUrl:"scripts/superdesk/itemList/views/relatedItem-list-widget.html",link:function(e,f,g){e.items=null,e.processedItems=null,e.maxPage=1,e.pinnedItems=[],e.selected=null;var h=null,i=new a,j=function(){i.fetch()},k=_.debounce(j,100);e.view=function(a){e.selected=a},e.toggleItemType=function(a){e.itemListOptions.types.indexOf(a)>-1?e.itemListOptions.types=_.without(e.itemListOptions.types,a):e.itemListOptions.types.push(a)},e.isItemTypeEnabled=function(a){return e.itemListOptions.types.indexOf(a)>-1},e.pin=function(a){c.add(e.options.pinMode,_.clone(a))},e.unpin=function(a){c.remove(a)},e.isPinned=function(a){return c.isPinned(e.options.pinMode,a)};var l=function(){e.items&&(e.options.pinEnabled?e.processedItems=e.pinnedItems.concat(e.items._items):e.processedItems=e.items._items)},m=function(){e.maxPage=i.maxPage,e.items=i.result,l()},n=function(a){e.pinnedItems=a,_.each(e.pinnedItems,function(a){a.pinnedInstance=!0}),l()};i.addListener(m),c.addListener(e.options.pinMode,n),e.$on("$destroy",function(){i.removeListener(m),c.removeListener(n)}),e.$watch("itemListOptions",function(){i.setOptions(e.itemListOptions),i.setOptions({related:e.options.related}),k()},!0),e.$watch("options.related",function(){e.options.related&&e.options.item?e.options.item.slugline?(h=e.itemListOptions.keyword,e.itemListOptions.keyword=e.options.item.slugline):(b.error(d("Error: Keywords required.")),e.options.related=!1):e.itemListOptions.keyword=h||null})}}}])}(),function(){"use strict";function a(){this.flags={menu:!1,notifications:!1}}angular.module("superdesk.menu",["superdesk.menu.notifications","superdesk.asset","superdesk.api"]).service("superdeskFlags",a).directive("sdSuperdeskView",["asset",function(a){function b(a){this.flags=a.flags}return b.$inject=["superdeskFlags"],{templateUrl:a.templateUrl("superdesk/menu/views/superdesk-view.html"),controller:b,controllerAs:"superdesk"}}]).directive("sdMenuWrapper",["$route","superdesk","betaService","userNotifications","asset","lodash",function(a,b,c,d,e,f){return{require:"^sdSuperdeskView",templateUrl:e.templateUrl("superdesk/menu/views/menu.html"),link:function(e,g,h,i){function j(a){return b.getMenu(b.MENU_SETTINGS).then(function(b){return b.length||f.remove(a,{_settings:1}),a})}function k(a){f.each(e.menu,function(b){b.isActive=a&&a.href&&a.href.substr(0,b.href.length)===b.href})}e.currentRoute=null,e.flags=i.flags,e.menu=[],b.getMenu(b.MENU_MAIN).then(j).then(function(b){e.menu=b,k(a.current)}),e.toggleMenu=function(){i.flags.menu=!i.flags.menu},e.toggleNotifications=function(){i.flags.notifications=!i.flags.notifications},e.toggleBeta=function(){c.toggleBeta()},e.$on("$locationChangeStart",function(){i.flags.menu=!1}),e.$watch(function(){return a.current},function(a){e.currentRoute=a||null,k(e.currentRoute),i.flags.workspace=a?!!a.sideTemplateUrl:!1}),e.notifications=d}}}])}(),function(){"use strict";function a(a,b,c,d){function e(){var a={},b="read."+d.identity._id||"all";return a[b]={$exists:!0},"user"===d.identity.user_type&&(a.user={$exists:!0},a.item={$exists:!0}),a}function f(a){var b=a._dest||{};return d.identity&&!b[d.identity._id]}var g=1e3,h=500;this._items=null,this.unread=0,this.reload=function(){if(!d.identity)return this._items=null,void(this.unread=0);var a={where:e(),embedded:{user:1,item:1},max_results:8};return c.query("activity",a).then(angular.bind(this,function(a){this._items=a._items,this.unread=0;var b=d.identity||{};_.each(this._items,function(a){var c=a.read||{};a._unread=!c[b._id],this.unread+=a._unread?1:0},this)}))},this.markAsRead=function(a){var b=angular.extend({},a),e=a.read;return e[d.identity._id]=1,c("activity").save(b,{read:e}).then(angular.bind(this,function(){this.unread=_.max([0,this.unread-1]),a._unread=null}))};var i=angular.bind(this,this.reload);d.getIdentity().then(function(){b(i,g,!1),a.$on("activity",function(a,c){f(c)&&b(i,h,!1)})})}function b(a,b){var c=5e3;return{link:function(d){if(d.notification._unread){var e=b(function(){a.markAsRead(d.notification)},c);d.$on("$destroy",function(){b.cancel(e)})}}}}a.$inject=["$rootScope","$timeout","api","session"],b.$inject=["userNotifications","$timeout"],angular.module("superdesk.menu.notifications",["superdesk.asset"]).service("userNotifications",a).directive("sdMarkAsRead",b).directive("sdNotifications",["asset",function(a){return{require:"^sdSuperdeskView",templateUrl:a.templateUrl("superdesk/menu/notifications/views/notifications.html"),link:function(a,b,c,d){a.flags=d.flags}}}])}(),function(){"use strict";function a(a,b,c,d,e,f){function g(b){return a.save("archive",b)}var h="text";this.createItem=function(a){var b={type:a||h,version:0};return f.addTaskToArticle(b),g(b)},this.createPackageItem=function(a){var b=a?{items:[a],version:0}:{version:0};return e.createEmptyPackage(b)},this.createItemFromTemplate=function(a){var b=_.pick(a,c.TEMPLATE_METADATA);return g(b).then(function(b){return c.addRecentTemplate(d.activeDeskId,a._id),b})}}function b(a,b,c,d,e,f){return{scope:!0,templateUrl:"scripts/superdesk-workspace/content/views/sd-content-create.html",link:function(a){function g(a){e.edit(a)}var h=5;a.create=function(a){d.createItem(a).then(g)},a.createPackage=function(){d.createPackageItem().then(g)},a.createFromTemplate=function(a){d.createItemFromTemplate(a).then(g)},a.openUpload=function(){f.intent("upload","media")},a.contentTemplates=null,a.$watch(function(){return b.activeDeskId},function(){c.getRecentTemplates(b.activeDeskId,h).then(function(b){a.contentTemplates=b})})}}}function c(a,b,c){var d=10;return{templateUrl:"scripts/superdesk-workspace/content/views/sd-template-select.html",scope:{selectAction:"=",open:"="},link:function(a){a.maxPage=1,a.options={keyword:null,page:1},a.templates=null,a.close=function(){a.open=!1},a.select=function(b){a.selectAction(b)};var e=function(){c.fetchTemplates(a.options.page,d,"create",b.activeDeskId,a.options.keyword).then(function(b){a.maxPage=Math.ceil(b._meta.total/d),a.templates=b})};a.$watchCollection("options",e),a.$watch(function(){return b.activeDeskId},e)}}}angular.module("superdesk.workspace.content",["superdesk.api","superdesk.archive","superdesk.templates","superdesk.packaging"]).service("content",a).directive("sdContentCreate",b).directive("sdTemplateSelect",c),a.$inject=["api","superdesk","templates","desks","packages","archiveService"],b.$inject=["api","desks","templates","content","authoringWorkspace","superdesk"],c.$inject=["api","desks","templates"]}(),function(){"use strict";function a(a,b,c,d){this.statuses=[{_id:"todo",name:gettext("To Do")},{_id:"in_progress",name:gettext("In Progress")},{_id:"done",name:gettext("Done")}],this.save=function(a,b){return b.task.due_time&&(b.task.due_date=d.mergeDateTime(b.task.due_date,b.task.due_time).format()),delete b.task.due_time,b.task.user||delete b.task.user,c("tasks").save(a,b).then(function(a){return a})},this.buildFilter=function(c){var d=[],e=this;if(d.push({not:{term:{package_type:"takes"}}}),a.getCurrentDeskId()?d.push({term:{"task.desk":a.getCurrentDeskId()}}):d.push({term:{"task.user":b.currentUser._id}}),c)d.push({term:{"task.status":c}});else{var f=[];_.each(e.statuses,function(a){f.push({term:{"task.status":a._id}})}),d.push({or:f})}var g={and:d};return g},this.fetch=function(a,b){return b||(b=this.buildFilter(a)),c("tasks").query({source:{size:200,sort:[{_updated:"desc"}],filter:b}})}}function b(a,b,c,d,e,f,g,h){function i(){e.fetchDeskStages(e.getCurrentDeskId()).then(function(b){a.stages=b})}function j(){b.cancel(m),m=b(function(){var b={bool:{must:{term:{"task.desk":e.getCurrentDeskId()}},must_not:{terms:{state:["published","spiked"]}}}},d={source:{size:200,sort:[{_updated:"desc"}],filter:b}};c.query("tasks",d).then(function(b){
a.stageItems=_.groupBy(b._items,function(a){return a.task.stage})})},300,!1)}function k(){var b={bool:{must:{term:{"task.desk":e.getCurrentDeskId()}},must_not:{term:{package_type:"takes"}}}};c.query("published",{source:{filter:b}}).then(function(b){a.published=b})}function l(){function b(a){return a.milliseconds(0),a.toISOString().replace(".000Z","+0000")}var d=h().hours(0).minutes(0).seconds(0),f=h().hours(23).minutes(59).seconds(59),g={template_desk:e.getCurrentDeskId(),next_run:{$gte:b(d),$lte:b(f)}};c.query("content_templates",{where:g,sort:"next_run"}).then(function(b){a.scheduled=b})}var m,n="kanban";a.selected={},a.newTask=null,a.tasks=null,a.view=n,a.statuses=f.statuses,a.activeStatus=a.statuses[0]._id,a.$watch(function(){return e.getCurrentDeskId()},function(a){a&&(j(),i(),k(),l())}),a.preview=function(b){a.selected.preview=b},a.create=function(){var b=new Date;a.newTask={task:{desk:e.getCurrentDeskId(),due_date:g("formatDateTimeString")(b),due_time:g("formatDateTimeString")(b,"HH:mm:ss")}}},a.save=function(){f.save({},a.newTask).then(function(b){d.success(gettext("Item saved.")),a.close()})},a.close=function(){a.newTask=null},a.setView=function(b){a.view!==b&&(a.view=b,a.tasks=null,j())},a.selectStatus=function(b){a.activeStatus!==b&&(a.activeStatus=b,a.tasks=null,j())},a.$on("task:new",j),a.$on("task:stage",function(a,b){var c=e.getCurrentDeskId();(c===b.old_desk||c===b.new_desk)&&j()})}function c(a,b,c,d){var e=b.initialize();return{templateUrl:"scripts/superdesk-dashboard/workspace-tasks/views/task-preview.html",scope:{item:"=",close:"&onclose"},link:function(f){var g;f.task=null,f.task_details=null,f.editmode=!1,e.then(function(){f.desks=b.deskLookup,f.users=b.userLookup}),f.$watch("item._id",function(a){a&&f.reset()}),f.save=function(){f.task.task=_.extend(f.task.task,f.task_details),a.save(g,f.task).then(function(a){c.success(gettext("Item saved.")),f.editmode=!1})},f.edit=function(){f.editmode=!0},f.reset=function(){f.editmode=!1,f.task=_.create(f.item),f.task_details=_.extend({},f.item.task),f.task_details.due_date=f.task_details.due_date?d("formatDateTimeString")(f.task_details.due_date):null,f.task_details.due_time=f.task_details.due_time?d("formatDateTimeString")(f.task_details.due_time,"HH:mm:ss"):null,g=f.item}}}}function d(){return{templateUrl:"scripts/superdesk-dashboard/workspace-tasks/views/kanban-board.html",scope:{items:"=",label:"@",cssClass:"@",selected:"="},link:function(a){a.preview=function(b){a.selected&&(a.selected.preview=b)}}}}function e(a){var b=a.initialize();return{templateUrl:"scripts/superdesk-dashboard/workspace-tasks/views/assignee-view.html",scope:{task:"=",name:"=",avatarSize:"@"},link:function(c){b.then(function(){var b=angular.extend({desk:null,user:null},c.task),d=a.deskLookup[b.desk]||{},e=a.userLookup[b.user]||{};c.deskName=d.name||null,c.userName=e.display_name||null,c.userPicture=e.picture_url||null})}}}function f(a,b){var c=b.initialize();return function(a){var d=this;c.then(function(){d.stages=null,d.selected=null,d.select=function(a){var c=a?a._id:null;d.selected=a||null,b.setCurrentStageId(c)},d.reload=function(a){d.stages=a?b.deskStages[a]:null,d.select(_.find(d.stages,{_id:b.activeStageId}))},a.$watch(function(){return b.getCurrentDeskId()},function(){d.reload(b.getCurrentDeskId())})})}}function g(){return{templateUrl:"scripts/superdesk-dashboard/workspace-tasks/views/desk-stages.html"}}a.$inject=["desks","$rootScope","api","datetimeHelper"],b.$inject=["$scope","$timeout","api","notify","desks","tasks","$filter","moment"],c.$inject=["tasks","desks","notify","$filter"],d.$inject=[],e.$inject=["desks"],f.$inject=["api","desks"],angular.module("superdesk.workspace.tasks",[]).factory("StagesCtrl",f).directive("sdTaskPreview",c).directive("sdAssigneeView",e).directive("sdDeskStages",g).directive("sdTaskKanbanBoard",d).controller("TasksController",b).service("tasks",a).config(["superdeskProvider",function(a){a.activity("/workspace/tasks",{label:gettext("Workspace"),controller:b,templateUrl:"scripts/superdesk-dashboard/workspace-tasks/views/workspace-tasks.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",filters:[{action:"view",type:"task"}]}),a.activity("pick.task",{label:gettext("Pick task"),icon:"pick",controller:["data","superdesk",function(a,b){return b.intent("author","article",a.item)}],filters:[{action:a.ACTION_EDIT,type:"task"}]})}])}(),function(){"use strict";function a(a,b,c){var d={};return d.usernamePattern=/^[A-Za-z0-9_.'-]+$/,d.phonePattern=/^(?:(?:0?[1-9][0-9]{8})|(?:(?:\+|00)[1-9][0-9]{9,11}))$/,d.signOffPattern=/^[a-zA-Z0-9]+$/,d.save=function(b,c){return a.save("users",b,c).then(function(a){return angular.extend(b,c),angular.extend(b,a),b})},d.changePassword=function(b,c,d){return a.changePassword.create({username:b.username,old_password:c,new_password:d}).then(function(a){})},d.resetPassword=function(b){return a.resetPassword.create({email:b.email}).then(function(a){})},d.isActive=function(a){return a&&a.is_active},d.isPending=function(a){return a&&a.needs_activation},d.toggleStatus=function(a,b){return this.save(a,{is_active:b})},d.isLoggedIn=function(a){return a&&_.size(a.session_preferences)>0},d}function b(a,b,c){function d(a,b,c){return a+"_"+b+"_"+c}var e={},f=c("userList"),g="_nosearch",h=1,i=20;return e.getAll=function(){function c(b,i){return b=b||h,i=i||[],a("users").query({max_results:200,page:b}).then(function(a){i=i.concat(a._items),a._links.next?(b++,d=d.then(c(b,i))):(f.put(g,i),e.resolve(i))}),e.promise}var d=b.when(),e=b.defer();return d=c(),d.then(function(a){return a})},e.get=function(c,e,j){e=e||h;var k=c||g;j=j||i,k=d(k,e,j);var l=f.get(k);if(l)return b.when(l);var m={max_results:e*j};return c&&(m.where=JSON.stringify({$or:[{display_name:{$regex:c,$options:"-i"}},{username:{$regex:c,$options:"-i"}},{first_name:{$regex:c,$options:"-i"}},{last_name:{$regex:c,$options:"-i"}},{email:{$regex:c,$options:"-i"}}]})),a("users").query(m).then(function(a){return f.put(k,a),a})},e.getUser=function(b){return a("users").getById(b,void 0,!0)},e.clearCache=function(){f.removeAll()},e}function c(a,b,c){function d(a,b){return angular.isUndefined(b)?!1:_.find(a,function(a){return a._links.self.href===b._links.self.href})}function e(){var c=b.search(),d={max_results:Number(c.max_results)||i};return(c.q||a.online_users)&&(d.where=f(c.q,a.online_users)),c.page&&(d.page=parseInt(c.page,10)),c.sort?d.sort=h(c.sort[0],c.sort[1]):d.sort=h("full_name","asc"),d}function f(a,b){var c=null,d=null;return a&&(c={$or:[{username:{$regex:a,$options:"-i"}},{display_name:{$regex:a,$options:"-i"}},{email:{$regex:a,$options:"-i"}}]}),b&&(d={session_preferences:{$exists:!0,$nin:[null,{}]}}),a&&b?JSON.stringify({$and:[c,d]}):a?JSON.stringify(c):b?JSON.stringify(d):null}function g(b){c.users.query(b).then(function(b){a.users=b,a.createdUsers=[]})}function h(a,b){var c="asc"===b?1:-1;switch(a){case"full_name":return'[("first_name", '+c+'), ("last_name", '+c+")]";default:return'[("'+encodeURIComponent(a)+'", '+c+")]"}}var i=25;a.selected={user:null},a.createdUsers=[],a.online_users=!1,c("roles").query().then(function(b){a.roles=_.indexBy(b._items,"_id"),a.noRolesWarning=0===b._items.length}),a.preview=function(b){a.selected.user=b},a.createUser=function(){a.intent("create","user").then(g)},a.$on("intent:create:user",function(){a.preview({})}),a.closePreview=function(){a.preview(null)},a.afterDelete=function(b){a.selected.user&&b.item&&b.item.href===a.selected.user.href&&(a.selected.user=null),g(e())},a.render=function(b){d(a.users._items,b)||d(a.createdUsers,b)||a.createdUsers.unshift(b)},a.$watchCollection(e,g)}function d(a,b,c,d,e){a.user=d,a.profile=a.user._id===e.identity._id}function e(a,b,c,d,e){a.methods=[{id:"upload",label:gettext("Upload from computer")},{id:"camera",label:gettext("Take a picture")},{id:"web",label:gettext("Use a Web URL")}],e.isBeta().then(function(b){b||(a.methods=_.reject(a.methods,{beta:!0}))}),a.activate=function(b){a.active=b,a.preview={},a.progress={width:0}},a.activate(a.methods[0]),a.upload=function(c){var e={};if(e.CropLeft=Math.round(Math.min(c.cords.x,c.cords.x2)),e.CropRight=Math.round(Math.max(c.cords.x,c.cords.x2)),e.CropTop=Math.round(Math.min(c.cords.y,c.cords.y2)),e.CropBottom=Math.round(Math.max(c.cords.y,c.cords.y2)),c.img)e.media=c.img;else{if(!c.url)return;e.URL=c.url}return d.resource("upload").then(function(c){return b.start({url:c,method:"POST",data:e}).then(function(b){if("ERR"!==b.data._status){var c=b.data.renditions.viewImage.href;return a.locals.data.picture_url=c,a.locals.data.avatar=b.data._id,a.resolve(c)}},null,function(b){a.progress.width=Math.round(b.loaded/b.total*100)})})}}function f(a,b,c,d,e,f,g){var h=b.item;return f.save(h,{is_enabled:!0,is_active:!0}).then(function(a){g.$broadcast("user:updated",a)},function(a){angular.isDefined(a.data._issues)&&angular.isDefined(a.data._issues["validator exception"])?d.error(e("Error: "+a.data._issues["validator exception"])):angular.isDefined(a.data._message)?d.error(e("Error: "+a.data._message)):d.error(e("Error. User Profile cannot be enabled."))})}function g(a,b,c,d,e,f){var g=b.item;return a.users.remove(g).then(function(b){return a.users.getById(g._id).then(function(a){return g=angular.extend(g,a),f.$broadcast("user:updated",g),g})},function(a){angular.isDefined(a.data._issues)&&angular.isDefined(a.data._issues["validator exception"])?d.error(e("Error: "+a.data._issues["validator exception"])):angular.isDefined(a.data._message)?d.error(e("Error: "+a.data._message)):d.error(e("Error. User Profile cannot be disabled."))})}function h(a,b,c,d,e){return a.users.getById(b.current.params._id).then(null,function(a){return 404===a.status&&(e.path("/users/"),c.error(d("User was not found, sorry."),5e3)),a})}function i(a,b,c,d){return{scope:!0,templateUrl:"scripts/superdesk-users/views/settings-roles.html",link:function(e){function f(b){var c=_.find(e.roles,function(a){return a._id!==b._id&&a.is_default});c&&a("roles").getById(c._id).then(function(a){_.extend(c,{_etag:a._etag,is_default:!1})})}function g(){return d.confirm(b("Are you sure you want to delete user role?"))}var h=null;e.editRole=null,a("roles").query().then(function(a){e.roles=a._items}),e.edit=function(a){e.editRole=_.create(a),h=a,e.defaultRole=a.is_default},e.save=function(d){var g=d._id?!1:!0;a("roles").save(h,d).then(function(){g?(e.roles.push(h),c.success(b("User role created."))):c.success(b("User role updated.")),d.is_default&&f(d),e.cancel()},function(a){400===a.status&&"undefined"!=typeof a.data._issues.name&&1===a.data._issues.name.unique?c.error(b("I'm sorry but a role with that name already exists.")):"undefined"!=typeof a.data._issues["validator exception"]?c.error(a.data._issues["validator exception"]):c.error(b("I'm sorry but there was an error when saving the role."))})},e.cancel=function(){e.editRole=null},e.remove=function(d){g().then(function(){a("roles").remove(d).then(function(a){_.remove(e.roles,d)},function(a){angular.isDefined(a.data._message)?c.error(b("Error: "+a.data._message)):c.error(b("There is an error. Role cannot be deleted."))})})}}}}function j(a,b,c,d){return{scope:!0,templateUrl:"scripts/superdesk-users/views/settings-privileges.html",link:function(e){a("roles").query().then(function(a){e.roles=a._items}),a("privileges").query().then(function(a){e.privileges=a._items}),e.saveAll=function(f){var g=[];_.each(e.roles,function(b){g.push(a.save("roles",b,_.pick(b,"privileges")).then(function(a){},function(a){console.log(a)}))}),d.all(g).then(function(){c.success(b("Privileges updated.")),f.$setPristine()},function(){c.success(b("Error. Privileges not updated."))})}}}}function k(a){}return a.$inject=["api","$q","notify"],b.$inject=["api","$q","$cacheFactory"],c.$inject=["$scope","$location","api"],d.$inject=["$scope","server","superdesk","user","session"],e.$inject=["$scope","upload","session","urls","betaService"],f.$inject=["api","data","$q","notify","gettext","usersService","$rootScope"],g.$inject=["api","data","$q","notify","gettext","$rootScope"],h.$inject=["api","$route","notify","gettext","$location"],i.$inject=["api","gettext","notify","modal"],j.$inject=["api","gettext","notify","$q"],k.$inject=["$scope"],angular.module("superdesk.users",["superdesk.activity","superdesk.asset"]).controller("UserEditController",d).service("usersService",a).factory("userList",b).factory("userPopup",["$compile","$timeout","userList",function(a,b,c){function d(){var a=i.get();a&&a.hide()}function e(){var a=i.get();a&&a.html("")}function f(){b.cancel(i.status)}function g(){i.status=b(d,j,!1)}function h(b,c){var d=i.get();d.html('<div class="avatar-holder"><figure class="avatar big"><img sd-user-avatar data-src="user.picture_url"></figure></div><div class="title">{{user.display_name}}</div><div class="actions"><a href="#/users/{{user._id}}">go to profile</a></div>');var e=c.$new(!0);e.user=b,a(d)(e)}var i={},j=300;return i.get=function(a){return!i.element&&a&&(i.element=$('<div class="user-popup"></div>'),i.element.appendTo("BODY"),i.element.hover(f,g),i.element.click(d)),i.element},i.set=function(a,b,d){f(),e();var g=i.get(!0),j=b.offset();g.css({left:j.left+b.outerWidth(),top:j.top+b.outerHeight()}),c.getUser(a).then(function(a){h(a,d)},function(a){console.log(a)}),g.show()},i.close=function(){var a=i.get();a&&g()},i}]).config(["superdeskProvider",function(a){a.permission("users-manage",{label:gettext("Manage users"),permissions:{users:{write:!0}}}).permission("users-read",{label:gettext("Read users"),permissions:{users:{read:!0}}}).permission("user-roles-manage",{label:gettext("Manage user roles"),permissions:{user_roles:{write:!0}}}).permission("user-roles-read",{label:gettext("Read user roles"),permissions:{user_roles:{read:!0}}})}]).config(["superdeskProvider","assetProvider",function(a,b){a.activity("/users/",{label:gettext("User management"),description:gettext("Find your colleagues"),controller:c,templateUrl:b.templateUrl("superdesk-users/views/list.html"),category:a.MENU_MAIN,adminTools:!0,reloadOnSearch:!1,filters:[{action:a.ACTION_PREVIEW,type:"user"},{action:"list",type:"user"}],privileges:{users:1}}).activity("/users/:_id",{label:gettext("Users profile"),priority:100,controller:"UserEditController",templateUrl:b.templateUrl("superdesk-users/views/edit.html"),resolve:{user:h},filters:[{action:"detail",type:"user"}],privileges:{users:1}}).activity("/settings/user-roles",{label:gettext("User Roles"),templateUrl:b.templateUrl("superdesk-users/views/settings.html"),controller:k,category:a.MENU_SETTINGS,priority:-500,privileges:{roles:1}}).activity("delete/user",{label:gettext("Disable user"),icon:"trash",confirm:gettext("Please confirm that you want to disable a user."),controller:g,filters:[{action:a.ACTION_EDIT,type:"user"}],condition:function(a){return a.is_enabled},privileges:{users:1}}).activity("restore/user",{label:gettext("Enable user"),icon:"revert",controller:f,filters:[{action:a.ACTION_EDIT,type:"user"}],condition:function(a){return!a.is_enabled},privileges:{users:1}}).activity("edit.avatar",{label:gettext("Change avatar"),modal:!0,cssClass:"upload-avatar modal-static modal-large",controller:e,templateUrl:b.templateUrl("superdesk-users/views/change-avatar.html"),filters:[{action:"edit",type:"avatar"}]})}]).config(["apiProvider",function(a){a.api("users",{type:"http",backend:{rel:"users"}}),a.api("roles",{type:"http",backend:{rel:"roles"}}),a.api("resetPassword",{type:"http",backend:{rel:"reset_user_password"}}),a.api("changePassword",{type:"http",backend:{rel:"change_user_password"}})}]).config(["$compileProvider",function(a){a.directive("compile",["$compile",function(a){return function(b,c,d){var e=b.$eval(d.compile);c.html(e);var f=b.$new(!0);_.each(b.$eval(d.data),function(a,b){f[b]=a}),a(c.contents())(f)}}])}]).directive("sdUserRoles",i).directive("sdRolesPrivileges",j).directive("sdInfoItem",function(){return{link:function(a,b){b.addClass("item"),b.find("input, select").addClass("info-value info-editable")}}}).directive("sdValidError",function(){return{link:function(a,b){b.addClass("validation-error")}}}).directive("sdValidInfo",function(){return{link:function(a,b){b.addClass("validation-info")}}}).directive("sdUserDetailsPane",["$timeout",function(a){return{replace:!0,transclude:!0,template:'<div class="user-details-pane" ng-transclude></div>',link:function(b,c,d){a(function(){$(".user-details-pane").addClass("open")},0,!1),b.closePane=function(){$(".user-details-pane").removeClass("open")}}}}]).directive("sdUserEdit",["api","gettext","notify","usersService","userList","session","$location","$route","superdesk","features","asset","privileges","desks","keyboardManager",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){return{templateUrl:k.templateUrl("superdesk-users/views/edit-form.html"),scope:{origUser:"=user",onsave:"&",oncancel:"&",onupdate:"&"},link:function(k,o){function p(a){k.error=null,k.user=_.create(a),k.confirm={password:null},k.show={password:!1},k._active=d.isActive(a),k._pending=d.isPending(a),k.profile=k.user._id===f.identity._id,k.userDesks=[],angular.isDefined(a)&&angular.isDefined(a._links)&&m.fetchUserDesks(a).then(function(a){k.userDesks=a._items})}k.privileges=l.privileges,k.features=j,k.usernamePattern=d.usernamePattern,k.phonePattern=d.phonePattern,k.signOffPattern=d.signOffPattern,k.dirty=!1,k.errorMessage=null,k.$watch("origUser",p),k.$watchCollection("user",function(a){_.each(a,function(b,c){""===b&&("phone"!==c||"byline"!==c?a[c]=null:delete a[c])}),k.dirty=!angular.equals(a,k.origUser)}),a("roles").query().then(function(a){k.roles=a._items}),k.cancel=function(){p(k.origUser),k.origUser.Id||k.oncancel()},k.focused=function(){n.unbind("down"),n.unbind("up")},k.editPicture=function(){i.intent("edit","avatar",k.user).then(function(a){k.user.picture_url=a})},k.save=function(){return k.error=null,c.info(b("saving..")),d.save(k.origUser,k.user).then(function(a){k.origUser=a,p(k.origUser),c.pop(),c.success(b("user saved.")),k.onsave({user:k.origUser}),k.user._id===f.identity._id&&f.updateIdentity(k.origUser),e.clearCache()},function(a){if(c.pop(),404===a.status)"/users/"===g.path()?h.reload():g.path("/users/"),c.error(b("User is not found. It might be deleted."));else{var d=b("There was an error when saving user. ");if(a.data&&a.data._issues){angular.isDefined(a.data._issues["validator exception"])&&(d=b("Error: "+a.data._issues["validator exception"])),k.error=a.data._issues,k.error.message=d;for(var e in a.data._issues)if(k.userForm[e]){k.error[e]&&(k.error[e].format=!0,k.error.message=null);for(var f in a.data._issues[e])a.data._issues[e][f]&&(k.userForm[e].$setValidity(f,!1),k.error.message=null)}}c.error(d)}})},k.toggleStatus=function(a){d.toggleStatus(k.origUser,a).then(function(){p(k.origUser),k.onupdate({user:k.origUser})})},k.$on("user:updated",function(a,b){p(b)})}}}]).directive("sdUserPreferences",["api","session","preferencesService","notify","asset","metadata","modal","$timeout","$q",function(a,b,c,d,e,f,g,h,i){return{templateUrl:e.templateUrl("superdesk-users/views/user-preferences.html"),link:function(a,e,j){function k(b){var c,d;a.preferences={},_.each(b,function(b,c){b.label&&b.category&&(a.preferences[c]=_.create(b))}),c=["cities","categories","default_categories"],d=c.some(function(a){var b=f.values||{};return angular.isUndefined(b[a])}),d?f.initialize().then(function(){l(f.values,b)}):l(f.values,b)}function l(b,c){a.cities=b.cities,a.defaultCategories={},b.default_categories.forEach(function(b){a.defaultCategories[b.qcode]=!0}),a.categories=[],b.categories.forEach(function(b){var d=_.create(b),e=c["categories:preferred"].selected;d.selected=!!e[b.qcode],a.categories.push(d)})}function m(){var b,c,d;return(d=a.categories.some(function(a){return a.selected}))?i.when():(c=["No preferred categories selected. Should you ","choose to proceed with your choice, a default ","set of categories will be selected for you."].join(""),c=gettext(c),b=g.confirm(c).then(function(){a.checkDefault()}))}function n(){var b={};return _.each(o,function(c,d){if("dateline:located"===d){var f=e.find(".input-term > input");a.changeDatelinePreview(a.preferences[d],f[0].value)}"categories:preferred"===d&&(c.selected={},a.categories.forEach(function(a){c.selected[a.qcode]=!!a.selected})),b[d]=_.extend(c,a.preferences[d])}),b}var o;c.get().then(function(c){o=c,k(o),a.datelineSource=b.identity.dateline_source,a.datelinePreview=a.preferences["dateline:located"].located}),a.cancel=function(){a.userPrefs.$setPristine(),k(o),a.datelinePreview=a.preferences["dateline:located"].located},a.save=function(){m().then(function(){var a=n();return c.update(a)},function(){return i.reject("canceledByModal")}).then(function(){d.success(gettext("User preferences saved")),a.cancel()},function(a){"canceledByModal"!==a&&d.error(gettext("User preferences could not be saved..."))})},a.changeDatelinePreview=function(b,c){""===c&&(b.located=null),h(function(){a.datelinePreview=b.located})},a.checkAll=function(){a.categories.forEach(function(a){a.selected=!0}),a.userPrefs.$setDirty()},a.checkNone=function(){a.categories.forEach(function(a){a.selected=!1}),a.userPrefs.$setDirty()},a.checkDefault=function(){a.categories.forEach(function(b){b.selected=!!a.defaultCategories[b.qcode]}),a.userPrefs.$setDirty()}}}}]).directive("sdUserPrivileges",["api","gettext","notify",function(a,b,c){return{scope:{user:"="},templateUrl:"scripts/superdesk-users/views/user-privileges.html",link:function(d){a("privileges").query().then(function(a){d.privileges=a._items}),a("roles").getById(d.user.role).then(function(a){d.role=a},function(a){console.log(a)}),d.save=function(e){a.save("users",d.user,_.pick(d.user,"privileges")).then(function(a){c.success(b("Privileges updated."))},function(a){c.error(b("Privileges not updated.")),console.log(a)}),e.$setPristine()}}}}]).directive("sdChangePassword",["usersService","notify","gettext",function(a,b,c){return{link:function(d,e){d.$watch("user",function(){d.oldPasswordInvalid=!1}),d.changePassword=function(e,f){return a.changePassword(d.user,e,f).then(function(a){d.oldPasswordInvalid=!1,b.success(c("The password has been changed."),3e3),d.show.change_password=!1},function(a){d.oldPasswordInvalid=!0})}}}}]).directive("sdResetPassword",["usersService","notify","gettext",function(a,b,c){return{link:function(d,e){d.$watch("user",function(){d.oldPasswordInvalid=!1}),d.resetPassword=function(){return a.resetPassword(d.user).then(function(a){d.oldPasswordInvalid=!1,b.success(c("The password has been reset."),3e3),d.show.reset_password=!1},function(a){d.oldPasswordInvalid=!0})}}}}]).directive("sdUserUnique",["$q","api",function(a,b){return{require:"ngModel",scope:{exclude:"="},link:function(c,d,e,f){function g(d,f){var g=d||f;if(g&&e.uniqueField){var h={where:{}};return h.where[e.uniqueField]=g,b.users.query(h).then(function(b){return!b._items.length||c.exclude._id&&b._items[0]._id===c.exclude._id?b:a.reject(b)})}return a.when()}f.$asyncValidators.unique=g}}}]).directive("sdPasswordConfirm",[function(){var a="confirm";return{require:"ngModel",scope:{password:"="},link:function(b,c,d,e){function f(a,b){return!a||a===b}e.$validators[a]=function(a,c){var d=a||c;return f(b.password,d)},b.$watch("password",function(b){e.$setValidity(a,f(b,e.$viewValue))})}}}]).directive("sdUserList",["keyboardManager","usersService","asset",function(a,b,c){return{templateUrl:c.templateUrl("superdesk-users/views/user-list-item.html"),scope:{roles:"=",users:"=",selected:"=",done:"="},link:function(c,d,e){function f(){g(),a.bind("down",h),a.bind("up",i)}function g(){a.unbind("down"),a.unbind("up")}function h(){var a=j();-1!==a&&c.select(c.users[_.min([c.users.length-1,a+1])])}function i(){var a=j();-1!==a&&c.select(c.users[_.max([0,a-1])])}function j(){return _.findIndex(c.users,c.selected)}c.active=function(a){return b.isActive(a)},c.pending=function(a){return b.isPending(a)},c.select=function(a){c.selected=a,f()},c.$watch("selected",function(a){null==a&&f()}),c.isLoggedIn=function(a){return b.isLoggedIn(a)}}}}]).directive("sdUserListItem",["asset",function(a){return{templateUrl:a.templateUrl("superdesk-users/views/user-list-item.html")}}]).directive("sdActivity",["asset",function(a){return{templateUrl:a.templateUrl("superdesk-users/views/activity-list.html")}}]).directive("sdUserMentio",["userList","asset",function(a,b){return{templateUrl:b.templateUrl("superdesk-users/views/mentions.html"),link:function(b,c){b.users=[],b.fetching=!1,b.prefix="";var d=c.children()[0];c.children().bind("scroll",function(){d.scrollTop+d.offsetHeight>=d.scrollHeight-3&&(d.scrollTop=d.scrollTop-3,b.fetchNext())}),b.fetchNext=function(){if(!b.fetching){var c=b.users.length/10+1;b.fetching=!0,a.get(b.prefix,c,10).then(function(a){_.each(_.sortBy(a._items.slice(10*(c-1),10*c),"username"),function(a){b.users.push(a)}),b.fetching=!1})}},b.searchUsers=function(c){return b.prefix=c,a.get(c,1,10).then(function(a){b.users=_.sortBy(a._items,"username")})},b.selectUser=function(a){return"@"+a.username},b.$watchCollection(function(){return $(".users-list-embed>li.active")},function(a){a.hasClass("active")&&$(".mentio-menu").scrollTop(a.position().top)})}}}]).directive("sdUserInfo",["userPopup",function(a){return{link:function(b,c,d){c.addClass("user-link"),c.hover(function(){a.set(d.user,c,b)},function(){a.close()})}}}]).filter("username",["session",function(a){return function(a){return a?a.display_name||a.username:null}}])}(),function(){"use strict";function a(a){var b="activity";this.getUserActivity=function(c,d,e){var f={where:{user:c._id},sort:"[('_created',-1)]",embedded:{user:1,item:1}};return d&&(f.max_results=d),e>1&&(f.page=e),a.query(b,f)},this.getAllUsersActivity=function(c,d){var e={sort:"[('_created',-1)]",where:{user:{$exists:!0},item:{$exists:!0}},embedded:{user:1,item:1}};return c&&(e.max_results=c),d>1&&(e.page=d),a.query(b,e)}}a.$inject=["api"],angular.module("superdesk.users.profile",["superdesk.api","superdesk.users"]).service("profileService",a).config(["superdeskProvider","assetProvider",function(a,b){a.activity("/profile/",{label:gettext("My Profile"),controller:"UserEditController",templateUrl:b.templateUrl("superdesk-users/views/edit.html"),resolve:{user:["session","api",function(a,b){return a.getIdentity().then(function(a){return b.get(a._links.self.href)})}]}})}]).directive("sdUserActivity",["profileService","asset",function(a,b){return{restrict:"A",replace:!0,templateUrl:b.templateUrl("superdesk-users/views/activity-feed.html"),scope:{user:"="},link:function(b,c,d){var e=1,f=5;b.max_results=f,b.$watch("user",function(){a.getUserActivity(b.user,f).then(function(a){b.activityFeed=a})}),b.loadMore=function(){e++,a.getUserActivity(b.user,f,e).then(function(a){Array.prototype.push.apply(b.activityFeed._items,a._items),b.activityFeed._links=a._links,b.max_results+=f})}}}}])}(),function(){"use strict";angular.module("superdesk.users.activity",["superdesk.users","superdesk.dashboard.widgets","superdesk.asset"]).config(["widgetsProvider","assetProvider",function(a,b){a.widget("activity",{label:"Activity Stream",multiple:!0,max_sizex:2,max_sizey:2,sizex:1,sizey:2,thumbnail:b.imageUrl("superdesk-users/activity/thumbnail.svg"),template:b.templateUrl("superdesk-users/activity/widget-activity.html"),configurationTemplate:b.templateUrl("superdesk-users/activity/configuration.html"),configuration:{maxItems:5},description:"Activity stream widget",icon:"stream"})}]).controller("ActivityController",["$scope","profileService",function(a,b){function c(c){e=c,b.getAllUsersActivity(c.maxItems).then(function(b){a.activityFeed=b,a.max_results=parseInt(c.maxItems,10)}),a.loadMore=function(){d++,b.getAllUsersActivity(c.maxItems,d).then(function(b){Array.prototype.push.apply(a.activityFeed._items,b._items),a.activityFeed._links=b._links,a.max_results+=parseInt(c.maxItems,10)})}}var d=1,e=null;a.max_results=0,a.$on("changes in activity",function(){e&&c(e)}),a.$watch("widget.configuration",function(a){d=1,a&&c(a)},!0)}]).controller("ActivityConfigController",["$scope",function(a){a.notIn=function(a){return function(b){return-1===a.indexOf(b)}}}])}(),function(){"use strict";function a(a,b){function c(a,c){var d={};return d[a]=1,d.message=c,b.reject(d)}this.importUser=function(b){return a.save("import_profile",b).then(null,function(a){var b=a.data;return 404===a.status?c("profile_to_import",b._message):400===a.status?c(b._issues.profile_to_import?"profile_to_import":"credentials",b._message):c("credentials",b._message)})}}function b(a,b){a.model={},a.error=null,a.importUser=function(c){a.error=null,b.importUser(c).then(function(b){a.resolve(b)},function(b){a.error=b})}}a.$inject=["api","$q"],b.$inject=["$scope","userImport"],angular.module("superdesk.users.import",["superdesk.activity","superdesk.api"]).service("userImport",a).config(["superdeskProvider",function(a){a.activity("import.user",{label:gettext("Import user"),modal:!0,controller:b,templateUrl:"scripts/superdesk-users/import/views/import-user.html",filters:[{action:"create",type:"user"}],features:{import_profile:1}})}])}(),function(){"use strict";function a(a,b){b.initialize().then(function(){a.groups=b.groups})}function b(a,b,c,d,e,f,g){a.modalActive=!1,a.step={current:null},a.group={edit:null},a.openGroup=function(b,c){a.modalActive=!0,a.step.current=b,a.group.edit=c},a.cancel=function(){a.modalActive=!1,a.step.current=null,a.group.edit=null},a.remove=function(e){g.confirm(b("Are you sure you want to delete group?")).then(function(){d.groups.remove(e).then(function(){_.remove(a.groups._items,e),c.success(b("Group deleted."),3e3)})})}}function c(a,b,c){return{link:function(d,e,f){function g(a){a.data&&a.data._issues&&a.data._issues.name&&a.data._issues.name.unique?d._errorUniqueness=!0:d._error=!0,d.message=null}function h(){(d._errorUniqueness||d._error||d._errorLimits)&&(d._errorUniqueness=null,d._error=null,d._errorLimits=null)}var i={group:40};d.limits=i,d.$watch("step.current",function(a){"general"===a&&(d.edit(d.group.edit),d.message=null)}),d.edit=function(a){d.group.edit=_.create(a)},d.save=function(e){d.message=a("Saving...");var f=e._id?!1:!0;b.groups.save(d.group.edit,e).then(function(){if(f)d.edit(d.group.edit),d.groups._items.unshift(d.group.edit);else{var a=_.find(d.groups._items,{_id:d.group.edit._id});_.extend(a,d.group.edit)}c.wizard("usergroups").next()},g)},d.handleEdit=function(a){h(),null!=d.group.edit.name&&(d._errorLimits=d.group.edit.name.length>d.limits.group?!0:null)}}}}function d(a,b,c,d){return{link:function(e,f,g){e.$watch("step.current",function(a,b){"people"===a&&(e.search=null,e.groupMembers=[],e.users=[],e.message=null,e.group.edit&&e.group.edit._id?d.initialize().then(function(){e.groupMembers=d.groupMembers[e.group.edit._id]||[],e.users=d.users._items}):c.wizard("usergroups").goTo(b))}),e.add=function(a){e.groupMembers.push(a)},e.remove=function(a){_.remove(e.groupMembers,a)},e.previous=function(){c.wizard("usergroups").previous()},e.save=function(){var f=_.map(e.groupMembers,function(a){return{user:a._id}});b.groups.save(e.group.edit,{members:f}).then(function(a){_.extend(e.group.edit,a),d.groupMembers[e.group.edit._id]=e.groupMembers;var b=_.find(d.groups._items,{_id:e.group.edit._id});_.extend(b,e.group.edit),c.wizard("usergroups").finish()},function(b){e.message=a("There was a problem, members not saved.")})}}}}var e=angular.module("superdesk.groups",["superdesk.users"]);return e.config(["superdeskProvider",function(b){b.activity("/settings/groups",{label:gettext("Groups"),controller:a,templateUrl:"scripts/superdesk-groups/views/settings.html",category:b.MENU_SETTINGS,priority:-800,beta:!0,privileges:{groups:1}})}]).config(["apiProvider",function(a){a.api("groups",{type:"http",backend:{rel:"groups"}})}]).factory("groups",["$q","api","storage","userList",function(a,b,c,d){var e={groups:null,users:null,groupLookup:{},userLookup:{},groupMembers:{},loading:null,fetchGroups:function(){var a=this;return b.groups.query({
max_results:500}).then(function(b){a.groups=b,_.each(b._items,function(b){a.groupLookup[b._id]=b})})},fetchUsers:function(){var a=this;return d.get(null,1,500).then(function(b){a.users=b,_.each(b._items,function(b){a.userLookup[b._id]=b})})},generateGroupMembers:function(){var b=this;return _.each(this.groups._items,function(a){b.groupMembers[a._id]=[],_.each(a.members,function(c,d){var e=_.find(b.users._items,{_id:c.user});e&&b.groupMembers[a._id].push(e)})}),a.when()},fetchUserGroups:function(a){return b.users.getByUrl(a._links.self.href+"/groups")},getCurrentGroupId:function(){return c.getItem("groups:currentGroupId")||null},setCurrentGroupId:function(a){c.setItem("groups:currentGroupId",a)},fetchCurrentGroup:function(){return b.groups.getById(this.getCurrentGroupId())},setCurrentGroup:function(a){this.setCurrentGroupId(a?a._id:null)},getCurrentGroup:function(a){return this.groupLookup[this.getCurrentGroupId()]},initialize:function(){return this.loading||(this.loading=this.fetchGroups().then(angular.bind(this,this.fetchUsers)).then(angular.bind(this,this.generateGroupMembers))),this.loading}};return e}]).directive("sdGroupeditBasic",c).directive("sdGroupeditPeople",d).directive("sdGroupsConfig",function(){return{controller:b}}).directive("sdGroupsConfigModal",function(){return{require:"^sdGroupsConfig",templateUrl:"scripts/superdesk-groups/views/groups-config-modal.html",link:function(a,b,c,d){}}}),a.$inject=["$scope","groups"],b.$inject=["$scope","gettext","notify","api","groups","WizardHandler","modal"],c.$inject=["gettext","api","WizardHandler"],d.$inject=["gettext","api","WizardHandler","groups"],e}(),function(){"use strict";function a(a,b){var c=b.privileges;a.showSubscribers=Boolean(c.subscribers),a.showFilterConditions=Boolean(c.publish_filters)}function b(a,b){var c=function(b,c){return a[b].query(c)},d={fetchSubscribers:function(a){return a=a||{},c("subscribers",a)},fetchSubscribersByKeyword:function(a){return this.fetchSubscribers({where:JSON.stringify({$or:[{name:{$regex:a,$options:"-i"}}]})})},fetchSubscribersByIds:function(a){var b=[];return _.each(a,function(a){b.push({_id:a})}),this.fetchSubscribers({where:JSON.stringify({$or:b})})},fetchPublishErrors:function(){var a={io_type:"publish"};return c("io_errors",a)}};return d}function c(a){return{templateUrl:"scripts/superdesk-publish/views/destination.html",scope:{destination:"=",actions:"="},link:function(b){b.types=a}}}function d(a,b){function c(){var a=a||{};return a.max_results=200,b.consistency.query(a)}a.consistency_records=null,a.reload=function(){c().then(function(b){a.consistency_records=b._items,a.lastRefreshedAt=new Date})},a.reload()}function e(a,b,c,d,e,f){function g(){var b=b||{};return b.max_results=200,null!==a.selectedFilterSubscriber&&(b.where={subscriber_id:a.selectedFilterSubscriber._id}),c.publish_queue.query(b)}function h(b){var c=_.find(a.publish_queue,{_id:b.queue_id});if(c){var d=["error_message","completed_at","state"];angular.extend(c,_.pick(b,d)),a.$apply()}}function i(){var b=_.find(a.publish_queue,{_id:f.search()._id})||null;b?c.archive.getById(b.item_id).then(function(b){a.selected.preview=b}):a.selected.preview=null}a.subscribers=null,a.subscriberLookup={},a.publish_queue=[],a.selectedFilterSubscriber=null,a.multiSelectCount=0,a.selectedQueueItems=[],a.showResendBtn=!1,a.showCancelBtn=!1,a.selected={};var j=[];j.push(b.fetchSubscribers().then(function(b){a.subscribers=b._items,_.each(b._items,function(b){a.subscriberLookup[b._id]=b})})),a.reload=function(){d.all(j).then(function(){g().then(function(b){var c=b._items;_.forEach(c,function(a){angular.extend(a,{selected:!1})}),a.publish_queue=c,a.lastRefreshedAt=new Date,a.showResendBtn=!1,a.showCacnelBtn=!1,i()})})},a.buildNewSchedule=function(a){var b=["item_id","item_version","publishing_action","formatted_item","headline","content_type","subscriber_id","unique_name","destination"],c=_.pick(a,b);return c},a.scheduleToSend=function(b){var d=[];angular.isDefined(b)?d.push(a.buildNewSchedule(b)):a.multiSelectCount>0&&_.forEach(a.selectedQueueItems,function(b){d.push(a.buildNewSchedule(b))}),c.publish_queue.save([],d).then(function(b){a.reload(),a.cancelSelection(!1)},function(a){angular.isDefined(a.data._issues)?angular.isDefined(a.data._issues["validator exception"])&&e.error(gettext("Error: "+a.data._issues["validator exception"])):e.error(gettext("Error: Failed to re-schedule"))})},a.filterSchedule=function(b,c){"subscriber"===c&&(a.selectedFilterSubscriber=b),a.multiSelectCount=0,g().then(function(b){var c=b._items;_.forEach(c,function(a){angular.extend(a,{selected:!1})}),a.publish_queue=c,a.lastRefreshedAt=new Date,a.showResendBtn=!1,a.showCancelBtn=!1,a.selectedQueueItems=[]})},a.selectQueuedItem=function(b){b.selected?a.selectedQueueItems=_.union(a.selectedQueueItems,[b]):a.selectedQueueItems=_.without(a.selectedQueueItems,b);var c=_.findIndex(a.selectedQueueItems,function(a){return"pending"===a.state||"in-progress"===a.state||"canceled"===a.state});-1===c?(a.showResendBtn=!0,a.showCancelBtn=!1):(c=_.findIndex(a.selectedQueueItems,function(a){return"success"===a.state||"in-progress"===a.state||"canceled"===a.state||"error"===a.state}),-1===c?(a.showResendBtn=!1,a.showCancelBtn=!0):(a.showResendBtn=!1,a.showCancelBtn=!1)),a.multiSelectCount=a.selectedQueueItems.length},a.cancelSelection=function(b){(angular.isUndefined(b)||_.isNull(b)||b)&&(a.selectedFilterSubscriber=null),a.selectedQueueItems=[],a.multiSelectCount=0,a.filterSchedule()},a.preview=function(a){f.search("_id",a?a._id:a)},a.$on("$routeUpdate",i),a.$on("publish_queue:update",function(a,b){h(b)}),a.reload()}function f(a,b,c,d,e,f,g,h){return{templateUrl:"scripts/superdesk-publish/views/subscribers.html",link:function(e){function i(){d.fetchSubscribers().then(function(a){e.subscribers=a})}function j(){return d.fetchPublishErrors().then(function(a){e.all_errors=a._items[0].all_errors})}e.subscriber=null,e.origSubscriber=null,e.subscribers=null,e.newDestination=null,e.contentFilters=null,e.geoRestrictions=null,e.subTypes=null,angular.isDefined(f.values.geographical_restrictions)?(e.geoRestrictions=f.values.geographical_restrictions,e.subTypes=f.values.subscriber_types):f.fetchMetadataValues().then(function(){e.geoRestrictions=f.values.geographical_restrictions,e.subTypes=f.values.subscriber_types});var k=function(){return c.query("content_filters").then(function(a){e.contentFilters=a._items})},l=function(){e.subscriber&&(e.subscriber.global_filters||(e.subscriber.global_filters={}),_.each(e.globalFilters,function(a){a._id in e.subscriber.global_filters||(e.subscriber.global_filters[a._id]=!0)}))},m=function(){return g.getGlobalContentFilters().then(function(a){e.globalFilters=a})};e.addNewDestination=function(){e.newDestination={}},e.cancelNewDestination=function(){e.newDestination=null},e.saveNewDestination=function(){e.destinations.push(e.newDestination),e.newDestination=null},e.deleteDestination=function(a){_.remove(e.destinations,a)},e.save=function(){e.subscriber.content_filter&&""===e.subscriber.content_filter.filter_id&&(e.subscriber.content_filter=null),e.subscriber.destinations=e.destinations,c.subscribers.save(e.origSubscriber,e.subscriber).then(function(){b.success(a("Subscriber saved.")),e.cancel()},function(c){angular.isDefined(c.data._issues)?angular.isDefined(c.data._issues["validator exception"])?b.error(a("Error: "+c.data._issues["validator exception"])):angular.isDefined(c.data._issues.name)&&angular.isDefined(c.data._issues.name.unique)?b.error(a("Error: Subscriber with Name "+e.subscriber.name+" already exists.")):angular.isDefined(c.data._issues.destinations)&&b.error(a("Error: Subscriber must have at least one destination.")):b.error(a("Error: Failed to save Subscriber."))}).then(i)},e.edit=function(c){var d=[];d.push(j()),d.push(k()),d.push(m()),h.all(d).then(function(){e.origSubscriber=c||{},e.subscriber=_.create(e.origSubscriber),e.subscriber.critical_errors=e.origSubscriber.critical_errors,e.subscriber.content_filter=e.origSubscriber.content_filter||{},e.subscriber.global_filters=e.origSubscriber.global_filters||{},e.subscriber.content_filter.filter_type=e.subscriber.content_filter.filter_type||"blocking",e.destinations=[],angular.isDefined(e.subscriber.destinations)&&!_.isNull(e.subscriber.destinations)&&e.subscriber.destinations.length>0&&(e.destinations=_.clone(e.subscriber.destinations,!0)),e.subscriberType=e.subscriber.subscriber_type||"",e.changeFormats(e.subscriberType),l()},function(){b.error(a("Subscriber could not be initialized!"))})},e.cancel=function(){e.origSubscriber=null,e.subscriber=null,e.newDestination=null},e.changeFormats=function(c){var d=_.result(_.find(e.subTypes,{value:c}),"formats");if(e.destinations.length>0&&""!==e.subscriberType&&e.subscriberType!==c){var f=_.result(_.find(e.subTypes,{value:e.subscriberType}),"formats");_.isEqual(f,d)||(b.error(a("Error: Please re-assign new format for each destination as the changed subscriber type has formats which are not supported by existing destination(s).")),_.each(e.destinations,function(a){a.format=null}))}e.subscriberType=e.subscriber.subscriber_type,e.formats=d},i()}}}var g=angular.module("superdesk.publish",["superdesk.users","superdesk.content_filters"]);return g.value("transmissionTypes",{ftp:{label:"FTP",templateUrl:"scripts/superdesk-publish/views/ftp-config.html"},email:{label:"Email",templateUrl:"scripts/superdesk-publish/views/email-config.html"},ODBC:{label:"ODBC",templateUrl:"scripts/superdesk-publish/views/odbc-config.html"},File:{label:"File",templateUrl:"scripts/superdesk-publish/views/file-config.html"},pull:{label:"Pull"},http_push:{label:"HTTP Push",templateUrl:"scripts/superdesk-publish/views/http-push-config.html"}}),a.$inject=["$scope","privileges"],b.$inject=["api","$q"],c.$inject=["transmissionTypes"],d.$inject=["$scope","api"],e.$inject=["$scope","adminPublishSettingsService","api","$q","notify","$location"],f.$inject=["gettext","notify","api","adminPublishSettingsService","modal","metadata","contentFilters","$q"],g.service("adminPublishSettingsService",b).directive("sdAdminPubSubscribers",f).directive("sdDestination",c).controller("publishQueueCtrl",e),g.config(["superdeskProvider",function(b){b.activity("/settings/publish",{label:gettext("Publish"),templateUrl:"scripts/superdesk-publish/views/settings.html",controller:a,category:b.MENU_SETTINGS,privileges:{subscribers:1},priority:2e3,beta:!0}).activity("/publish_queue",{label:gettext("Publish Queue"),templateUrl:"scripts/superdesk-publish/views/publish-queue.html",controller:e,category:b.MENU_MAIN,adminTools:!1,privileges:{publish_queue:1}})}]).config(["apiProvider",function(a){a.api("subscribers",{type:"http",backend:{rel:"subscribers"}}),a.api("publish_queue",{type:"http",backend:{rel:"publish_queue"}}),a.api("consistency",{type:"http",backend:{rel:"consistency"}}),a.api("legal_publish_queue",{type:"http",backend:{rel:"legal_publish_queue"}}),a.api("io_errors",{type:"http",backend:{rel:"io_errors"}})}]),g}(),function(){"use strict";function a(a){}function b(a,b,c,d){var e=10,f="templates:recent";this.TEMPLATE_METADATA=["headline","slugline","abstract","dateline","byline","subject","genre","type","language","anpa_category","anpa_take_key","keywords","priority","urgency","pubstatus","description","body_html","body_text","place","located","creditline","ednote","language"],this.types=[{_id:"kill",label:c("Kill")},{_id:"create",label:c("Create")}],this.fetchTemplates=function(b,c,d,f,g){b=b||1,c=c||e;var h={};void 0!==d&&(h.template_type=d),void 0!==f&&(h.template_desk=f),g&&(h.template_name={$regex:g,$options:"-i"});var i={max_results:c,page:b};return _.isEmpty(h)||(i.where=JSON.stringify({$and:[h]})),a.content_templates.query(i).then(function(a){return a})},this.fetchTemplatesByIds=function(c){if(!c.length)return b.when();var d={max_results:e,page:1,where:JSON.stringify({_id:{$in:c}})};return a.content_templates.query(d).then(function(a){return a&&a._items&&a._items.sort(function(a,b){return c.indexOf(a._id)-c.indexOf(b._id)}),a})},this.addRecentTemplate=function(a,b){return d.get().then(function(c){return c=c||{},c[f]=c[f]||{},c[f][a]=c[f][a]||[],_.remove(c[f][a],function(a){return a===b}),c[f][a].unshift(b),d.update(c)})},this.getRecentTemplateIds=function(a,b){return b=b||e,d.get().then(function(c){return c&&c[f]&&c[f][a]?_.take(c[f][a],b):[]})},this.getRecentTemplates=function(a,b){return b=b||e,this.getRecentTemplateIds(a,b).then(this.fetchTemplatesByIds)}}function c(a,b,c,d,e,f,g){return{templateUrl:"scripts/superdesk-templates/views/templates.html",link:function(h){function i(){d.fetchTemplates(1,50).then(function(a){h.content_templates=a})}h.weekdays=g,h.content_templates=null,h.origTemplate=null,h.template=null,h.desks=null,f.initialize().then(function(){h.desks=f.desks}),h.getTemplateDesk=function(a){return _.find(h.desks._items,{_id:a.template_desk})},h.getTemplateStage=function(a){return _.find(f.stages._items,{_id:a.template_stage})},h.getTime=function(a){var b=new Date;return b.setUTCHours(a.substr(0,2)),b.setUTCMinutes(a.substr(2,2)),b},h.types=d.types,h.save=function(){delete h.template._datelinedate,c.content_templates.save(h.origTemplate,h.template).then(function(){b.success(a("Template saved.")),h.cancel()},function(c){angular.isDefined(c.data._issues)&&angular.isDefined(c.data._issues["validator exception"])?b.error(a("Error: "+c.data._issues["validator exception"])):b.error(a("Error: Failed to save template."))}).then(i)},h.edit=function(a){h.origTemplate=a||{type:"text"},h.template=_.create(h.origTemplate),h.template.schedule=h.origTemplate.schedule||{},h.item=h.template,h._editable=!0,h.updateStages(h.template.template_desk)},h.remove=function(d){e.confirm(a("Are you sure you want to delete the template?")).then(function(){return c.content_templates.remove(d)}).then(function(a){_.remove(h.templates,d)},function(c){angular.isDefined(c.data._message)?b.error(a("Error: "+c.data._message)):b.error(a("There is an error. Template cannot be deleted."))}).then(i)},h.cancel=function(){h.origTemplate=null,h.template=null,h.vars=null},h.updateStages=function(a){h.stages=a?f.deskStages[a]:null},i()}}}function d(a,b,c,d,e){function f(){d.fetchCurrentUserDesks().then(function(a){h.desks=a._items})}function g(){var d=angular.extend({template_name:h.name,template_type:h.type,template_desk:h.desk},_.pick(a,b.TEMPLATE_METADATA));return c.save("content_templates",d).then(function(a){return h._issues=null,a},function(a){return h._issues=a.data._issues,e.reject(h._issues)})}var h=this;this.type="create",this.name=a.slugline||null,this.desk=d.active.desk||null,this.types=b.types,this.save=g,f()}function e(a){function b(b){a.open({templateUrl:"scripts/superdesk-templates/views/create-template.html",controller:"CreateTemplateController",controllerAs:"template",resolve:{item:function(){return b}}})}this.create=b}function f(b,c){b.activity("/settings/templates",{label:gettext("Templates"),templateUrl:"scripts/superdesk-templates/views/settings.html",controller:a,category:b.MENU_SETTINGS,privileges:{content_templates:1},priority:2e3,beta:!0}),c.api("templates",{type:"http",backend:{rel:"templates"}}),c.api("content_templates",{type:"http",backend:{rel:"content_templates"}})}a.$inject=["$scope"],b.$inject=["api","$q","gettext","preferencesService"],c.$inject=["gettext","notify","api","templates","modal","desks","weekdays"],d.$inject=["item","templates","api","desks","$q"],e.$inject=["$modal"],angular.module("superdesk.templates",["superdesk.activity","superdesk.authoring","superdesk.preferences"]).service("templates",b).directive("sdTemplates",c).controller("CreateTemplateController",d).controller("TemplateMenu",e).config(f),f.$inject=["superdeskProvider","apiProvider"]}();