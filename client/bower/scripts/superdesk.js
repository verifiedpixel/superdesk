!function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(a){p.groups.length>0&&(p.groups.length=0),a&&0!==a.length?_.each(a,function(a){("stage"!==a.type||p.stageLookup[a._id])&&("search"!==a.type||p.searchLookup[a._id])&&p.groups.push(a)}):_.each(p.stageLookup,function(a){a.desk===c.getCurrentDeskId()&&p.groups.push({_id:a._id,type:"stage",header:a.name})}),j(),l(),p.search(p.searchQuery)}function j(){var a={};p.spikeGroups.length>0&&(p.spikeGroups.length=0),0!==p.groups.length&&(_.each(p.groups,function(b,c){if("stage"===b.type){var d=p.stageLookup[b._id];a[d.desk]=p.deskLookup[d.desk]}else"personal"===b.type&&(a.personal={_id:"personal",name:"personal"})}),_.each(a,function(a){"personal"===a._id?p.spikeGroups.push({_id:a._id,type:"spike-personal",header:a.name}):p.spikeGroups.push({_id:a._id,type:"spike",header:a.name})}))}function k(){return p.loading?null:p.readSettings().then(function(a){i(a),m()})}function l(){var a=0===p.selectedFileType.length?null:JSON.stringify(p.selectedFileType);_.each(p.groups,function(b){b.fileType=a}),_.each(p.spikeGroups,function(b){b.fileType=a})}function m(){function a(a){if("stage"===a.type){var b=p.stageLookup[a._id],c=p.deskLookup[b.desk];a.header=c.name,a.subheader=b.name}"search"===a.type&&(a.search=p.searchLookup[a._id],a.header=a.search.name),"personal"===a.type&&(a.header=g("Personal"))}var b=p.groups;angular.forEach(b,a),p.cards=b}var n="agg:view",o=10,p=this;this.loading=!0,this.selected=null,this.groups=[],this.spikeGroups=[],this.modalActive=!1,this.searchLookup={},this.deskLookup={},this.stageLookup={},this.fileTypes=["all","text","picture","composite","video","audio"],this.selectedFileType=[],this.monitoringSearch=!1,this.searchQuery=null,c.initialize().then(angular.bind(this,function(){return c.fetchCurrentUserDesks().then(angular.bind(this,function(a){this.desks=a._items,this.deskLookup=c.deskLookup,this.deskStages=c.deskStages,_.each(this.desks,function(a){_.each(p.deskStages[a._id],function(a){p.stageLookup[a._id]=a})})}))})).then(angular.bind(this,function(){return b.query("all_saved_searches",{}).then(angular.bind(this,function(a){this.searches=a._items,_.each(this.searches,function(a){p.searchLookup[a._id]=a})}))})).then(angular.bind(this,function(){return this.readSettings().then(angular.bind(this,function(a){i(a),m(),this.loading=!1}))})),this.setWidget=function(a){this.widget=a},this.readSettings=function(){return p.widget?d.readActive().then(function(a){var b=[];return p.widget.configuration=p.widget.configuration||{groups:[],label:""},_.each(a.widgets,function(a){a.configuration&&p.widget._id===a._id&&p.widget.multiple_id===a.multiple_id&&(b=a.configuration.groups||b,p.widget.configuration.label=a.configuration.label||"")}),b}):d.getActiveId().then(function(a){if("workspace"===a.type)return e.get(n).then(function(b){return b&&b[a.id]&&b[a.id].groups?b[a.id].groups:void 0});if("desk"===a.type){var b=p.deskLookup[a.id];if(b&&b.monitoring_settings)return b.monitoring_settings}return[]})},this.refreshGroups=k,a.$watch(function(){return d.active},k),this.hasFileType=function(a){return"all"===a?0===this.selectedFileType.length:this.selectedFileType.indexOf(a)>-1},this.getSelectedFileTypes=function(){return 0===this.selectedFileType.length?null:JSON.stringify(this.selectedFileType)},this.setFileType=function(a){if(h.reset(),"all"===a)this.selectedFileType=[];else{var b=this.selectedFileType.indexOf(a);b>-1?this.selectedFileType.splice(b,1):this.selectedFileType.push(a)}l()},this.preview=function(a){this.selected=a},this.edit=function(){this.editGroups={},_.each(this.groups,function(a,b){if(p.editGroups[a._id]={_id:a._id,selected:!0,type:a.type,max_items:a.max_items||o,order:b},"stage"===a.type){var c=p.stageLookup[a._id];p.editGroups[c.desk]={_id:c._id,selected:!0,type:"desk",order:0}}}),this.modalActive=!0},this.search=function(a){this.searchQuery=a,_.each(this.groups,function(b){b.query=a}),_.each(this.spikeGroups,function(b){b.query=a})},this.resetSearch=function(){this.searchQuery=null,_.each(this.groups,function(a){a.query=null}),_.each(this.spikeGroups,function(a){a.query=null})},this.state=f.getItem("agg:state")||{},this.state.expanded=this.state.expanded||{},this.switchExpandedState=function(a){this.state.expanded[a]=!this.getExpandedState(a),f.setItem("agg:state",this.state)},this.getExpandedState=function(a){return void 0===this.state.expanded[a]?!0:this.state.expanded[a]},this.setSoloGroup=function(a){this.state.solo=a,f.setItem("agg:state",this.state)},this.getMaxHeightStyle=function(a){var b=32*(a||o)+6;return{"max-height":b.toString()+"px"}}}function b(a,b,c,d,e){return{templateUrl:"scripts/superdesk-desks/views/aggregate-settings-configuration.html",scope:{modalActive:"=",desks:"=",deskStages:"=",searches:"=",deskLookup:"=",stageLookup:"=",searchLookup:"=",groups:"=",editGroups:"=",onclose:"&",widget:"="},link:function(f,g){var h="agg:view",i=10;f.step={current:"desks"},f.$watch("step.current",function(a){"searches"===a&&f.initSavedSearches(f.showAllSavedSearches)}),f.showAllSavedSearches=!1,f.currentSavedSearches=[],f.closeModal=function(){f.step.current="desks",f.modalActive=!1,f.showAllSavedSearches=!1,f.onclose()},f.previous=function(){e.wizard("aggregatesettings").previous()},f.next=function(){e.wizard("aggregatesettings").next()},f.cancel=function(){f.closeModal()},f.setDeskInfo=function(a){var b=f.editGroups[a];b._id=a,b.type="desk",b.order=0},f.setStageInfo=function(a){var b=f.editGroups[a];b.type||(b._id=a,b.type="stage",b.max_items=i,b.order=_.size(f.editGroups))},f.setSearchInfo=function(a){var b=f.editGroups[a];b.type||(b._id=a,b.type="search",b.max_items=i,b.order=_.size(f.editGroups))},f.setPersonalInfo=function(){var a=f.editGroups.personal;a.type||(a._id="personal",a.type="personal",a.max_items=i,a.order=_.size(f.editGroups))},f.initSavedSearches=function(a){var b=c.identity._id;f.showAllSavedSearches=a,f.currentSavedSearches.length>0&&(f.currentSavedSearches.length=0),_.each(f.searches,function(a){var c=f.editGroups[a._id];(f.showAllSavedSearches||a.user===b||c&&c.selected)&&f.currentSavedSearches.push(a)})},f.getValues=function(){var a=Object.keys(f.editGroups).map(function(a){return f.editGroups[a]});return a=_.filter(a,function(a){if("desk"===a.type||!a.selected)return!1;if("stage"===a.type){var b=f.stageLookup[a._id];return f.editGroups[b.desk].selected}return"personal"===a.type?f.editGroups.personal.selected:!0}),a=_.sortBy(a,function(a){return a.order})},f.reorder=function(a,b){var c=f.getValues();b.index!==a.index&&(c.splice(b.index,0,c.splice(a.index,1)[0]),_.each(c,function(a,b){a.order=b}))},f.save=function(){var c=[];_.each(f.getValues(),function(a,b){a.selected&&"desk"!==a.type&&c.push({_id:a._id,type:a.type,max_items:a.max_items})}),f.widget?b.getActive().then(function(a){var d=angular.copy(a.widgets);_.each(d,function(a){f.widget._id===a._id&&f.widget.multiple_id===a.multiple_id&&(a.configuration={},a.configuration.groups=c,f.widget.configuration.label&&(a.configuration.label=f.widget.configuration.label))}),b.save(a,{widgets:d}).then(function(){f.showAllSavedSearches=!1,f.onclose()})}):(b.getActiveId().then(function(b){"workspace"===b.type?d.get(h).then(function(a){var f={};a&&(f[h]=a),f[h][b.id]={groups:c},d.update(f,h).then(function(){e.wizard("aggregatesettings").finish()})}):"desk"===b.type&&a.save(f.deskLookup[b.id],{monitoring_settings:c}).then(function(){e.wizard("aggregatesettings").finish()})}),f.showAllSavedSearches=!1,f.onclose())}}}}function c(){return{link:function(a,b){var c=!1;b.sortable({items:".sort-item",cursor:"move",containment:".groups",tolerance:"pointer",placeholder:{element:function(a){var b=a.height()-20;return $('<li class="placeholder" style="height:'+b+'px"></li>')[0]},update:function(){}},start:function(a,b){b.item.data("start_index",b.item.parent().find("li.sort-item").index(b.item))},stop:function(b,d){if(c){c=!1;var e={index:d.item.data("start_index")},f={index:d.item.parent().find("li.sort-item").index(d.item)};d.item.remove(),a.reorder(e,f),a.$apply()}},update:function(a,b){c=!0},cancel:".fake"})}}}a.$inject=["$scope","api","desks","workspaces","preferencesService","storage","gettext","multi"],b.$inject=["desks","workspaces","session","preferencesService","WizardHandler"],angular.module("superdesk.aggregate",["superdesk.authoring.widgets","superdesk.desks","superdesk.workspace"]).controller("AggregateCtrl",a).directive("sdAggregateSettings",b).directive("sdSortGroups",c)}(),function(){"use strict";angular.module("superdesk.aggregate.widgets",["superdesk.aggregate","superdesk.dashboard.widgets"]).config(["widgetsProvider",function(a){a.widget("aggregate",{label:"Monitoring",multiple:!0,icon:"archive",max_sizex:2,max_sizey:2,sizex:1,sizey:2,thumbnail:"scripts/superdesk-desks/aggregate-widget/thumbnail.svg",template:"scripts/superdesk-desks/aggregate-widget/aggregate-widget.html",configurationTemplate:"scripts/superdesk-desks/aggregate-widget/configuration.html",description:"Displaying the monitoring content view.",custom:!0})}])}(),function(){"use strict";function a(a,b,c,d,e,f){function g(a){function b(a,b){return a.name.localeCompare(b.name)}var c=a._items||[];return c.sort(b),c}var h;b.initialize().then(function(){a.desks=b.desks,a.deskStages=b.deskStages,b.fetchCurrentUserDesks().then(function(a){h=a._items})}),a.statuses=e.statuses,a.online_users=!1,f("roles").query().then(function(b){a.roles=g(b)}),a.privileges=d.privileges,a.views=["content","tasks","users"],a.view=a.views[0],a.setView=function(b){a.view=b},a.changeOnlineUsers=function(b){a.online_users=b},a.isMemberOf=function(a){return _.find(h,{_id:a._id})},a.openDeskView=function(a,d){b.setCurrentDeskId(a._id),c.intent("view",d)},a.$on("desks:refresh:stages",function(c,d){b.refreshStages().then(function(){a.deskStages[d]=b.deskStages[d]})})}function b(a,b,c,d,e,f,g,h,i){return{templateUrl:"scripts/superdesk-desks/views/stage-item-list.html",scope:{stage:"=",total:"=",allowed:"=",showEmpty:"=?",maxItems:"=?",selected:"=?",action:"&",filter:"="},link:function(a,d){function j(c){n=e.criteria(a.stage,c),a.loading=!0,a.items=a.total=null,b("archive").query(n).then(function(b){a.items=b._items,a.total=b._meta.total,a.cachePreviousItems=b._items,k(n)})["finally"](function(){a.loading=!1})}function k(c){return c.source.from=a.page*c.source.size,b("archive").query(c).then(function(b){a.cacheNextItems=b._items})}function l(a){h.hash(a),i()}function m(b,c){a.select(b),c&&(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())}var n;a.page=1,a.fetching=!1,a.cacheNextItems=[],a.cachePreviousItems=[],a.preview=function(a){c.intent("preview","item",a)},a.edit=function(a){c.intent("edit","item",a).then(null,function(){c.intent("view","item",a)})},a.$watch("filter",j),a.$on("task:stage",function(b,c){!a.stage||c.new_stage!==a.stage&&c.old_stage!==a.stage||j()}),a.$on("content:update",function(b,c){e.shouldUpdate(a.stage,c)&&j()});var o=d[0],p=0;d.bind("scroll",function(){a.$apply(function(){o.scrollTop+o.offsetHeight>=o.scrollHeight-3&&(o.scrollTop=o.scrollTop-3,a.fetchNext()),o.scrollTop<=2&&(p=2-o.scrollTop,o.scrollTop=o.scrollTop+p,a.fetchPrevious())})}),a.fetchNext=function(){return a.fetching?g.when(!1):void(a.cacheNextItems.length>0&&(a.fetching=!0,a.page=a.page+1,n.source.from=a.page*n.source.size,a.loading=!0,a.items.length>n.source.size&&(a.cachePreviousItems=_.slice(a.items,0,n.source.size),a.items.splice(0,n.source.size)),f(function(){_.isEqual(a.items,a.cacheNextItems)||(a.items=a.items.concat(a.cacheNextItems))},100),b("archive").query(n).then(function(b){a.cacheNextItems=b._items,a.fetching=!1},function(){})["finally"](function(){a.loading=!1})))},a.fetchPrevious=function(){return!a.fetching&&a.page>2?(a.fetching=!0,a.page=a.page-1,a.page>2?n.source.from=(a.page-3)*n.source.size:n.source.from=0,a.loading=!0,a.items.length>n.source.size&&(a.cacheNextItems=_.slice(a.items,a.items.length-(a.items.length-n.source.size),a.items.length),a.items.splice(a.items.length-(a.items.length-n.source.size),n.source.size)),f(function(){a.items.unshift.apply(a.items,a.cachePreviousItems),a.items.length>0&&l(a.items[parseInt((a.items.length-1)/2,a.maxItems||10)]._id)},100),b("archive").query(n).then(function(b){a.cachePreviousItems=b._items,a.fetching=!1})["finally"](function(){a.loading=!1}),void 0):g.when(!1)};var q,r=-1,s=1;d.on("keyup",function(b){a.$apply(function(){b.keyCode?q=b.keyCode:b.which&&(q=b.which),38===q&&a.move(r,b),40===q&&(b.preventDefault(),a.move(s,b))})}),a.move=function(b,c){if(null!=a.selected&&a.selected.task.stage===a.stage&&a.items){var d=_.findIndex(a.items,{_id:a.selected._id});-1===d&&m(_.first(a.items),c);var e=_.max([0,_.min([a.items.length-1,d+b])]);0>e&&m(_.last(a.items),c),d!==e?(l(a.items[e]._id),m(a.items[e],c)):c&&(c.preventDefault(),c.stopPropagation(),c.stopImmediatePropagation())}},a.select=function(a){this.selected=a}}}}function c(a,b,c){return{templateUrl:"scripts/superdesk-desks/views/task-status-items.html",scope:{status:"=",desk:"=",total:"="},link:function(d,e){d.users=c.userLookup;var f=a.query({});f.filter({and:[{term:{"task.status":d.status}},{term:{"task.desk":d.desk}}]}),f.size(10);var g={source:f.getCriteria()};d.loading=!0,b("archive").query(g).then(function(a){d.loading=!1,d.items=a._items,d.total=a._meta.total},function(){d.loading=!1})}}}function d(a,b){return{templateUrl:"scripts/superdesk-desks/views/user-role-items.html",scope:{role:"=",desk:"=",total:"=",online:"=",privilege:"="},link:function(c,d){c.users=a.deskMembers[c.desk],c.total=0,c.items=[],c.user=null,_.each(c.users,function(a,b){c.role===a.role&&(c.items.push(a),c.total=c.total+1)}),c.isLoggedIn=function(a){return b.isLoggedIn(a)},c.openEditUser=function(a){c.user=a},c.closeEditUser=function(){c.user=null}}}}function e(a,b){b.initialize().then(function(){a.desks=b.desks})}function f(a,b,c,d,e,f){a.modalActive=!1,a.numberOfUsers=3,a.step={current:null},a.desk={edit:null},a.openDesk=function(b,c){a.modalActive=!0,a.step.current=b,a.desk.edit=c},a.cancel=function(){a.modalActive=!1,a.step.current=null,a.desk.edit=null},a.remove=function(e){f.confirm(b("Please confirm you want to delete desk.")).then(function(){d.remove(e).then(function(d){_.remove(a.desks._items,e),c.success(b("Desk deleted."),3e3)},function(a){angular.isDefined(a.data._message)?c.error(b("Error: "+a.data._message)):c.error(b("Unknown Error: There was a problem, desk was not deleted."))})})},a.getDeskStages=function(a){return d.deskStages[a._id]},a.getDeskUsers=function(a){return d.deskMembers[a._id]}}function g(){return{templateUrl:"scripts/superdesk-desks/views/stage-header.html"}}a.$inject=["$scope","desks","superdesk","privileges","tasks","api"],b.$inject=["search","api","superdesk","desks","cards","$timeout","$q","$location","$anchorScroll"],c.$inject=["search","api","desks"],d.$inject=["desks","usersService"],e.$inject=["$scope","desks"],f.$inject=["$scope","gettext","notify","desks","WizardHandler","modal"];var h=angular.module("superdesk.desks",["superdesk.users","superdesk.authoring.widgets","superdesk.aggregate.widgets","superdesk.aggregate"]),i={stage:15,desk:40};return h.config(["superdeskProvider",function(b){b.activity("/desks/",{label:gettext("Master Desk"),description:gettext("Navigate through the newsroom"),templateUrl:"scripts/superdesk-desks/views/main.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:a,priority:-100,adminTools:!1,category:b.MENU_MAIN,privileges:{desks:1}}).activity("/settings/desks",{label:gettext("Desks"),controller:e,templateUrl:"scripts/superdesk-desks/views/settings.html",category:b.MENU_SETTINGS,priority:-800,privileges:{desks:1}})}]).config(["apiProvider",function(a){a.api("desks",{type:"http",backend:{rel:"desks"}})}]).factory("desks",["$q","api","preferencesService","userList","notify","session",function(a,b,c,d,e,f){function g(a){a.active&&a.active.desk===a.activeDeskId&&a.active.stage===a.activeStageId||(a.active={desk:a.activeDeskId,stage:a.activeStageId})}function h(a){return i=null,j=null,l.loading=null,a}var i,j,k=function(a,c,d){return c=c||1,d=d||[],b.query(a,{max_results:200,page:c}).then(function(b){return d=d.concat(b._items),b._links.next?(c++,k(a,c,d)):d})},l={desks:null,users:null,stages:null,deskLookup:{},stageLookup:{},userLookup:{},deskMembers:{},deskStages:{},loading:null,activeDeskId:null,activeStageId:null,active:{desk:null,stage:null},fetchDesks:function(){var a=this;return k("desks").then(function(b){a.desks={_items:b},_.each(b,function(b){a.deskLookup[b._id]=b})})},fetchUsers:function(){var a=this;return d.getAll().then(function(b){a.users={},a.users._items=b,_.each(b,function(b){a.userLookup[b._id]=b})})},fetchStages:function(){var a=this;return k("stages").then(function(b){a.stages={_items:b},_.each(b,function(b){a.stageLookup[b._id]=b})})},fetchDeskStages:function(b){function c(){return d.deskStages[b]}var d=this;return d.deskStages[b]?a.when().then(c):d.fetchStages().then(angular.bind(d,d.generateDeskStages)).then(c)},generateDeskMembers:function(){var b=this;return _.each(this.desks._items,function(a){b.deskMembers[a._id]=[],_.each(a.members,function(c,d){var e=_.find(b.users._items,{_id:c.user});e?b.deskMembers[a._id].push(e):console.error("Desk user not found for desk: %s , user missing: %s",a.name,c.user)})}),a.when()},generateDeskStages:function(){var b=this;return this.deskStages=_.groupBy(b.stages._items,"desk"),a.when()},fetchUserDesks:function(a){return b.get(a._links.self.href+"/desks")},fetchCurrentUserDesks:function(){var b=this;return b.userDesks?a.when(b.userDesks):this.fetchCurrentDeskId().then(angular.bind(f,f.getIdentity)).then(angular.bind(this,this.fetchUserDesks)).then(angular.bind(this,function(a){return b.userDesks=a,g(this),a}))},fetchCurrentDeskId:function(){var b=this;return b.activeDeskId?a.when(b.activeDeskId):c.get("desk:last_worked").then(function(a){return b.activeDeskId=null,angular.isDefined(a)&&(b.activeDeskId=a),b.activeDeskId})},fetchCurrentStageId:function(){var b=this;return b.activeStageId?a.when(b.activeStageId):c.get("stage:items").then(function(a){angular.isDefined(a)&&(b.activeStageId=angular.isArray(a)?a[0]:a)})},getCurrentDeskId:function(){return this.userDesks&&this.userDesks._items&&0!==this.userDesks._items.length?this.activeDeskId&&_.find(this.userDesks._items,{_id:this.activeDeskId})?this.activeDeskId:this.userDesks._items[0]._id:null},setCurrentDeskId:function(a){this.activeDeskId!==a&&(this.activeDeskId=a,this.activeStageId=null,g(this),c.update({"desk:last_worked":this.activeDeskId,"stage:items":[]},"desk:last_worked"))},getCurrentStageId:function(){return this.activeStageId},setCurrentStageId:function(a){this.activeStageId!==a&&(this.activeStageId=a,g(this),c.update({"desk:last_worked":this.activeDeskId,"stage:items":[this.activeStageId]},"desk:last_worked"))},fetchDeskById:function(a){return b.desks.getById(a)},getCurrentDesk:function(){return this.deskLookup[this.getCurrentDeskId()]||null},setWorkspace:function(a,b){a=a||null,b=b||null,(this.activeDeskId!==a||this.activeStageId!==b)&&(this.activeDeskId=a,this.activeStageId=b,g(this),c.update({"desk:last_worked":this.activeDeskId,"stage:items":[this.activeStageId]},"desk:last_worked"))},initialize:function(){return this.loading||(this.fetchCurrentDeskId(),this.fetchCurrentStageId(),this.loading=this.fetchUsers().then(angular.bind(this,this.fetchDesks)).then(angular.bind(this,this.generateDeskMembers)).then(angular.bind(this,this.fetchStages)).then(angular.bind(this,this.generateDeskStages)).then(angular.bind(this,this.initActive))),this.loading},initActive:function(){g(this)},save:function(a,c){return b.save("desks",a,c).then(h)},remove:function(a){return b.remove(a).then(h)},refreshStages:function(){return this.fetchStages().then(angular.bind(this,this.generateDeskStages))},refreshUsers:function(){return this.fetchUsers().then(angular.bind(this,this.generateDeskMembers))},getItemDesk:function(a){return a.task&&a.task.desk?this.deskLookup[a.task.desk]||null:void 0}};return l}]).directive("sdStageItems",b).directive("sdTaskStatusItems",c).directive("sdUserRoleItems",d).directive("sdDeskConfig",function(){return{controller:f}}).directive("sdDeskConfigModal",function(){return{scope:{modalActive:"=active",desk:"=",step:"=",desks:"=",cancel:"&"},require:"^sdDeskConfig",templateUrl:"scripts/superdesk-desks/views/desk-config-modal.html",link:function(a,b,c,d){}}}).directive("sdFocusElement",[function(){return{link:function(a,b,c){b.click(function(){_.defer(function(){angular.element(document.querySelector(c.target)).focus()})})}}}]).directive("sdContentExpiry",[function(){return{templateUrl:"scripts/superdesk-desks/views/content-expiry.html",scope:{item:"=",preview:"=",header:"@"},link:function(a,b,c){function d(a){return Math.floor(a/60)}function e(a){return Math.floor(a%60)}function f(a){return 60*a.Hours+a.Minutes}var g=c.expiryfield;a.ContentExpiry={Hours:0,Minutes:0,Header:"Content Expiry"},a.$watch("item",function(){h(a.item)}),a.$watch("ContentExpiry",function(){a.item||(a.item={}),a.item[g]=f(a.ContentExpiry)},!0);var h=function(b){a.ContentExpiry.Header=a.header,b&&null!=b[g]&&(a.ContentExpiry.Hours=d(b[g]),a.ContentExpiry.Minutes=e(b[g]))}}}}]).directive("sdDeskeditBasic",["gettext","desks","WizardHandler",function(a,b,c){return{link:function(d,e,f){function g(a){a.data&&a.data._issues&&a.data._issues.name&&a.data._issues.name.unique?d._errorUniqueness=!0:d._error=!0,d.message=null}function h(){(d._errorUniqueness||d._error||d._errorLimits)&&(d._errorUniqueness=null,d._error=null,d._errorLimits=null)}d.limits=i,d.$watch("step.current",function(a){"general"===a&&(d.desk.edit&&d.desk.edit._id&&d.edit(d.desk.edit),d.message=null)}),d.edit=function(a){d.desk.edit=_.create(a)},d.save=function(e){d.message=a("Saving...");var f=e._id?!1:!0;b.save(d.desk.edit,e).then(function(){if(f)d.edit(d.desk.edit),d.desks._items.unshift(d.desk.edit);else{var a=_.find(d.desks._items,{_id:d.desk.edit._id});_.extend(a,d.desk.edit)}b.deskLookup[d.desk.edit._id]=d.desk.edit,c.wizard("desks").next()},g)},d.handleEdit=function(a){h(),null!=d.desk.edit.name&&(d._errorLimits=d.desk.edit.name.length>d.limits.desk?!0:null)}}}}]).directive("sdDeskeditStages",["gettext","api","WizardHandler","tasks","$rootScope","desks","notify","macros",function(a,b,c,d,e,f,g,h){return{link:function(j,k,l){function m(a){a.data&&a.data._issues?a.data._issues.name&&a.data._issues.name.unique?j._errorUniqueness=!0:a.data._issues["validator exception"]&&g.error(a.data._issues["validator exception"]):j._error=!0,j.message=null}function n(){(j._errorUniqueness||j._error||j._errorLimits)&&(j._errorUniqueness=null,j._error=null,j._errorLimits=null)}function o(a,b){e.$broadcast("desks:refresh:stages",j.desk.edit._id)}var p=null;j.limits=i,j.statuses=d.statuses,j.desk.edit&&j.desk.edit._id&&h.getByDesk(j.desk.edit.name).then(function(a){j.macros=a}),j.$watch("step.current",function(a,b){"stages"===a&&(j.editStage=null,p=null,j.stages=[],j.selected=null,j.message=null,j.getstages(b))}),j.getstages=function(a){j.desk.edit&&j.desk.edit._id?(j.message="loading...",b("stages").query({where:{desk:j.desk.edit._id}}).then(function(a){j.stages=a._items,j.message=null})):c.wizard("desks").goTo(a)},j.previous=function(){c.wizard("desks").previous()},j.next=function(){c.wizard("desks").next()},j.edit=function(a){if(null==a.is_visible&&(a.is_visible=!0),p=a,j.editStage=_.create(a),!j.editStage._id){var b=_.last(j.stages);b&&(j.editStage.task_status=b.task_status)}},j.isActive=function(a){return j.editStage&&j.editStage._id===a._id},j.cancel=function(){j.editStage=null,n()},j.select=function(a){return j.editStage&&j.editStage._id!==a._id?!1:void(j.selected=a)},j.setStatus=function(a){j.editStage.task_status=a._id},j.save=function(){p._id?b("stages").save(p,j.editStage).then(function(a){j.editStage=null,j.message=null,j.select(a),o(),j.getstages(),f.fetchDeskById(a.desk).then(function(a){j.desk.edit=a})},m):(_.extend(j.editStage,{desk:j.desk.edit._id}),b("stages").save({},j.editStage).then(function(a){j.stages.push(a),j.editStage=null,j.select(a),j.message=null,o(),j.getstages(),f.fetchDeskById(a.desk).then(function(a){j.desk.edit=a})},m))},j.handleEdit=function(a){n(),null!=j.editStage.name&&(j._errorLimits=j.editStage.name.length>j.limits.stage?!0:null)},j.remove=function(c){b("stages").remove(c).then(function(){c===j.selected&&(j.selected=null),_.remove(j.stages,c),j.message=null,o(c._id),f.fetchDeskById(c.desk).then(function(a){j.desk.edit=a})},function(b){angular.isDefined(b.data._message)?j.message=a("Error: "+b.data._message):j.message=a("There was a problem, stage was not deleted.")})}}}}]).directive("sdUserSelectList",["$filter","api",function(a,b){return{scope:{exclude:"=",onchoose:"&"},templateUrl:"scripts/superdesk-desks/views/user-select.html",link:function(a,c,d){function e(){return a.selected?_.findIndex(a.users._items,a.selected):-1}function f(){var b=e();b>0&&a.select(a.users._items[_.max([0,b-1])])}function g(){var b=e();a.select(a.users._items[_.min([a.users._items.length-1,b+1])])}var h=38,i=40,j=13;a.selected=null,a.search=null,a.users={},a.exclude=[];var k=function(){return a.users={},b("users").query({where:JSON.stringify({$or:[{username:{$regex:a.search,$options:"-i"}},{first_name:{$regex:a.search,$options:"-i"}},{last_name:{$regex:a.search,$options:"-i"}},{email:{$regex:a.search,$options:"-i"}}]})}).then(function(b){a.users=b,a.users._items=_.filter(a.users._items,function(b){return-1===_.findIndex(a.exclude,{_id:b._id})}),a.selected=null})},l=_.debounce(k,1e3);a.$watch("search",function(){a.search&&l()}),c.bind("keydown keypress",function(b){a.$apply(function(){switch(b.which){case h:b.preventDefault(),f();break;case i:b.preventDefault(),g();break;case j:b.preventDefault(),e()>=0&&a.choose(a.selected)}})}),a.choose=function(b){a.onchoose({user:b}),a.search=null},a.select=function(b){a.selected=b}}}}]).directive("sdDeskeditPeople",["gettext","WizardHandler","desks","$rootScope",function(a,b,c,d){return{link:function(d,e,f){d.$watch("step.current",function(a,e){"people"===a&&(d.search=null,d.deskMembers=[],d.message="loading...",d.desk.edit&&d.desk.edit._id?c.fetchUsers().then(function(a){d.users=c.users._items,d.deskMembers=c.deskMembers[d.desk.edit._id]||[],d.message=null}):b.wizard("desks").goTo(e))}),d.add=function(a){d.deskMembers.push(a)},d.remove=function(a){_.remove(d.deskMembers,a)},d.previous=function(){b.wizard("desks").previous()},d.save=function(){var e=_.map(d.deskMembers,function(a){return{user:a._id}});c.save(d.desk.edit,{members:e}).then(function(a){_.extend(d.desk.edit,a),c.deskMembers[d.desk.edit._id]=d.deskMembers;var e=c.deskLookup[d.desk.edit._id];_.extend(e,d.desk.edit),b.wizard("desks").next()},function(b){d.message=a("There was a problem, members not saved.")})}}}}]).directive("sdDeskeditMacros",["macros","WizardHandler","desks","$rootScope",function(a,b,c,d){return{link:function(c){c.desk&&c.desk.edit&&a.getByDesk(c.desk.edit.name).then(function(a){c.macros=a}),c.previous=function(){b.wizard("desks").previous()},c.save=function(){b.wizard("desks").finish()}}}}]).directive("sdActionPicker",["desks","macros",function(a,b){return{scope:{desk:"=",stage:"=",macro:"="},templateUrl:"scripts/superdesk-desks/views/actionpicker.html",link:function(c,d,e){c.desks=null,c.deskStages=null,c.deskMacros=null,c.$watchGroup(["desk","stage"],function(){c.desks&&c.deskStages?c.desk&&(b.getByDesk(a.deskLookup[c.desk].name).then(function(a){c.deskMacros=a}),-1===_.findIndex(c.deskStages[c.desk],{_id:c.stage})&&(c.stage=null)):a.initialize().then(function(){c.desks=a.desks._items,c.deskStages=a.deskStages})})}}}]).directive("sdStageHeader",g),h}(),function(){"use strict";function a(a,b){return angular.extend(a,_.pick(b,_.keys(w)))}function b(a){var b=["headline","abstract"];_.each(b,function(b){if(angular.isDefined(a[b])){var c=document.createElement("div");c.innerHTML=a[b],""!==c.textContent&&(a[b]=c.textContent)}})}function c(a,b){_.each(w,function(c,d){a[d]?b[d]?a[d]=b[d]:a[d]=c:b[d]&&(a[d]=b[d])})}function d(b,c,d){var e="archive_autosave",f=3e3,g={};this.open=function(a){return a._locked||!a._editable?b.when(a):d.find(e,a._id).then(function(b){return a._autosave=b,a},function(b){return a})},this.save=function(b){return b._editable&&!b._locked?(this.stop(b),g[b._id]=c(function(){var c=a({_id:b._id},b);return d.save(e,{},c).then(function(c){a(b,c);var d=Object.getPrototypeOf(b);d._autosave=c})},f),g[b._id]):void 0},this.stop=function(a){g[a._id]&&(c.cancel(g[a._id]),g[a._id]=null)},this.drop=function(a){this.stop(a),angular.isDefined(a._autosave)&&null!==a._autosave&&d(e).remove(a._autosave),a._autosave=null}}function e(c,d,e,f,g,h,i){var j=this;this.limits={slugline:24,headline:64,"abstract":160},this.userDesks=[],i.fetchCurrentUserDesks().then(function(a){j.userDesks=a._items}),this.open=function(a,b,c){return angular.isDefined(c)&&"legal_archive"===c?d.find("legal_archive",a).then(function(a){return a._editable=!1,a}):d.find("archive",a,{embedded:{lock_user:1}}).then(function(a){return a._editable=!b,e.lock(a)}).then(function(a){return f.open(a)})},this.close=function(a,b,d,h){var i=c.when();return this.isEditable(a)&&(d&&(i=_.contains(["published","corrected"],b.state)?c.when("ignore"):g.confirm().then(angular.bind(this,function(){return this.save(b,a)}),function(){return c.when("ignore")})),i=i.then(function(c){return c&&"ignore"===c&&f.drop(b),h?void 0:e.unlock(a)})),i},this.publishConfirmation=function(a,b,d,e){var f=c.when();return this.isEditable(b)&&d&&(f=g.confirmPublish(e).then(angular.bind(this,function(){return!0}),function(){return!1})),f},this.cleanUpdatesBeforePublishing=function(a,c){c.publish_schedule||delete c.publish_schedule,this.isPublished(a)&&(delete c.dateline,c.embargo&&delete c.embargo),_.isEqual(a.renditions,c.renditions)&&delete c.renditions,b(c)},this.publish=function(b,c,f){f=f||"publish",c=a({},c),this.cleanUpdatesBeforePublishing(b,c);var g="archive_"+f;return d.update(g,b,c).then(function(a){return e.unlock(a).then(function(a){return a})},function(a){return a})},this.saveWorkConfirmation=function(a,b,d,e){var f=c.when();return d&&this.isEditable(b)&&(f=g.confirmSaveWork(e).then(angular.bind(this,function(){return this.saveWork(a,b)}),function(a){return c.when()})),f},this.autosave=function(a){return f.save(a)},this.save=function(g,h){var i=a({},h);return angular.isDefined(g)&&angular.forEach(_.keys(i),function(a){_.isEqual(i[a],g[a])&&delete i[a]}),b(i),f.stop(h),_.size(i)>0?d.save("archive",h,i).then(function(a){return h._autosave=null,h._locked=e.isLocked(h),h}):c.when(g)},this.saveWork=function(b,c){var e={type:b.type,version:1,task:{desk:null,stage:null,user:b.task.user}},f=_.omit(c,["unique_name","unique_id","_id","guid"]),g=a(e,f);return d.save("archive",{},g).then(function(a){return a._autosave=null,a})},this.isEditable=function(a){return!!a.lock_user&&!e.isLocked(a)},this.isPublished=function(a){return _.contains(["published","killed","scheduled","corrected"],a.state)},this.unlock=function(a,b){f.stop(a),a.lock_session=null,a.lock_user=null,a._locked=!1,g.unlock(b)},this.lock=function(a,b){f.stop(a),d.find("users",b).then(function(b){a.lock_user=b},function(c){a.lock_user=b}),a._locked=!0},this.linkItem=function(a,b,c){var e={};return b&&(e.link_id=b),c&&(e.desk=c),d.save("archive_link",{},e,a)},this.itemActions=function(a){var b=a&&angular.isDefined(a.archive_item)?a.archive_item:a,c=h.privileges,d=angular.extend({},x);if(angular.isUndefined(b)||angular.isUndefined(c)||"killed"===b.state||angular.isDefined(b.takes)&&"killed"===b.takes.state)return d;var f=_.contains(["spiked","scheduled","killed"],b.state)||angular.isDefined(b.package_type)&&"takes"===b.package_type,g=!e.isLocked(b);if(d.view=!g,d.new_take=!f&&("text"===b.type||"preformatted"===b.type)&&!b.embargo&&!b.publish_schedule&&(angular.isUndefined(b.takes)||b.takes.last_take===b._id)&&(angular.isUndefined(b.more_coming)||!b.more_coming),
j.isPublished(b)){if(angular.isDefined(a.archive_item)&&a._current_version!==a.archive_item._current_version||this._versionToFetch&&this._versionToFetch!==a._current_version)return angular.extend({},x);d.view=!0,"scheduled"===b.state?d.deschedule=!0:("published"===b.state||"corrected"===b.state)&&(d.kill=c.kill&&g&&!f,d.correct=c.correct&&g&&!f),d.re_write=_.contains(["published","corrected"],b.state)&&_.contains(["text","preformatted"],b.type)&&!b.embargo&&(angular.isUndefined(b.more_coming)||!b.more_coming)}else{if("spiked"===b.state)return d=angular.extend({},x),d.unspike=!0,d;d.save="spiked"!==b.state,d.publish=!b.marked_for_not_publication&&b.task&&b.task.desk&&c.publish&&"draft"!==b.state,d.edit=!("composite"===b.type&&"takes"===b.package_type)&&"spiked"!==b.state&&g,d.unspike="spiked"===b.state&&c.unspike,d.spike="spiked"!==b.state&&c.spike&&(angular.isUndefined(b.takes)||b.takes.last_take===b._id),d.send=b._current_version>0&&c.move}if(d.mark_item=b.task&&b.task.desk&&!f&&"takes"!==b.package_type&&c.mark_for_highlights,d.package_item="spiked"!==b.state&&"scheduled"!==b.state&&!b.embargo&&"takes"!==b.package_type&&"killed"!==b.state&&!b.publish_schedule,d.multi_edit=!f,b.task&&b.task.desk){var i=_.find(j.userDesks,{_id:b.task.desk});i||(d=angular.extend({},x)),d.duplicate=c.duplicate&&!_.contains(["spiked","killed"],b.state)&&(angular.isUndefined(b.package_type)||"takes"!==b.package_type)}else d.copy=!0,d.view=!1,d.package_item=!1,d.new_take=!1;return d},this.setItemVersion=function(a){this._versionToFetch=a},this.isTakeItem=function(a){return _.contains(["text","preformatted"],a.type)&&a.takes&&a.takes.sequence>1}}function f(a,b,c,d,e){function f(a){return a.lock_user&&a.lock_user._id||a.lock_user}this.lock=function(d,f){return!d.lock_user&&d._editable||f?b.save("archive_lock",{},{},d).then(function(a){return _.extend(d,a),d._locked=!1,d.lock_user=c.identity._id,d.lock_session=c.sessionId,d},function(a){return e.error(gettext("Failed to get a lock on the item!")),d._locked=!0,d._editable=!1,d}):(d._locked=this.isLocked(d),a.when(d))},this.unlock=function(a){return b("archive_unlock",a).save({}).then(function(b){return _.extend(a,b),a._locked=!0,a},function(b){return a._locked=!0,a})},this.isLocked=function(a){var b=f(a);return b?b!==c.identity._id?!0:a.lock_session&&a.lock_session!==c.sessionId?!0:!1:!1},this.isLockedByMe=function(a){var b=f(a);return b&&b===c.identity._id},this.can_unlock=function(a){return this.isLockedByMe(a)?!0:d.privileges.unlock}}function g(a,b,c,d,e,f,g){this.setupWindow=function(b){a.onbeforeunload=function(){return b.dirty?f("There are unsaved changes. If you navigate away, your changes will be lost."):void b.$on("$destroy",function(){a.onbeforeunload=angular.noop})}},this.confirm=function(){return e.confirm(f("There are some unsaved changes, do you want to save it now?"),f("Save changes?"),f("Save"),f("Ignore"),f("Cancel"))},this.confirmPublish=function(a){return e.confirm(g(f("There are some unsaved changes, do you want to save it and {{ action }} now?"))({action:a}),f("Save changes?"),g(f("Save and {{ action }}"))({action:a}),f("Cancel"))},this.confirmSaveWork=function(a){return e.confirm(g(f("Configuration has changed, {{ message }}. Would you like to save story to your workspace?"))({message:a}))},this.confirmSpellcheck=function(a){return e.confirm(g(f("You have {{ message }} spelling mistakes. Are you sure you want to continue?"))({message:a}))},this.unlock=function(a){d.find("users",a).then(function(a){var b=f("This item was unlocked by <b>{{ user }}</b>.").replace("{{ user }}",c("username")(a));return e.confirm(b,f("Item Unlocked"),f("OK"),!1)})},this.lock=function(a){d.find("users",a).then(function(a){var b=f("This item was locked by <b>{{ user }}</b>.").replace("{{ user }}",c("username")(a));return e.confirm(b,f("Item locked"),f("OK"),!1)})}}function h(a,b,c,d,e){function f(b){var c={},d=a.preview[b];return c.CropLeft=Math.round(Math.min(d.cords.x,d.cords.x2)),c.CropRight=Math.round(Math.max(d.cords.x,d.cords.x2)),c.CropTop=Math.round(Math.min(d.cords.y,d.cords.y2)),c.CropBottom=Math.round(Math.max(d.cords.y,d.cords.y2)),c}function g(b){var c={};c[b]=f(b),_.extend(a.data.cropData,c)}a.data=a.locals.data,a.preview={},a.origPreview={},a.data.cropData={},a.data.isDirty=!1,a.$watch("preview",function(b,c){return b===c?void(a.origPreview=a.preview):Object.keys(b).length===Object.keys(c).length?void(a.data.isDirty=!0):void 0},!0),a.done=function(){_.forEach(a.data.cropsizes,function(a){g(a.name)}),c.success(b("Crop changes have been recorded")),a.resolve(a.data)},a.close=function(){a.data.isDirty?d.confirm(b("You have unsaved changes, do you want to continue?")).then(function(){a.data.isDirty=!1,a.preview=a.origPreview,a.resolve(a.data)}):a.reject()}}function i(a,b,c,d){a.origItem=b,a.action=c||"edit",a.lock=function(){d.intent("author","article",b)}}function j(b,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t){return{link:function(q,r,u){function v(a){i.generate_highlights.save({},{"package":a}).then(d.edit,function(a){e.error(f("Error creating highlight."))})}function x(a,b,c,d){var e="";if(a&&!b?e=f(d+" time is invalid!"):b&&!a&&(e=f(d+" date is invalid!")),""===e&&c){var g=new Date(c);_.isDate(g)?g.getTime()?g<_.now()&&("Embargo"!==d||q._isInProductionStates)&&(e=f(d+" cannot be earlier than now!")):e=f(d+" time is invalid!"):e=f(d+" is not a valid date!")}return e}function y(a){if(a.embargo&&a.publish_schedule)return e.error(f("An Item can't have both Embargo and Publish Schedule.")),!1;var b;if((a.embargo_date||a.embargo_time)&&(b=x(a.embargo_date,a.embargo_time,a.embargo,"Embargo"),""!==b))return e.error(b),!1;if(a.publish_schedule_date||a.publish_schedule_time){if(_.contains(["published","killed","corrected"],a.state))return!0;if(b=x(a.publish_schedule_date,a.publish_schedule_time,a.publish_schedule,"Publish Schedule"),""!==b)return e.error(b),!1}return!0}function z(a,b){var c="edit"===q.action?"publish":q.action;h.publish(a,b,c).then(function(a){if(a)if(angular.isDefined(a.data)&&angular.isDefined(a.data._issues)){if(angular.isDefined(a.data._issues["validator exception"])){for(var c=a.data._issues["validator exception"],g=c.replace(/\[/g,"").replace(/\]/g,"").split(","),i=0;i<g.length;i++)e.error(g[i]);(c.indexOf("9007")>=0||c.indexOf("9009")>=0)&&h.open(b._id,!0).then(function(a){q.origItem=a,q.dirty=!1,q.item=_.create(q.origItem)})}}else 412===a.status?A():(e.success(f("Item published.")),q.item=a,q.dirty=!1,d.close());else e.error(f("Unknown Error: Item not published."))})}function A(){e.error(f("Item has changed since it was opened. Please close and reopen the item to continue. Regrettably, your changes cannot be saved.")),q._editable=!1,q.dirty=!1}function B(){h.open(q.item._id,!0).then(function(a){q.origItem=a,q.dirty=!1,q.closePreview(),q.item._editable=q._editable})}var C;q.privileges=l.privileges,q.dirty=!1,q.views={send:!1},q.stage=null,q._editable=!!q.origItem._editable,q.isMediaType=_.contains(["audio","video","picture"],q.origItem.type),q.action=q.action||(q._editable?"edit":"view"),q.itemActions=h.itemActions(q.origItem),q.highlight=!!q.origItem.highlight,q.$watch("origItem",function(a,b){q.itemActions=null,a&&(q.itemActions=h.itemActions(a))},!0),q._isInProductionStates=!h.isPublished(q.origItem),q.origItem.sign_off=q.origItem.sign_off||q.origItem.version_creator,"kill"===q.action&&i("content_templates").getById("kill").then(function(a){a=_.pick(a,_.keys(w));var b=a.body_html;if(b){var c=_.words(b,/\${([\s\S]+?)}/g);c=_.map(c,function(a){return _.trim(a,"${} ")});var d=_.template(b),e={};_.each(c,function(a){e[a]="dateline"!==a?q.origItem[a]:q.origItem[a].text.toUpperCase()}),q.origItem.body_html=d(e)}_.each(a,function(a,b){_.isEmpty(a)||"body_html"!==b&&(q.origItem[b]=a)})}),q.$watch("item.marked_for_not_publication",function(a,b){if(a!==b){var c=_.create(q.origItem);q.dirty=!0,c.marked_for_not_publication=a,q.itemActions=h.itemActions(c)}}),q.proofread=!1,q.referrerUrl=o.getReferrerUrl(),q.origItem.task&&q.origItem.task.stage&&(i("stages").getById(q.origItem.task.stage).then(function(a){q.stage=a}),g.fetchDeskById(q.origItem.task.desk).then(function(a){q.deskName=a.name})),q.openStage=function(){g.setWorkspace(q.item.task.desk,q.item.task.stage),b.intent("view","content")},q.edit=function(){d.edit(q.origItem)},q.save=function(){return h.save(q.origItem,q.item).then(function(a){return q.origItem=a,q.dirty=!1,q.item=_.create(q.origItem),e.success(f("Item updated.")),q.origItem},function(a){angular.isDefined(a.data._issues)?angular.isDefined(a.data._issues.unique_name)&&1===a.data._issues.unique_name.unique?e.error(f("Error: Unique Name is not unique.")):angular.isDefined(a.data._issues["validator exception"])&&e.error(f("Error: "+a.data._issues["validator exception"])):412===a.status?A():e.error(f("Error. Item not updated."))})},q.exportHighlight=function(a){q.save_enabled()?t.confirm(f("You have unsaved changes, do you want to continue.")).then(function(){v(a._id)}):v(a._id)},q.publish=function(){if(y(q.item)){var a="publish";q.action&&"edit"!==q.action&&(a=q.action),q.dirty&&"publish"===a?h.publishConfirmation(q.origItem,q.item,q.dirty,a).then(function(a){a&&z(q.origItem,q.item)},function(a){e.error(f("Error. Item not published."))}):z(q.origItem,q.item)}},q.deschedule=function(){return q.item.publish_schedule=null,q.save()},q.close=function(){C=!0,h.close(q.item,q.origItem,q.save_enabled()).then(function(){d.close(q.item)})},q.closeOpenNew=function(a,b){C=!0,h.close(q.item,q.origItem,q.dirty,!0).then(function(){a(b)})},q.beforeSend=function(){return q.sending=!0,q.dirty?q.save().then(function(){return k.unlock(q.origItem)}):k.unlock(q.origItem)},q.preview=function(a){c(q.item,a),q._editable=!1},q.revert=function(a){return c(q.item,a),q.save()},q.closePreview=function(){q.item=_.create(q.origItem),a(q.item,q.item._autosave||{}),q._editable="view"!==q.action&&h.isEditable(q.origItem)},q.can_unlock=function(){return k.can_unlock(q.item)},q.save_enabled=function(){return q.dirty||q.item._autosave},q.unlock=function(){q.unlockClicked=!0,k.unlock(q.item).then(function(a){q.edit(a)})},q.openAction=function(a){"correct"===a?d.correct(q.item):"kill"===a&&d.kill(q.item)},q.isLockedByMe=function(){return k.isLockedByMe(q.item)},q.autosave=function(a){return q.dirty=!0,h.autosave(a)},q.content=m,q.closePreview(),q.$on("savework",function(a,b){var c=b;h.saveWorkConfirmation(q.origItem,q.item,q.dirty,c).then(function(a){g.setCurrentDeskId(null),n.url("/workspace/content"),o.setReferrerUrl("/workspace/content")})["finally"](function(){s.location.reload(!0)})}),q.$on("item:lock",function(a,b){q.item._id!==b.item||C||j.sessionId===b.lock_session||h.lock(q.item,b.user)}),q.$on("item:unlock",function(a,b){q.item._id!==b.item||C||j.sessionId===b.lock_session||(h.unlock(q.item,b.user),q._editable=q.item._editable=!1,q.origItem._locked=q.item._locked=!1,q.origItem.lock_session=q.item.lock_session=null,q.origItem.lock_user=q.item.lock_user=null)}),q.$on("item:updated",function(a,b){b.item===q.origItem._id&&"view"===q.action&&B()}),q.$on("item:publish:wrong:format",function(a,b){b.item===q.item._id&&e.error(f("No formatters found for ")+b.formats.join(",")+" while publishing item having story name "+b.unique_name)}),p.setupShortcuts(q)}}}function k(){return{templateUrl:"scripts/superdesk-authoring/views/authoring-topbar.html"}}function l(){return{link:function(a,b){var c=b.parent(),d=c.parent().width(),e=parseInt(b.css("margin-left"),10)+parseInt(b.css("margin-right"),10),f=c.outerWidth()+b.outerWidth()+e;d>f&&c.outerWidth(f)}}}function m(){return{scope:{item:"=",limit:"=",html:"@"},template:'<span class="char-count" ng-class="{error: numChars > limit}" translate>{{numChars}}/{{ limit }} characters </span>',link:function(a,b,c){a.html=a.html||!1,a.numChars=0,a.$watch("item",function(){var b=a.item||"";b=a.html?y(b):b,a.numChars=b.length||0})}}}function n(){return{scope:{item:"=",html:"@"},template:'<span class="char-count">{{numWords}} <span translate>words</span></span>',link:function(a,b,c){a.html=a.html||!1,a.numWords=0,a.$watch("item",function(){var b=a.item||"";b=a.html?y(b):b,a.numWords=_.compact(b.split(/\s+/)).length||0})}}}function o(a,b){var c={},d="editor:theme",e="default";return c.availableThemes=[{cssClass:"",label:"Default",key:"default"},{cssClass:"dark-theme",label:"Dark",key:"dark"},{cssClass:"natural-theme",label:"Natural",key:"natural"},{cssClass:"dark-blue-theme",label:"Dark blue",key:"dark-blue"},{cssClass:"dark-turquoise-theme",label:"Dark turquoise",key:"dark-turquoise"},{cssClass:"dark-khaki-theme",label:"Dark khaki",key:"dark-khaki"},{cssClass:"dark-theme-mono",label:"Dark monospace",key:"dark-mono"}],c.save=function(a,c){return b.get().then(function(e){return e[d][a]=c[a].key+(c.large[a]?"-large":""),b.update(e)})},c.get=function(a){return b.get().then(function(b){var c=b[d]&&b[d][a]?b[d][a]:e;return c})},c}function p(a){return{templateUrl:"scripts/superdesk-authoring/views/theme-select.html",scope:{key:"@"},link:function(b,c){function d(a){b.key===a&&c.closest(".page-content-container").children(".theme-container").attr("class",g).addClass(b[a].cssClass).addClass(b.large[a]&&"large-text")}function e(a){return-1!==a.indexOf("-large")?a.slice(0,a.indexOf("-large")):a}function f(a){return-1!==a.indexOf("-large")?!0:!1}var g="main-article theme-container";b.themes=a.availableThemes,b.large={},a.get("theme").then(function(c){var g=_.find(a.availableThemes,{key:e(c)});b.theme=g,b.large.theme=f(c),d("theme")}),a.get("proofreadTheme").then(function(c){var g=_.find(a.availableThemes,{key:e(c)});b.proofreadTheme=g,b.large.proofreadTheme=f(c),d("proofreadTheme")}),b.changeTheme=function(c,e){b[c]=e,a.save(c,b),d(c)},b.changeSize=function(c,e){b.large[c]=e,a.save(c,b),d(c)}}}}function q(a,b,c,d,e,f,g,h,i,j,k,l,m){return{scope:{item:"=",view:"=",_beforeSend:"=beforeSend",_editable:"=editable",_publish:"=publish",_action:"=action",mode:"@"},templateUrl:"scripts/superdesk-authoring/views/send-item.html",link:function(n,o,p){function q(a,b){a!==b&&(n.isActive=!!a,n.item=n.isActive?{}:null,n.config=a,s())}function r(a){"monitoring"===n.mode&&(f.flags.fetching=!!a),n.isActive=!!a,s()}function s(){n.isActive&&c.initialize().then(z).then(A).then(B).then(C)}function t(a){var b=n.selectedDesk._id,c=n.selectedStage._id||n.selectedDesk.incoming_stage;return"authoring"===n.mode?w(b,c,n.selectedMacro):"archive"===n.mode?x(b,c,n.selectedMacro,a):n.config?n.config.resolve({desk:b,stage:c,macro:n.selectedMacro?n.selectedMacro.name:null,open:a}):"ingest"===n.mode?y(b,c,n.selectedMacro,a):void 0}function u(){var a=n.selectedDesk._id,b=n.selectedStage._id||n.selectedDesk.incoming_stage;return n.item.more_coming=!0,w(a,b,n.selectedMacro,!0).then(function(){var a=null;return n.item.task&&n.item.task.desk&&(a=n.item.task.desk),j.linkItem(n.item,null,a)}).then(function(a){e.close(),d.success(gettext("New take created.")),e.edit(a)},function(a){d.error(gettext("Failed to send and continue."))})}function v(b,c){return c?h.call(c,b,!0):a.when(b)}function w(c,f,g,h){var i;return h&&(i=a.defer()),v(n.item,g).then(function(a){b.find("tasks",n.item._id).then(function(a){return n.task=a,n.beforeSend()}).then(function(a){return a&&a._etag&&(n.task._etag=a._etag),b.save("move",{},{task:{desk:c,stage:f}},n.item)}).then(function(a){return d.success(gettext("Item sent.")),h?i.resolve():void e.close()},function(a){return angular.isDefined(a.data._message)?d.error(a.data._message):angular.isDefined(a.data._issues["validator exception"])&&d.error(a.data._issues["validator exception"]),h?i.reject(a):void 0})}),h?i.promise:void 0}function x(a,c,e,f){var h;b.save("duplicate",{},{desk:n.item.task.desk},n.item).then(function(a){return b.find("archive",a._id)}).then(function(a){return v(a,e)}).then(function(a){return h=a,b.find("tasks",a._id)}).then(function(d){n.task=d,b.save("tasks",n.task,{task:_.extend(n.task.task,{desk:a,stage:c})})}).then(function(){d.success(gettext("Item sent.")),n.close(),f?g.url("/authoring/"+h._id):i.$broadcast("item:fetch")})}function y(a,b,c,f){return k.oneAs(n.item,{desk:a,stage:b,macro:c?c.name:c}).then(function(a){d.success(gettext("Item fetched.")),f?e.edit(a):i.$broadcast("item:fetch")})}function z(){var a=c.initialize().then(function(){n.desks=c.desks});return a="ingest"===n.mode?a.then(function(){n.selectDesk(c.getCurrentDesk())}):a.then(function(){var a=c.getItemDesk(n.item);a?n.selectDesk(a):n.selectDesk(c.getCurrentDesk())})}function A(){if(n.selectedDesk){n.stages=c.deskStages[n.selectedDesk._id];var a=null;n.item.task&&n.item.task.stage&&(a=_.find(n.stages,{_id:n.item.task.stage})),a||(a=_.find(n.stages,{_id:n.selectedDesk.incoming_stage})),n.selectedStage=a}}function B(){null!=n.selectedDesk&&h.getByDesk(n.selectedDesk.name).then(function(a){n.macros=a})}function C(){n.itemActions=j.itemActions(n.item)}n.mode=n.mode||"authoring",n.desks=null,n.stages=null,n.macros=null,n.task=null,n.selectedDesk=null,n.selectedStage=null,n.selectedMacro=null,n.beforeSend=n._beforeSend||a.when,n.$watch("item",r),n.$watch(k.getConfig,q),n.close=function(){"monitoring"===n.mode&&(f.flags.fetching=!1),n.$parent.views?n.$parent.views.send=!1:n.item=null,g.search("fetch",null),n.config&&n.config.reject()},n.selectDesk=function(a){n.selectedDesk=_.cloneDeep(a),n.selectedStage=null,A(),B()},n.selectStage=function(a){n.selectedStage=a},n.selectMacro=function(a){n.selectedMacro===a?n.selectedMacro=null:n.selectedMacro=a},n.send=function(a){var b=l.countErrors();return"authoring"===n.mode&&b>0?void m.confirmSpellcheck(b).then(angular.bind(this,function(){return t(a)}),function(a){return!1}):t(a)},n.showSendButtonAndDestination=function(){return n.itemActions?"ingest"===n.mode||"monitoring"===n.mode||"authoring"===n.mode&&n.isSendEnabled()&&n.itemActions.send:void 0},n.disableSendButton=function(){return n.item&&n.item.task?!n.selectedDesk||"ingest"!==n.mode&&n.selectedStage._id===n.item.task.stage:void 0},n.showPublishSchedule=function(){return"ingest"!==n.mode&&n.item&&"composite"!==n.item.type&&!n.item.embargo_date&&!n.item.embargo_time&&!j.isTakeItem(n.item)&&-1===["published","killed","corrected"].indexOf(n.item.state)},n.showEmbargo=function(){var a="ingest"!==n.mode&&n.item&&"composite"!==n.item.type&&!n.item.publish_schedule_date&&!n.item.publish_schedule_time&&!j.isTakeItem(n.item);return a&&j.isPublished(n.item)?n.item.embargo:a},n.isEmbargoEditable=function(){return n.item&&n.item._editable&&!j.isPublished(n.item)},n.canSendAndContinue=function(){return!j.isPublished(n.item)&&_.contains(["text","preformatted"],n.item.type)},n.isSendEnabled=function(){return!j.isPublished(n.item)},n.sendAndContinue=function(){if(n.item&&n.item.publish_schedule)return void d.error(gettext("Takes cannot be scheduled."));if(n.item&&n.item.embargo)return void d.error(gettext("Takes cannot have Embargo."));var a=l.countErrors();return a>0?void m.confirmSpellcheck(a).then(angular.bind(this,function(){return u()}),function(a){return!1}):u()}}}}function r(a,b,c,d,e,f,g,h,i){return{templateUrl:"scripts/superdesk-authoring/views/article-edit.html",link:function(d){var f=4/3;d.limits=b.limits,d.toggleDetails=!0,d.errorMessage=null;var h=d.$parent.$parent;d.monthNames={Jan:"0",Feb:"1",Mar:"2",Apr:"3",May:"4",Jun:"5",Jul:"6",Aug:"7",Sept:"8",Oct:"9",Nov:"10",Dec:"11"},d.datelineMonth="",d.datelineDay="",d.$watch("item",function(a){if(a){var b={dateline:{source:a.dateline.source,date:a.dateline.date,located:a.dateline.located,text:a.dateline.text}};if(a.dateline.located){var c=e("formatDatelineToMMDD")(a.dateline.date,a.dateline.located);d.datelineMonth=c.month,d.datelineDay=c.day,d.resetNumberOfDays(!1)}_.extend(a,b)}}),c.initialize().then(function(){d.metadata=c.values}),d.updateDateline=function(a,b){if(""===b)a.dateline.located=null,a.dateline.text="",d.datelineMonth="",d.datelineDay="";else{var c=e("formatDatelineToMMDD")(a.dateline.date,a.dateline.located);d.datelineMonth=c.month,d.datelineDay=c.day,d.resetNumberOfDays(!1),a.dateline.text=e("formatDatelineToLocMMMDDSrc")(a.dateline.located,_.findKey(d.monthNames,function(a){return a===d.datelineMonth}),d.datelineDay,a.dateline.source)}},d.resetNumberOfDays=function(a){""!==d.datelineMonth?(d.daysInMonth=e("daysInAMonth")(parseInt(d.datelineMonth)),a&&d.modifyDatelineDate()):(d.daysInMonth=[],d.datelineDay="")},d.modifyDatelineDate=function(){""!==d.datelineMonth&&""!==d.datelineDay&&(d.item.dateline.date=e("relativeUTCTimestamp")(d.item.dateline.located,parseInt(d.datelineMonth),parseInt(d.datelineDay)),d.item.dateline.text=e("formatDatelineToLocMMMDDSrc")(d.item.dateline.located,_.findKey(d.monthNames,function(a){return a===d.datelineMonth}),d.datelineDay,d.item.dateline.source),a.save(d.item))},d.evalAspectRatio=function(a){var b=a.split("-").map(_.partial(parseInt,_,10)),c=b[0]/b[1];return isNaN(c)||!isFinite(c)?(d.errorMessage="Error: Given Aspect ratio was not valid, using default: "+f,f):(d.errorMessage=null,c)},d.applyCrop=function(){var a={};d.item.cropsizes=d.metadata.crop_sizes,_.forEach(d.item.cropsizes,function(b){a={aspectRatio:d.evalAspectRatio(b.name)},_.extend(_.filter(d.item.cropsizes,{name:b.name})[0],a)}),g.intent("edit","crop",d.item).then(function(a){h.dirty||(h.dirty=a.isDirty);var b=_.create(a.renditions),c=a.cropData;d.item.renditions=_.merge(b,c)})}}}}function s(a,b){function c(){var a=this;this.state={},this.edit=function(b,c){a.item=b,a.action=c,a.state.opened=!!b}}return{controller:c,controllerAs:"authoring",templateUrl:"scripts/superdesk-authoring/views/authoring-container.html",scope:{},require:"sdAuthoringContainer",link:function(a,c,d,e){a.$watch(b.getState,function(b){b&&(e.edit(null,null),a.$applyAsync(function(){e.edit(b.item,b.action)}))})}}}function t(){return{templateUrl:"scripts/superdesk-authoring/views/authoring.html",scope:{origItem:"=item",action:"="}}}function u(a,b,c,d){return{templateUrl:"scripts/superdesk-authoring/views/header-info.html",require:"^sdAuthoringWidgets",link:function(c,e,f,g){c.$watch("item",function(e){if(e&&(c.loaded=!0,!d.isLegal(c.item))){a.fetchItems(c.item.family_id||c.item._id,c.item).then(function(a){c.relatedItems=a});var f=_.filter(b,function(a){return"related-item"===a._id});c.activateWidget=function(){g.activate(f[0])}}})}}}function v(a,b,c){function d(){a.search("item",g.item?g.item._id:null),a.search("action",g.action),b.flags.authoring=!!g.item,g.state={item:g.item,action:g.action}}function e(){a.search().item&&a.search().action in g&&f(a.search().item,a.search().action)}function f(a,b){return c.open(a,"view"===b).then(function(a){g.item=a,g.action=b}).then(d)}this.item=null,this.action=null,this.state=null;var g=this;this.edit=function(a,b){a?f(a._id,b||"edit"):g.close()},this.view=function(a){c.setItemVersion(a._current_version),g.edit(a,"view")},this.close=function(){g.item=null,g.action=null,d()},this.kill=function(a){g.edit(a,"kill")},this.correct=function(a){g.edit(a,"correct")},this.getItem=function(){return g.item},this.getAction=function(){return g.action},this.getState=function(){return g.state},e()}var w=Object.freeze({headline:"",slugline:"",body_html:null,"abstract":null,anpa_take_key:null,byline:null,urgency:null,priority:null,subject:[],anpa_category:[],genre:[],groups:[],usageterms:null,ednote:null,place:[],located:null,dateline:null,language:null,unique_name:"",keywords:[],description:null,sign_off:null,publish_schedule:null,marked_for_not_publication:!1,pubstatus:null,more_coming:!1,targeted_for:[],embargo:null,renditions:null}),x=Object.freeze({publish:!1,correct:!1,kill:!1,deschedule:!1,new_take:!1,re_write:!1,save:!1,edit:!1,mark_item:!1,duplicate:!1,copy:!1,view:!0,spike:!1,unspike:!1,package_item:!1,multi_edit:!1,send:!1});d.$inject=["$q","$timeout","api"],e.$inject=["$q","api","lock","autosave","confirm","privileges","desks"],f.$inject=["$q","api","session","privileges","notify"],g.$inject=["$window","$q","$filter","api","modal","gettext","$interpolate"],h.$inject=["$scope","gettext","notify","modal","$q"],i.$inject=["$scope","item","action","superdesk"],j.$inject=["superdesk","authoringWorkspace","notify","gettext","desks","authoring","api","session","lock","privileges","content","$location","referrer","macros","$timeout","$q","$window","modal"];var y=function(a){return a.replace(/<br[^>]*>/gi,"&nbsp;").replace(/<\/?[^>]+><\/?[^>]+>/gi," ").replace(/<\/?[^>]+>/gi,"").trim().replace(/&nbsp;/g," ")};m.$inject=[],n.$inject=[],o.$inject=["storage","preferencesService"],p.$inject=["authThemes"],q.$inject=["$q","api","desks","notify","authoringWorkspace","superdeskFlags","$location","macros","$rootScope","authoring","send","spellcheck","confirm"],r.$inject=["autosave","authoring","metadata","session","$filter","$timeout","superdesk","notify","gettext"],angular.module("superdesk.authoring",["superdesk.menu","superdesk.editor","superdesk.activity","superdesk.authoring.widgets","superdesk.authoring.metadata","superdesk.authoring.comments","superdesk.authoring.versioning","superdesk.authoring.versioning.versions","superdesk.authoring.versioning.history","superdesk.authoring.workqueue","superdesk.authoring.packages","superdesk.authoring.find-replace","superdesk.authoring.macros","superdesk.desks"]).service("authoring",e).service("autosave",d).service("confirm",g).service("lock",f).service("authThemes",o).service("authoringWorkspace",v).directive("sdDashboardCard",l).directive("sdSendItem",q).directive("sdCharacterCount",m).directive("sdWordCount",n).directive("sdThemeSelect",p).directive("sdArticleEdit",r).directive("sdAuthoring",j).directive("sdAuthoringTopbar",k).directive("sdAuthoringContainer",s).directive("sdAuthoringEmbedded",t).directive("sdHeaderInfo",u).config(["superdeskProvider",function(a){a.activity("authoring",{category:"/authoring",href:"/authoring/:_id",when:"/authoring/:_id",label:gettext("Authoring"),templateUrl:"scripts/superdesk-authoring/views/authoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:i,filters:[{action:"author",type:"article"}],resolve:{item:["$route","authoring",function(a,b){return b.open(a.current.params._id,!1)}],action:[function(){return"edit"}]},authoring:!0}).activity("edit.item",{label:gettext("Edit"),priority:10,icon:"pencil",controller:["data","authoringWorkspace",function(a,b){b.edit(a.item?a.item:a)}],filters:[{action:"list",type:"archive"},{action:"edit",type:"item"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).edit}]}).activity("kill.text",{label:gettext("Kill item"),priority:100,icon:"remove",group:"corrections",controller:["data","authoringWorkspace",function(a,b){b.kill(a.item)}],filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).kill}],privileges:{kill:1}}).activity("correct.text",{label:gettext("Correct item"),priority:100,icon:"pencil",group:"corrections",controller:["data","authoringWorkspace",function(a,b){b.correct(a.item)}],filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).correct}],privileges:{correct:1}}).activity("view.item",{label:gettext("Open"),priority:2e3,icon:"fullscreen",controller:["data","authoringWorkspace",function(a,b){b.view(a.item||a)}],filters:[{action:"list",type:"archive"},{action:"list",type:"legal_archive"},{action:"view",type:"item"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).view}]}).activity("edit.crop",{label:gettext("EDIT CROP"),modal:!0,cssClass:"upload-avatar modal-static modal-responsive",controller:h,templateUrl:"scripts/superdesk-authoring/views/change-image.html",filters:[{action:"edit",type:"crop"}]})}]).config(["apiProvider",function(a){a.api("move",{type:"http",backend:{rel:"move"}})}]),s.$inject=["authoring","authoringWorkspace"],t.$inject=[],u.$inject=["familyService","authoringWidgets","authoring","archiveService"],v.$inject=["$location","superdeskFlags","authoring"]}(),function(){"use strict";function a(){var a=[];this.widget=function(b,c){a.push(angular.extend({},c,{_id:b}))},this.$get=function(){return a}}function b(a,b,c,d){a.active=null,a.$watch("item",function(b){if(!b)return void(a.widgets=null);var e;e=d.isLegal(b)?"legalArchive":"composite"===b.type?"packages":"authoring",a.widgets=c.filter(function(a){return!!a.display[e]})}),a.isLocked=function(b){return b.needUnlock&&a.item._locked||b.needEditable&&!a.item._editable},a.activate=function(b){a.isLocked(b)||(a.active=a.active===b?null:b)},this.activate=function(b){a.activate(b)},a.closeWidget=function(b){a.active=null},angular.forEach(a.widgets,function(c){b[c._id]&&a.activate(c)}),a.$watch("item._locked",function(){if(a.active){var b=a.active;a.closeWidget(b),a.activate(b)}})}function c(){return{controller:b,templateUrl:"scripts/superdesk-authoring/widgets/views/authoring-widgets.html",transclude:!0}}b.$inject=["$scope","$routeParams","authoringWidgets","archiveService"],angular.module("superdesk.authoring.widgets",[]).provider("authoringWidgets",a).directive("sdAuthoringWidgets",c)}(),function(){"use strict";function a(a){this.comments=null,this.fetch=function(b){var c={where:{item:b},embedded:{user:1}};return a.item_comments.query(c).then(angular.bind(this,function(a){this.comments=a._items}))},this.save=function(b){return a.item_comments.save(b)}}function b(a,b,c,e,f){function g(){a.item&&c.fetch(a.item._id).then(function(){a.comments=c.comments})}function h(){a.active=b.comments||null}a.text=null,a.saveEnterFlag=!1,a.$watch("item._id",g),a.users=[],a.saveOnEnter=function(b){a.saveEnterFlag&&b.keyCode===d&&!b.shiftKey&&a.save()},a.save=function(){var b=a.text||"";b.length&&(a.text="",a.flags={saving:!0},c.save({text:b,item:a.item._id}).then(g))},a.cancel=function(){a.text=""},a.$on("item:comment",function(b,c){c.item===a.item.guid&&g()}),a.$on("$locationChangeSuccess",h),h()}function c(a){return{scope:{comment:"="},link:function(b,c,d){var e;e=d.text.replace(/(?:\r\n|\r|\n)/g,"</p><p>");var f=e.match(/\@([a-zA-Z0-9-_.]\w+)/g);_.each(f,function(a){var c=a.substring(1,a.length);b.comment.mentioned_users&&b.comment.mentioned_users[c]&&(e=e.replace(a,'<i sd-user-info data-user="'+b.comment.mentioned_users[c]+'">'+a+"</i>"))}),c.html("<p><b>"+d.name+"</b> : "+e+"</p>"),a(c.contents())(b)}}}var d=13;a.$inject=["api"],b.$inject=["$scope","$routeParams","commentsService","api","$q"],c.$inject=["$compile"],angular.module("superdesk.authoring.comments",["superdesk.authoring.widgets","mentio","superdesk.api"]).config(["authoringWidgetsProvider",function(a){a.widget("comments",{icon:"comments",label:gettext("Comments"),template:"scripts/superdesk-authoring/comments/views/comments-widget.html",order:3,side:"right",display:{authoring:!0,packages:!0,legalArchive:!1}})}]).config(["apiProvider",function(a){a.api("item_comments",{type:"http",backend:{rel:"item_comments"}})}]).controller("CommentsWidgetCtrl",b).service("commentsService",a).directive("sdCommentText",c)}(),function(){"use strict";angular.module("superdesk.authoring.versioning",[]).config(["authoringWidgetsProvider",function(a){a.widget("versioning",{icon:"revision",label:gettext("Versioning"),removeHeader:!0,template:"scripts/superdesk-authoring/versioning/views/versioning.html",order:4,side:"right",display:{authoring:!0,packages:!0,legalArchive:!0}})}])}(),function(){"use strict";function a(a,b,c,d,e,f,g){function h(){f.initialize().then(function(){a.desks=f.desks,a.stages=f.deskStages,a.users=f.users,g.getVersionHistory(a.item,f,"versions").then(function(c){a.versions=c,a.last=g.lastVersion(a.item,a.versions),g.isLegal(a.item)?(a.canRevert=!1,a.openVersion(a.last)):(a.canRevert=b.isEditable(a.item)&&!b.isPublished(a.item),a.item._autosave?a.selected=a.item._autosave:a.openVersion(a.last))})})}a.last=null,a.versions=null,a.selected=null,a.users=null,a.canRevert=!1,a.desks=null,a.stages=null,a.openAutosave=function(){
a.selected=a.item._autosave,a.closePreview()},a.openVersion=function(b){a.selected=b,b!==a.last||a.item._autosave?a.preview(b):a.closePreview()},a.revert=function(b){a.$parent.revert(b).then(h)},a.$watchGroup(["item._id","item._latest_version"],h)}function b(){return{templateUrl:"scripts/superdesk-authoring/versioning/versions/views/versions.html"}}a.$inject=["$scope","authoring","api","notify","lock","desks","archiveService"],b.$inject=[],angular.module("superdesk.authoring.versioning.versions",[]).directive("sdVersioningVersion",b).controller("VersioningWidgetCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e,f){function g(){e.initialize().then(function(){a.desks=e.desks,a.stages=e.deskStages,a.users=e.users,f.getVersionHistory(a.item,e,"operations").then(function(c){a.versions=c,a.last=f.lastVersion(a.item,a.versions),f.isLegal(a.item)?(a.canRevert=!1,a.openVersion(a.last)):(a.canRevert=b.isEditable(a.item)&&!b.isPublished(a.item),a.item._autosave?a.selected=a.item._autosave:a.openVersion(a.last))})})}a.last=null,a.versions=null,a.selected=null,a.users=null,a.desks=null,a.stages=null,a.openVersion=function(b){a.selected=b,b!==a.last||a.item._autosave?a.preview(b):a.closePreview()},a.$watchGroup(["item._id","item._latest_version"],g)}function b(){return{templateUrl:"scripts/superdesk-authoring/versioning/history/views/history.html"}}function c(a,b){return{templateUrl:"scripts/superdesk-authoring/versioning/history/views/publish_queue.html",scope:{item:"="},link:function(c){c.transmitted_item=null,c.show_transmission_details=!1,c.showFormattedItem=function(a){c.transmitted_item=a.formatted_item},c.hideFormattedItem=function(){c.transmitted_item=null},c.showOrHideTransmissionDetails=function(){if(c.show_transmission_details=!c.show_transmission_details,c.show_transmission_details){var d={max_results:20};d.where=JSON.stringify({$and:[{item_id:c.item._id},{item_version:c.item._current_version}]});var e;e=b.isLegal(c.item)?a.legal_publish_queue.query(d):a.publish_queue.query(d),e.then(function(a){_.each(a._items,function(a){angular.isUndefined(a.completed_at)&&(a.completed_at=a._updated)}),c.queuedItems=a._items})}}}}}a.$inject=["$scope","authoring","api","notify","desks","archiveService"],b.$inject=[],c.$inject=["api","archiveService"],angular.module("superdesk.authoring.versioning.history",[]).directive("sdVersioningHistory",b).directive("sdTransmissionDetails",c).controller("HistoryWidgetCtrl",a)}(),function(){"use strict";function a(a,b,c,d,e,f,g,h){function i(b){var d,e,f,g,h={};d=c.values.categories||[],g=b["categories:preferred"].selected||{},f=a.item.anpa_category||[],f.forEach(function(a){h[a.qcode]=!0}),e=_.filter(d,function(a){return g[a.qcode]||h[a.qcode]}),a.availableCategories=e}function j(b,c){b!==c&&(a.item.publish_schedule_date&&a.item.publish_schedule_time?a.item.publish_schedule=f.mergeDateTime(a.item.publish_schedule_date,a.item.publish_schedule_time).format():a.item.publish_schedule=null,a.autosave(a.item))}function k(b,c){b!==c&&(a.item.embargo_date&&a.item.embargo_time?a.item.embargo=f.mergeDateTime(a.item.embargo_date,a.item.embargo_time).format():a.item.embargo=null,a.autosave(a.item))}function l(){if(a.item.embargo){var b=new Date(Date.parse(a.item.embargo));a.item.embargo_date=d("formatDateTimeString")(b,"MM/DD/YYYY"),a.item.embargo_time=d("formatDateTimeString")(b,"HH:mm:ss")}if(a.item.publish_schedule){var c=new Date(Date.parse(a.item.publish_schedule));a.item.publish_schedule_date=d("formatDateTimeString")(c,"MM/DD/YYYY"),a.item.publish_schedule_time=d("formatDateTimeString")(c,"HH:mm:ss")}}b.initialize().then(function(){a.deskLookup=b.deskLookup,a.userLookup=b.userLookup}),c.initialize().then(function(){return a.metadata=c.values,null!=a.item.related_to&&c.fetchAssociated(a.item.related_to).then(function(b){a.associatedItem=b}),g.get()}).then(i),a.processGenre=function(){a.item.genre=_.map(a.item.genre,function(a){return _.pick(a,"name")})},a.disableAddingTargetedFor=function(){return!a.item._editable||angular.isUndefined(a.item.targeted_for_value)||""===a.item.targeted_for_value},a.addTargeted=function(){if(angular.isUndefined(a.item.targeted_for)&&(a.item.targeted_for=[]),!angular.isUndefined(a.item.targeted_for_value)&&""!==a.item.targeted_for_value){var b={name:a.item.targeted_for_value};angular.isUndefined(_.find(a.item.targeted_for,b))&&(b.allow=angular.isUndefined(a.item.negation)?!0:!a.item.negation,a.item.targeted_for.push(b),a.autosave(a.item))}},a.removeTargeted=function(b){angular.isDefined(_.find(a.item.targeted_for,b))&&(a.item.targeted_for=_.without(a.item.targeted_for,b),a.autosave(a.item))},a.$watch("item.publish_schedule_date",function(a,b){j(a,b)}),a.$watch("item.publish_schedule_time",function(a,b){j(a,b)}),a.$watch("item.embargo_date",function(a,b){k(a,b)}),a.$watch("item.embargo_time",function(a,b){k(a,b)}),a.unique_name_editable=Boolean(e.privileges.metadata_uniquename),l()}function b(){return{scope:{list:"=",disabled:"=ngDisabled",item:"=",field:"@",icon:"@",label:"@",change:"&"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-dropdown.html",link:function(a){a.select=function(b){var c={};angular.isDefined(b)?c[a.field]="place"===a.field?[b]:b.name:c[a.field]=null,_.extend(a.item,c),a.change({item:a.item})}}}}function c(){return{scope:{item:"=",field:"@",disabled:"=",list:"=",change:"&"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-words-list.html",link:function(a){var b=13;a.selectTerm=function(c){if(c.keyCode===b&&""!==_.trim(a.term)){var d=_.clone(a.item[a.field])||[],e=_.findIndex(d,function(b){return b.toLowerCase()===a.term.toLowerCase()});if(0>e){d.push(_.trim(a.term));var f={};f[a.field]=d,_.extend(a.item,f),a.change({item:a.item})}a.term=""}},a.removeTerm=function(b){var c=_.without(a.item[a.field],b),d={};d[a.field]=c,_.extend(a.item,d),a.change({item:a.item})}}}}function d(a){return{scope:{item:"=",field:"@",disabled:"=ngDisabled",list:"=",unique:"@",postprocessing:"&",change:"&",header:"@"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-terms.html",link:function(b){a.subjectScope=b,b.$watch("list",function(a){if(a&&0!==a.length){var c={};angular.forEach(a,function(a){c.hasOwnProperty(a.parent)?c[a.parent].push(a):c[a.parent]=[a]}),b.terms=a,b.tree=c,b.activeTree=c[null]}}),b.$on("$destroy",function(){a.subjectScope=null}),b.openParent=function(a,c){var d=_.find(b.list,{qcode:a.parent});b.openTree(d,c)},b.openTree=function(a,c){b.activeTerm=a,b.activeTree=b.tree[a?a.qcode:null],c.stopPropagation()},b.activeList=!1,b.selectedTerm="";var c=b.unique||"qcode";b.searchTerms=function(a){return a?b.terms=_.filter(b.list,function(d){var e={};return e[c]=d[c],b.activeList=!0,-1!==d.name.toLowerCase().indexOf(a.toLowerCase())&&!_.find(b.item[b.field],e)}):(b.terms=b.list,b.activeList=!1),b.terms},b.selectTerm=function(a){if(a){var c=_.clone(b.item[b.field])||[];c.push(a);var d={};d[b.field]=c,_.extend(b.item,d),b.selectedTerm="",b.postprocessing(),b.change({item:b.item})}},b.removeTerm=function(a){var c={},d=b.item[b.field],e=_.without(d,a);d&&e.length===d.length&&_.remove(e,{name:a}),c[b.field]=e,_.extend(b.item,c),b.change({item:b.item})}}}}function e(a){return{scope:{item:"=",fieldprefix:"@",field:"@",disabled:"=ngDisabled",list:"=",change:"&",postprocessing:"&",header:"@"},templateUrl:"scripts/superdesk-authoring/metadata/views/metadata-locators.html",link:function(b,c){b.selectedTerm="",a(function(){b.item&&(b.fieldprefix&&b.item[b.fieldprefix][b.field]?b.selectedTerm=b.item[b.fieldprefix][b.field].city:b.item[b.field]&&(b.selectedTerm=b.item[b.field].city)),b.list&&(b.locators=b.list)}),b.searchLocator=function(a){return a?b.locators=_.filter(b.list,function(b){return-1!==b.city.toLowerCase().indexOf(a.toLowerCase())}):b.locators=b.list,b.selectedTerm=a,b.locators},b.selectLocator=function(a){var c={};if(!a&&b.selectedTerm){var d=b.fieldprefix?b.item[b.fieldprefix][b.field]:b.item[b.field];a=b.selectedTerm===d.city?d:{city:b.selectedTerm,city_code:b.selectedTerm,tz:"UTC",dateline:"city",country:"",country_code:"",state_code:"",state:""}}a&&(angular.isDefined(b.fieldprefix)?(c[b.fieldprefix]=b.item[b.fieldprefix],c[b.fieldprefix][b.field]=a):c[b.field]=a,b.selectedTerm=a.city,_.extend(b.item,c));var e={item:b.item,city:b.selectedTerm};b.postprocessing(e),b.change(e)}}}}function f(a,b){var c={values:{},subjectScope:null,loaded:null,fetchMetadataValues:function(){var b=this;return a("vocabularies").query().then(function(a){_.each(a._items,function(a){b.values[a._id]=a.items}),b.values.targeted_for=_.union(b.values.geographical_restrictions,b.values.subscriber_types)})},fetchSubjectcodes:function(b){var c=this;return a.get("/subjectcodes").then(function(a){c.values.subjectcodes=a._items})},fetchAssociated:function(b){return null!=b?a("archive").getById(b).then(function(a){return a}):void 0},removeSubjectTerm:function(a){var b=this,c={},d=b.subjectScope.item[b.subjectScope.field],e=_.without(d,a);e.length===d.length&&_.remove(e,{name:a}),c[b.subjectScope.field]=e,_.extend(b.subjectScope.item,c),b.subjectScope.change({item:b.subjectScope.item})},fetchCities:function(){var b=this;return a.get("/cities").then(function(a){b.values.cities=a._items})},initialize:function(){return this.loaded||(this.loaded=this.fetchMetadataValues().then(angular.bind(this,this.fetchSubjectcodes)).then(angular.bind(this,this.fetchCities))),this.loaded}};return c}a.$inject=["$scope","desks","metadata","$filter","privileges","datetimeHelper","preferencesService","archiveService"],b.$inject=[],c.$inject=[],d.$inject=["metadata"],e.$inject=["$timeout"],f.$inject=["api","$q"],angular.module("superdesk.authoring.metadata",["superdesk.authoring.widgets"]).config(["authoringWidgetsProvider",function(a){a.widget("metadata",{icon:"info",label:gettext("Info"),removeHeader:!0,template:"scripts/superdesk-authoring/metadata/views/metadata-widget.html",order:1,side:"right",display:{authoring:!0,packages:!0,legalArchive:!0}})}]).controller("MetadataWidgetCtrl",a).service("metadata",f).directive("sdMetaTerms",d).directive("sdMetaDropdown",b).directive("sdMetaWordsList",c).directive("sdMetaLocators",e)}(),function(){"use strict";function a(a,b){this.items=[],this.fetch=function(){return a.getIdentity().then(angular.bind(this,function(a){return b.query("archive",{source:{filter:{term:{lock_user:a._id}}}}).then(angular.bind(this,function(a){return this.items=null,this.items=a._items||[],this.items}))}))},this.updateItem=function(a){var c=_.find(this.items,{_id:a});return c?b.find("archive",a).then(function(a){return angular.extend(c,a)}):void 0}}function b(a,b,c,d,e,f,g,h){function i(){c.fetch().then(function(){var d=b.current||{_id:null,params:{}};a.isMultiedit="multiedit"===d._id,a.active=null,d.params.item&&(a.active=_.find(c.items,{_id:d.params.item}))})}a.active=null,a.workqueue=c,a.multiEdit=e,a.$on("item:lock",i),a.$on("item:unlock",i),a.$on("media_archive",function(a,b){c.updateItem(b.item)}),i(),a.openDashboard=function(){f.intent("author","dashboard")},a.closeItem=function(b){g.unlock(b),d.item&&b._id===d.item._id&&d.close(),e.items=_.without(e.items,_.find(e.items,{article:b._id})),0===e.items.length&&a.redirectOnCloseMulti()},a.openMulti=function(){a.isMultiedit=!0,i(),e.open()},a.closeMulti=function(){e.exit(),a.redirectOnCloseMulti()},a.redirectOnCloseMulti=function(){this.isMultiedit&&(this.isMultiedit=!1,h.url("/workspace/monitoring"))}}function c(a,b,c){return{templateUrl:"scripts/superdesk-authoring/views/opened-articles.html",controller:"Workqueue",scope:{},link:function(c){c.edit=function(a,d){d.ctrlKey||(c.active=a,b.edit(a),c.redirectOnCloseMulti(),d.preventDefault())},c.link=function(b){return b?a.link("authoring",b):void 0}}}}function d(){return{templateUrl:"scripts/superdesk-authoring/views/dashboard-articles.html",controller:"Workqueue"}}a.$inject=["session","api"],b.$inject=["$scope","$route","workqueue","authoringWorkspace","multiEdit","superdesk","lock","$location"],c.$inject=["$rootScope","authoringWorkspace","$location"],angular.module("superdesk.authoring.workqueue",["superdesk.activity","superdesk.notification","superdesk.authoring.multiedit"]).service("workqueue",a).controller("Workqueue",b).directive("sdWorkqueue",c).directive("sdDashboardArticles",d)}(),function(){"use strict";function a(a,b,c,d,e){function f(){var b=e.query();b.clear_filters();var c=[];_.forEach(a.item.linked_in_packages,function(a){c.push(a["package"])}),b.size(25).filter({terms:{guid:c}}),d.archive.query(b.getCriteria(!0)).then(function(b){a.contentItems=b._items})}a.contentItems=[],a.openPackage=function(a){c.intent("edit","item",a)},a.item&&a.item.linked_in_packages&&a.item.linked_in_packages.length>0&&f()}return a.$inject=["$scope","$location","superdesk","api","search"],angular.module("superdesk.authoring.packages",["superdesk.authoring.widgets"]).config(["authoringWidgetsProvider",function(a){a.widget("packages",{icon:"package",label:gettext("Packages"),template:"scripts/superdesk-authoring/packages/views/packages-widget.html",order:5,side:"right",display:{authoring:!0,packages:!0,legalArchive:!1}})}]).controller("PackagesWidgetCtrl",a)}(),function(){"use strict";function a(a,b,c){return{link:function(a,b){a.to="",a.from="",a.next=function(){c.selectNext()},a.prev=function(){c.selectPrev()},a.replace=function(){c.replace(a.to||""),c.selectNext()},a.replaceAll=function(){c.replaceAll(a.to||"")},a.$watch("from",function(a){var b=document.getElementById("find-replace-what"),d=b.selectionStart,e=b.selectionEnd;c.setSettings({findreplace:{needle:a}}),c.render(),c.selectNext(),b.setSelectionRange(d,e)}),a.$on("$destroy",function(){c.setSettings({findreplace:null}),c.render()})}}}a.$inject=["$timeout","$rootScope","editor"],angular.module("superdesk.authoring.find-replace",["superdesk.editor","superdesk.authoring.widgets"]).directive("sdFindReplace",a).config(["authoringWidgetsProvider",function(a){a.widget("find-replace",{icon:"find-replace",label:gettext("Find and Replace"),template:"scripts/superdesk-authoring/editor/views/find-replace.html",order:2,side:"right",needUnlock:!0,display:{authoring:!0,packages:!1,legalArchive:!1}})}])}(),function(){"use strict";function a(a,b,c){function d(a){return{article:a}}var e=2,f="multiedit",g=a.getItem(f);this.items=null===g?[]:g,this.minBoards=function(){return e},this.create=function(a){var b=this;if(b.items=[],a&&_.each(a,function(a){b.items.push(d(a))}),b.items.length<e)for(var c=0;c<e-b.items.length;c++)b.items.push(d(null));b.updateItems(),b.open()},this.exit=function(a){this.items=[],this.updateItems()},this.open=function(){c.getState()&&c.close(),b.intent("author","multiedit")},this.updateItems=function(){a.setItem(f,this.items)},this.edit=function(a,b){this.items[b]?this.items[b].article=a:this.items[b]=d(a),this.updateItems()},this.remove=function(a){_.extend(_.find(this.items,{article:a}),{article:null}),this.updateItems()},this.close=function(a){this.items.length>e&&(this.items.splice(a,1),this.updateItems())}}function b(a,b,c,d,e){a.$watch(function(){return b.items},function(b){a.boards=b}),a.minBoards=b.minBoards(),a.closeBoard=function(a){b.close(a)},a.closeMulti=function(){b.exit(),c.url("/workspace/monitoring")}}function c(a,b,c){return{templateUrl:"scripts/superdesk-authoring/multiedit/views/sd-multiedit-dropdown.html",link:function(d){d.current=c.current.params.item,d.queue=[d.current],d.$watch(function(){return a.items},function(a){d.items=a}),d.toggle=function(a){return a===d.current?!1:void(d.selected(a)?d.queue=_.without(d.queue,a):d.queue.push(a))},d.selected=function(a){return-1!==_.indexOf(d.queue,a)},d.open=function(){b.create(d.queue)}}}}function d(a,b){return{templateUrl:"scripts/superdesk-authoring/multiedit/views/sd-multiedit-inner-dropdown.html",link:function(c,d,e){function f(){c.items=_.filter(g,function(a){return-1===_.indexOf(h,a._id)})}var g=[],h=[];c.$watch(function(){return b.items},function(a){h=_.map(b.items,function(a){return a.article}),f()},!0),c.$watch(function(){return a.items},function(a){g=a,f()}),c.open=function(a){b.edit(a,e.board)}}}}function e(a,b,c){return{templateUrl:"scripts/superdesk-authoring/multiedit/views/sd-multiedit-article.html",scope:{article:"=",focus:"="},link:function(d,e){function f(){a.open(d.article).then(function(b){d.origItem=b,d.item=_.create(b),d._editable=a.isEditable(b),d.isMediaType=_.contains(["audio","video","picture"],d.item.type),d.focus&&c(function(){e.children().focus()},0,!1)})}d.$watch("article",function(a,b){a&&a!==b&&f()}),f(),d.autosave=function(b){d.dirty=!0,a.autosave(b)},d.save=function(b,c){return a.save(d.origItem,b).then(function(a){return c&&c.$setPristine(),a})},d.remove=function(a){b.remove(a._id)}}}}function f(a){return{link:function(b,c){function d(){f=!1,$("#multiedit-float").hide()}function e(b,c){var d=a.height(),e=a.width(),f={right:e-b};return 400>d-c?(f.bottom=d-c,f.top="auto"):(f.top=c,f.bottom="auto"),f}var f=!1;c.bind("click",function(a){f?$("#multiedit-float").hide():(a.preventDefault(),a.stopPropagation(),$("#multiedit-float").css(e(a.pageX,a.pageY)).show()),f=!f}),a.bind("click",d),b.$on("$destroy",function(){a.unbind("click",d)})}}}a.$inject=["storage","superdesk","authoringWorkspace"],b.$inject=["$scope","multiEdit","$location","lock","workqueue"],c.$inject=["workqueue","multiEdit","$route"],d.$inject=["workqueue","multiEdit"],e.$inject=["authoring","multiEdit","$timeout"],f.$inject=["$document"],angular.module("superdesk.authoring.multiedit",["superdesk.activity","superdesk.authoring"]).service("multiEdit",a).directive("sdMultieditDropdown",c).directive("sdMultieditInnerDropdown",d).directive("sdMultieditArticle",e).directive("sdMultieditFloatMenu",f).config(["superdeskProvider",function(a){a.activity("multiedit",{category:"/authoring",href:"/multiedit",when:"/multiedit",label:gettext("Authoring"),templateUrl:"scripts/superdesk-authoring/multiedit/views/multiedit.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",controller:b,filters:[{action:"author",type:"multiedit"}]})}])}(),function(){"use strict";function a(a,b,c){function d(d,e,f){return a.save("macros",{macro:d.name,item:_.omit(e),commit:!!f}).then(function(a){return angular.extend(e,a.item),f||b.save(e),e},function(a){angular.isDefined(a.data._message)&&c.error(gettext("Error: "+a.data._message))})}this.get=function(){return a.query("macros").then(angular.bind(this,function(a){return this.macros=a._items,this.macros}))},this.getByDesk=function(b){return a.query("macros",{desk:b}).then(angular.bind(this,function(a){return this.macros=a._items,this.macros}))},this.setupShortcuts=function(a){this.get().then(function(b){angular.forEach(b,function(b){b.shortcut&&a.$on("key:ctrl:"+b.shortcut,function(){d(b,a.item)})})})},this.call=d}function b(a,b,c){b.get().then(function(){var d=c.getCurrentDeskId();null!==d?b.getByDesk(c.getCurrentDesk().name).then(function(b){a.macros=b}):a.macros=b.macros}),a.call=function(c){return b.call(c,a.item)}}a.$inject=["api","autosave","notify"],b.$inject=["$scope","macros","desks"],angular.module("superdesk.authoring.macros",[]).service("macros",a).controller("Macros",b).config(["authoringWidgetsProvider",function(a){a.widget("macros",{icon:"macros",label:gettext("Macros"),template:"scripts/superdesk-authoring/macros/views/macros-widget.html",order:6,side:"right",display:{authoring:!0,packages:!0,legalArchive:!1}})}])}(),function(){"use strict";function a(a,b){function c(){var b=(a.search().sort||"versioncreated:desc").split(":");return angular.extend(_.find(h,{field:b[0]}),{dir:b[1]})}function d(a){var b=_.find(h,{field:a});f(b.field,b.defaultDir||"desc")}function e(){var a=c(),b="asc"===a.dir?"desc":"asc";f(a.field,b)}function f(b,c){a.search("sort",b+":"+c),a.search("page",null)}function g(a){function b(a,b){if(a.beforefirstcreated||a.afterfirstcreated){var c={firstcreated:{}};a.beforefirstcreated&&(c.firstcreated.lte=a.beforefirstcreated),a.afterfirstcreated&&(c.firstcreated.gte=a.afterfirstcreated),b.post_filter({range:c})}if(a.beforeversioncreated||a.afterversioncreated){var d={versioncreated:{}};a.beforeversioncreated&&(d.versioncreated.lte=a.beforeversioncreated),a.afterversioncreated&&(d.versioncreated.gte=a.afterversioncreated),b.post_filter({range:d})}if(a.after){var e={firstcreated:{}};e.firstcreated.gte=a.after,b.post_filter({range:e})}if(a.type){var f={type:JSON.parse(a.type)};b.post_filter({terms:f})}a.urgency&&b.post_filter({terms:{urgency:JSON.parse(a.urgency)}}),a.priority&&b.post_filter({terms:{priority:JSON.parse(a.priority)}}),a.source&&b.post_filter({terms:{source:JSON.parse(a.source)}}),a.credit&&a.creditqcode&&b.post_filter({terms:{credit:JSON.parse(a.creditqcode)}}),a.category&&b.post_filter({terms:{"anpa_category.name":JSON.parse(a.category)}}),a.desk&&b.post_filter({terms:{"task.desk":JSON.parse(a.desk)}}),a.stage&&b.post_filter({terms:{"task.stage":JSON.parse(a.stage)}})}var d,e=[],f=[];null==a&&(a={}),this.getCriteria=function(b){var d=a,g=c(),h={query:{filtered:{filter:{and:e}}},sort:[_.zipObject([g.field],[g.dir])]};return f.length>0&&(h.post_filter={and:f}),d.q&&(h.query.filtered.query={query_string:{query:d.q,lenient:!1,default_operator:"AND"}}),b&&(h={source:h},d.repo&&(h.repo=d.repo)),h},this.filter=function(a){return e.push(a),this},this.post_filter=function(a){return f.push(a),this},this.clear_filters=function(){return e=[],f=[],b({},this),this},this.size=function(a){return d=null!=a?a:d,this},a.spike?this.filter({term:{state:"spiked"}}):this.filter({not:{term:{state:"spiked"}}}),a.ignoreKilled&&this.filter({not:{term:{state:"killed"}}}),a.ignoreDigital&&this.filter({not:{term:{package_type:"takes"}}}),a.ignoreScheduled&&this.filter({not:{term:{state:"scheduled"}}}),this.filter({not:{and:[{term:{_type:"published"}},{term:{package_type:"takes"}},{term:{last_published_version:!1}}]}}),this.filter({not:{and:[{term:{package_type:"takes"}},{term:{_type:"archive"}}]}}),b(a,this)}var h=[{field:"versioncreated",label:b("Updated")},{field:"firstcreated",label:b("Created")},{field:"urgency",label:b("News Value")},{field:"anpa_category.name",label:b("Category")},{field:"slugline",label:b("Slugline")},{field:"priority",label:b("Priority")}];this.getSubjectCodes=function(b,c){var d=b.selectedParameters,e=[];if(!a.search().q)return e;for(var f=0,g=d.length;g>f;f++){var h=d[f];if(-1!==h.indexOf("subject.name"))for(var i=h.substring(h.lastIndexOf("(")+1,h.lastIndexOf(")")),j=0,k=c.length;k>j;j++)c[j].name===i&&e.push(c[j])}return e},this.setSort=d,this.getSort=c,this.sortOptions=h,this.toggleSortDir=e,this.query=function(a){return new g(a)}}function b(a,b){function c(a){for(h.selectedParameters=[];a.indexOf(":")>0&&a.indexOf(":")<a.indexOf("(")&&a.indexOf(":")<a.indexOf(")");){var b=a.indexOf(":"),c=a.substring(a.lastIndexOf(" ",b),a.indexOf(")",b)+1);h.selectedParameters.push(c),a=a.replace(c,"")}return a}function d(a){for(h.selectedKeywords=[];a.indexOf("(")>=0;){var b=a.indexOf("("),c=a.substring(b,a.indexOf(")",b)+1);h.selectedKeywords.push(c),a=a.replace(c,"")}}function e(b,c){if(c.indexOf("Last")>=0)f();else{var d=a.search();if(d[b]){var e=JSON.parse(d[b]);e.splice(e.indexOf(c),1),e.length>0?a.search(b,JSON.stringify(e)):a.search(b,null),"credit"===b&&a.search("creditqcode",null)}}}function f(){var b=a.search();b.after&&a.search("after",null)}function g(){return b.initialize().then(function(e){h.selectedFacets={},h.selectedParameters=[],h.selectedKeywords=[],h.currentSearch=a.search();var f=h.currentSearch.q;if(f){var g=c(f);d(g)}return _.forEach(h.currentSearch,function(a,c){if("q"!==c)if(h.selectedFacets[c]=[],"desk"===c){var d=JSON.parse(a);_.forEach(d,function(a){h.selectedFacets[c].push(b.deskLookup[a].name)})}else if("stage"===c){var e=a;_.forEach(b.deskStages[b.getCurrentDeskId()],function(a){a._id===JSON.parse(e)[0]&&h.selectedFacets[c].push(a.name)})}else"after"===c?"now-24H"===a?h.selectedFacets.date=["Last Day"]:"now-1w"===a?h.selectedFacets.date=["Last Week"]:"now-1M"===a&&(h.selectedFacets.date=["Last Month"]):i[c]&&(h.selectedFacets[c]=JSON.parse(a))}),h})}var h={};h.selectedFacets={},h.selectedParameters=[],h.selectedKeywords=[],h.currentSearch={};var i={type:1,category:1,urgency:1,priority:1,source:1,credit:1,day:1,week:1,month:1,desk:1,stage:1};return{initSelectedFacets:g,removeFacet:e}}function c(a,b,c,d,e,f,g,h,i){this.send=function(){return d.all(b.getItems())},this.sendAs=function(){return d.allAs(b.getItems())},this.multiedit=function(){c.create(b.getIds()),c.open()},this.createPackage=function(){e.createPackageFromItems(b.getItems()).then(function(a){f.intent("edit","item",a)},function(a){403===a.status&&a.data&&a.data._message&&g.error(gettext(a.data._message),3e3)})},this.addToPackage=function(){a.$broadcast("package:addItems",{items:b.getItems(),group:"main"})},this.spikeItems=function(){h.spikeMultiple(b.getItems()),a.$broadcast("item:spike"),b.reset()},this.unspikeItems=function(){h.unspikeMultiple(b.getItems()),a.$broadcast("item:unspike"),b.reset()},this.canSpikeItems=function(){var a=!0;return b.getItems().forEach(function(b){a=a&&i.itemActions(b).spike}),a}}a.$inject=["$location","gettext"],b.$inject=["$location","desks"],angular.module("superdesk.search",["superdesk.api","superdesk.desks","superdesk.activity","superdesk.list","superdesk.keyboard"]).service("search",a).service("tags",b).controller("MultiActionBar",c).filter("FacetLabels",function(){return function(a){return"URGENCY"===a.toUpperCase()?"News Value":a}}).directive("sdSearchFacets",["$location","desks","privileges","tags","asset",function(a,b,c,d,e){return b.initialize(),{require:"^sdSearchContainer",templateUrl:e.templateUrl("superdesk-search/views/search-facets.html"),scope:{items:"=",desk:"=",repo:"=",context:"="},link:function(e,f,g,h){e.flags=h.flags,e.sTab=!0,e.aggregations={},e.privileges=c.privileges;var i=function(){e.aggregations={type:{},desk:{},stage:{},date:{},source:{},credit:{},category:{},urgency:{},priority:{}}};e.$watch("items",function(){i(),d.initSelectedFacets().then(function(a){e.tags=a,e.items&&void 0!==e.items._aggregations&&(_.forEach(e.items._aggregations.type.buckets,function(a){e.aggregations.type[a.key]=a.doc_count}),_.forEach(e.items._aggregations.category.buckets,function(a){""!==a.key&&(e.aggregations.category[a.key]=a.doc_count)}),angular.isDefined(e.items._aggregations.urgency)&&_.forEach(e.items._aggregations.urgency.buckets,function(a){e.aggregations.urgency[a.key]=a.doc_count}),_.forEach(e.items._aggregations.priority.buckets,function(a){e.aggregations.priority[a.key]=a.doc_count}),_.forEach(e.items._aggregations.source.buckets,function(a){e.aggregations.source[a.key]=a.doc_count}),angular.isDefined(e.items._aggregations.source)&&_.forEach(e.items._aggregations.source.buckets,function(a){e.aggregations.source[a.key]=a.doc_count}),angular.isDefined(e.items._aggregations.credit)&&_.forEach(e.items._aggregations.credit.buckets,function(a){e.aggregations.credit[a.key]={count:a.doc_count,qcode:a.qcode}}),_.forEach(e.items._aggregations.day.buckets,function(a){e.aggregations.date["Last Day"]=a.doc_count}),_.forEach(e.items._aggregations.week.buckets,function(a){e.aggregations.date["Last Week"]=a.doc_count}),_.forEach(e.items._aggregations.month.buckets,function(a){e.aggregations.date["Last Month"]=a.doc_count}),!e.desk&&angular.isDefined(e.items._aggregations.stage)&&_.forEach(e.items._aggregations.desk.buckets,function(a){var c=b.deskLookup[a.key];if("undefined"==typeof c){var d=["Desk (key: ",a.key,") not found in ","deskLookup, probable storage inconsistency."].join("");return void console.warn(d)}e.aggregations.desk[c.name]={count:a.doc_count,id:a.key}}),e.desk&&angular.isDefined(e.items._aggregations.stage)&&_.forEach(e.items._aggregations.stage.buckets,function(a){_.forEach(b.deskStages[e.desk._id],function(b){b._id===a.key&&(e.aggregations.stage[b.name]={count:a.doc_count,id:a.key})})}))})}),e.toggleFilter=function(a,b){e.hasFilter(a,b)?e.removeFilter(a,b):"date"===a?e.setDateFilter(b):e.setFilter(a,b)},e.removeFilter=function(a,b){d.removeFacet(a,b)},e.setFilter=function(b,c){if(!e.isEmpty(b)&&c){var d=a.search()[b];d?(d=JSON.parse(d),d.push(c),a.search(b,JSON.stringify(d))):("credit"===b&&a.search("creditqcode",JSON.stringify([e.aggregations.credit[c].qcode])),a.search(b,JSON.stringify([c])))}else a.search(b,null)},e.setDateFilter=function(b){"Last Day"===b?a.search("after","now-24H"):"Last Week"===b?a.search("after","now-1w"):"Last Month"===b?a.search("after","now-1M"):a.search("after",null)},e.isEmpty=function(a){return _.isEmpty(e.aggregations[a])},e.format=function(a){return a?moment(a).format("YYYY-MM-DD"):null},e.hasFilter=function(a,c){return"desk"===a?e.tags.selectedFacets[a]&&e.tags.selectedFacets[a].indexOf(b.deskLookup[c].name)>=0:e.tags.selectedFacets[a]&&e.tags.selectedFacets[a].indexOf(c)>=0}}}}]).directive("sdSearchTags",["$location","$route","tags","asset","metadata",function(a,b,c,d,e){return{scope:{},templateUrl:d.templateUrl("superdesk-search/views/search-tags.html"),link:function(b,d){c.initSelectedFacets().then(function(a){b.tags=a}),b.removeFilter=function(a,b){c.removeFacet(a,b)},b.removeParameter=function(b){var c=a.search();if(c.q&&(c.q=c.q.replace(b,"").trim(),a.search("q",c.q||null),-1!==b.indexOf("subject.name:"))){var d=b.substring(b.lastIndexOf("(")+1,b.lastIndexOf(")"));e.removeSubjectTerm(d)}}}}}]).directive("sdSearchResults",["$location","preferencesService","packages","asset","$timeout","api","search","session",function(a,b,c,d,e,f,g,h){var i={"archive:view":{allowed:["mgrid","compact"],category:"archive",view:"mgrid","default":"mgrid",label:"Users archive view format",type:"string"}},j={compact:{ITEM_HEIGHT:57,ITEMS_COUNT:25,BUFFER:8},mgrid:{ITEM_HEIGHT:239,ITEM_WIDTH:190,ITEMS_COUNT:27,ITEMS_ROW:9,BUFFER:18}};return{require:"^sdSearchContainer",templateUrl:d.templateUrl("superdesk-search/views/search-results.html"),link:function(d,k,l,m){function n(){e.cancel(w),w=e(q,100,!1)}function o(){return A=g.query(a.search()).getCriteria(!0),A.source.size=0,d.total=null,f.query(p(A),A).then(function(a){d.total=a._meta.total,d.$applyAsync(q)})}function p(a){var b="search";return a.repo&&-1===a.repo.indexOf(",")&&(b=a.repo),d.repo.search&&"local"!==d.repo.search&&(b=d.repo.search),b}function q(){var b=_.omit(a.search(),"_id"),c=r();_.isEqual(_.omit(b,"page"),_.omit(D,"page"))||a.search("page",null),A=g.query(a.search()).getCriteria(!0);var e;A.source.from=c.from,A.source.size=c.to-c.from,f.query(p(A),A).then(function(a){d.$applyAsync(function(){B.style.paddingTop=c.padding,d.items?(e={_items:s(a._items)},d.items=_.assign(e,_.omit(a,"_items"))):d.items=a})}),D=b}function r(){var a,b,c,e,f,g;return"mgrid"===d.view&&(j[d.view].ITEMS_ROW=Math.floor(C.width()/j[d.view].ITEM_WIDTH),j[d.view].BUFFER=3*j[d.view].ITEMS_ROW),a=C[0].scrollTop,b="mgrid"===d.view?Math.floor(a/j[d.view].ITEM_HEIGHT)*j[d.view].ITEMS_ROW:Math.floor(a/j[d.view].ITEM_HEIGHT),c=Math.max(0,b-j[d.view].BUFFER),e=j[d.view].ITEMS_COUNT,f=Math.min(d.total,b+e+j[d.view].BUFFER),g="mgrid"===d.view?c*j[d.view].ITEM_HEIGHT/j[d.view].ITEMS_ROW+"px":c*j[d.view].ITEM_HEIGHT+"px",{from:c,to:f,padding:g}}function s(a){var b=[],c=d.items._items||[];return angular.forEach(a,function(a){var d="ingested"===a.state?{_id:a._id}:{_id:a._id,_current_version:a._current_version},e=_.find(c,d);b.push(e?angular.extend(e,a):a)}),b}function t(a,b){h.identity._id===b.user&&o()}function u(a){d.view=a||"mgrid",i["archive:view"].view=a||"mgrid",b.update(i,"archive:view")}function v(){var a=d.view===y?x:y;return u(a)}var w,x="mgrid",y="compact",z=void 0===l.multiSelectable?!1:!0,A=g.query(a.search()).getCriteria(!0),B=k[0].getElementsByClassName("list-view")[0],C=k.find(".content"),D=_.omit(a.search(),"_id");d.flags=m.flags,d.selected=d.selected||{},d.repo={ingest:!0,archive:!0,published:!0,archived:!0},d.context="search",d.$on("item:deleted:archived",t),d.$on("item:published:no_post_publish_actions",t),
C.on("scroll",n),d.$watch("view",function(a,b){a!==b&&(C.scrollTop(0),q())}),d.$watch(function(){return _.omit(a.search(),"_id")},function(a,b){a!==b&&o().then(function(){C.scrollTop(0)})},!0),o(),d.preview=function(b){z&&(-1===_.findIndex(d.selectedList,{_id:b._id})?d.selectedList.push(b):_.remove(d.selectedList,{_id:b._id})),d.selected.preview=b,a.search("_id",b?b._id:null)},d.openLightbox=function(){d.selected.view=d.selected.preview},d.closeLightbox=function(){d.selected.view=null},d.openSingleItem=function(a){c.fetchItem(a).then(function(a){d.selected.view=a})},d.setview=u;var E;b.get("archive:view").then(function(a){E=a.view,d.view=E&&"undefined"!==E?E:"mgrid"}),d.$on("key:v",v),d.generateTrackIdentifier=function(a){return"ingested"===a.state?a._id:a._id+":"+a._current_version}}}}]).directive("sdSearchWithin",["$location","asset",function(a,b){return{scope:{},templateUrl:b.templateUrl("superdesk-search/views/search-within.html"),link:function(b,c){b.searchWithin=function(){if(b.within){var c=a.search();c.q?b.query=c.q+" ("+b.within+") ":b.query="("+b.within+")",a.search("q",b.query||null),b.within=null}}}}}]).directive("sdItemContainer",["$filter","desks","api",function(a,b,c){return{scope:{item:"="},template:"{{item.container}}",link:function(a,c){"ingest"!==a.item._type&&(a.item.task&&a.item.task.desk?b.initialize().then(function(){b.deskLookup[a.item.task.desk]&&(a.item.container="desk:"+b.deskLookup[a.item.task.desk].name)}):"archive"===a.item._type?a.item.container="location:workspace":"published"===a.item._type&&a.item.allow_post_publish_actions===!1&&(a.item.container="archived"))}}}]).directive("sdItemPreview",["asset",function(a){return{templateUrl:a.templateUrl("superdesk-search/views/item-preview.html"),scope:{item:"=",close:"&",openLightbox:"=",openSingleItem:"=",hideActionsMenu:"="},link:function(a){a.tab="content",a.$watch("item",function(b){a.selected={preview:b||null}}),a.$on("item:spike",a.close),a.$on("item:unspike",a.close),a.hideActions=function(){return a.hideActionsMenu}}}}]).directive("sdItemGlobalsearch",["superdesk","session","$location","search","api","notify","gettext","keyboardManager","asset","authoringWorkspace",function(a,b,c,d,e,f,g,h,i,j){return{scope:{repo:"=",context:"="},templateUrl:i.templateUrl("superdesk-search/views/item-globalsearch.html"),link:function(a,c){function d(){a.meta.unique_name=""}function i(b){b.length>0?(d(),a.flags.enabled=!1,j.edit(b[0])):(f.error(g("Item not found...")),a.flags.enabled=!0)}function k(c){var d=e("user_content",b.identity);d.query(c).then(function(a){i(a._items)},function(b){a.message=g("There was a problem, item can not open.")})}function l(){var b=[{not:{term:{state:"spiked"}}},{term:{unique_name:a.meta.unique_name}}],c={repo:"archive",source:{query:{filtered:{filter:{and:b}}}}};e.query("search",c).then(function(b){a.items=b._items,a.items.length>0?(i(a.items),d()):k(c)},function(b){a.message=g("There was a problem, item can not open.")})}function m(){d(),a.flags.enabled=!1}var n=13,o=27;a.meta={},a.flags={enabled:!1};var p={global:!0};h.bind("ctrl+0",function(){a.flags.enabled=!0},p),h.bind("esc",function(){a.flags.enabled=!1},p),a.search=function(){l()},a.openOnEnter=function(b){b.keyCode===n&&(a.search(),b.stopPropagation()),b.keyCode===o&&m()},a.close=function(){m()}}}}]).directive("sdItemSearchbar",["$location","$document","asset",function(a,b,c){return{templateUrl:c.templateUrl("superdesk-search/views/item-searchbar.html"),link:function(c,d){function e(){c.$apply(function(){c.focused=!1})}var f=13;c.focused=!1;var g=d.find("#search-input");c.searchOnEnter=function(a){a.keyCode===f&&(c.search(),a.stopPropagation())},c.search=function(){a.search("q",c.query||null)},c.cancel=function(){c.query=null,c.search(),g.focus()};var h=a.search();h.q&&""!==h.q?c.query=h.q:c.query=null,b.bind("click",e),c.$on("$destroy",function(){b.unbind("click",e)})}}}]).directive("sdItemSearch",["$location","$timeout","asset","api","tags","search","metadata",function(a,b,c,d,e,f,g){return{scope:{repo:"=",context:"="},templateUrl:c.templateUrl("superdesk-search/views/item-search.html"),link:function(c,h){function i(){var b=a.search();if(c.query=b.q,c.flags=!1,j(),b.repo){var d=b.repo.split(",");c.repo.archive=d.indexOf("archive")>=0,c.repo.ingest=d.indexOf("ingest")>=0,c.repo.published=d.indexOf("published")>=0,c.repo.archived=d.indexOf("archived")>=0}c.repo?c.repo.archive||c.repo.ingest||c.repo.published||c.repo.archived?c.repo.search="local":c.repo.search=b.repo:c.repo={search:"local"}}function j(){return d.ingestProviders.query({max_results:200}).then(function(a){c.providers=a._items})}function k(){var a=[];return"local"===c.repo.search?(angular.forEach(c.repo,function(b,c){b&&"local"!==b&&a.push(c)}),a.length?a.join(","):null):c.repo.search}function l(a){for(var b in a)if(a.hasOwnProperty(b))return b}function m(){var a=[];return angular.forEach(c.meta,function(b,c){if("_all"===c)a.push(b.join(" "));else if(b)if("string"==typeof b)b&&a.push(c+":("+b+")");else{var d=l(b);b[d]&&a.push(c+"."+d+":("+b[d]+")")}}),a.length?c.query?c.query+" "+a.join(" "):a.join(" "):c.query||null}function n(){c.query=a.search().q,a.search("q",m()||null),a.search("repo",k()),c.meta={}}var o=h.find("#search-input");i(),c.$on("$locationChangeSuccess",function(){c.query!==a.search().q&&i()}),c.focusOnSearch=function(){c.advancedOpen&&c.toggle(),o.focus()},c.search=function(){n()},c.$on("key:s",function(){c.$apply(function(){c.flags={extended:!0},b(function(){o.focus()},0,!1)})}),g.fetchSubjectcodes().then(function(){return c.subjectcodes=g.values.subjectcodes,e.initSelectedFacets()}).then(function(a){c.subjectitems={subject:f.getSubjectCodes(a,c.subjectcodes)}}),c.subjectSearch=function(b){e.initSelectedFacets().then(function(d){var e=f.getSubjectCodes(d,c.subjectcodes);if(b.subject.length>e.length){var g="subject.name:("+b.subject[b.subject.length-1].name+")",h=c.query?c.query+" "+g:g;a.search("q",h)}else{var i=a.search();if(i.q)for(var j=0;j<e.length;j++)if(-1===b.subject.indexOf(e[j])){var k="subject.name:("+e[j].name+")";i.q=i.q.replace(k,"").trim(),a.search("q",i.q||null)}}})}}}}]).directive("sdItemSortbar",["search","asset","$location",function(a,b,c){return{scope:{},templateUrl:b.templateUrl("superdesk-search/views/item-sortbar.html"),link:function(b){function d(){b.active=a.getSort()}b.sortOptions=a.sortOptions,b.canSort=function(){var b=a.query(c.search()).getCriteria(!0);return!(angular.isDefined(b.repo)&&"aapmm"===b.repo)},b.sort=function(b){a.setSort(b)},b.toggleDir=function(b){a.toggleSortDir()},b.$on("$routeUpdate",d),d()}}}]).directive("sdSavedSearchSelect",["api","session",function(a,b){return{link:function(c){a.query("saved_searches",{},b.identity).then(function(a){c.searches=a._items})}}}]).directive("sdSavedSearches",["api","session","$location","notify","gettext","asset",function(a,b,c,d,e,f){return{templateUrl:f.templateUrl("superdesk-search/views/saved-searches.html"),scope:{},link:function(f){var g=a("saved_searches",b.identity);f.selected=null,f.editSearch=null,g.query().then(function(a){f.views=a._items}),f.select=function(a){f.selected=a,c.search(a.filter.query)},f.edit=function(){f.editSearch={}},f.cancel=function(){f.editSearch=null},f.save=function(a){a.filter={query:c.search()},g.save({},a).then(function(a){d.success(e("Saved search created")),f.cancel(),f.views.push(a)},function(){d.error(e("Error. Saved search not created."))})},f.remove=function(a){g.remove(a).then(function(){d.success(e("Saved search removed")),_.remove(f.views,{_id:a._id})},function(){d.error(e("Error. Saved search not deleted."))})}}}}]).directive("sdSearchContainer",function(){return{controller:["$scope",function(a){this.flags=a.flags||{}}]}}).directive("sdMultiActionBar",["asset","multi","authoringWorkspace",function(a,b,c){return{controller:"MultiActionBar",controllerAs:"action",templateUrl:a.templateUrl("superdesk-search/views/multi-action-bar.html"),scope:!0,link:function(a){function d(b){var c={},d=[];angular.forEach(b,function(a){c[a._type]=1,d.push(a.state)});var e=Object.keys(c);a.type=1===e.length?e[0]:null,a.state=1===e.length?d[0]:null}a.multi=b,a.$watch(b.getItems,d),a.isOpenItemType=function(a){var b=c.getItem();return b.type===a}}}}]).config(["superdeskProvider","assetProvider",function(a,b){a.activity("/search",{description:gettext("Find live and archived content"),priority:200,label:gettext("Search"),templateUrl:b.templateUrl("superdesk-search/views/search.html"),sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}]),c.$inject=["$rootScope","multi","multiEdit","send","packages","superdesk","notify","spike","authoring"]}(),function(){"use strict";function a(a,b,c,d,e){function f(){var a=(d.search().sort||"versioncreated:desc").split(":");return angular.extend(_.find(l,{field:a[0]}),{dir:a[1]})}function g(a){var b=_.find(l,{field:a});j(b.field,b.defaultDir||"desc")}function h(){var a=f(),b="asc"===a.dir?"desc":"asc";j(a.field,b)}function i(a,b){var c="asc"===b?1:-1;return'[("'+encodeURIComponent(a)+'", '+c+")]"}function j(a,b){d.search("sort",a+":"+b),d.search("page",null)}var k=25;this.default_items=Object.freeze({_meta:{max_results:k,page:1,total:1}});var l=[{field:"versioncreated",label:e("Updated")},{field:"firstcreated",label:e("Created")},{field:"urgency",label:e("News Value")},{field:"anpa_category.name",label:e("Category")},{field:"slugline",label:e("Slugline")},{field:"priority",label:e("Priority")}];g("versioncreated"),this.setSort=g,this.getSort=f,this.sortOptions=l,this.toggleSortDir=h,this.getCriteria=function(){var a=d.search(),b={max_results:Number(a.max_results)||k};if(a.q&&(b.where=a.q),a.page&&(b.page=parseInt(a.page,10)),a.sort){var c=a.sort.split(":");b.sort=i(c[0],c[1])}return b},this.updateSearchQuery=function(a){function b(a){return _.trunc(a,{length:a.length-3,omission:""})+"00"}var c=[],e=!1;_.forEach(a,function(a,d){var f=_.trim(a);if(f){var g={};"published_after"===d?g.versioncreated={$gte:b(f)}:"published_before"===d?g.versioncreated={$lte:b(f)}:"_id"===d?(g._id=f,e=!0):g[d]={$regex:f,$options:"-i"},c.push(g)}});var f=null;return e&&1===c.length?f=JSON.stringify(c[0]):c.length>0&&(f=JSON.stringify({$and:c})),d.search("q",f),f},this.query=function(){var a=this.getCriteria();return b.legal_archive.query(a)}}function b(a,b,c,d){function e(){a.loading=!0,c.query().then(function(b){a.loading=!1,a.items=b})}var f={"archive:view":{allowed:["mgrid","compact"],category:"archive",view:"mgrid","default":"mgrid",label:"Users archive view format",type:"string"}};a.criteria={},a.items=c.default_items,a.loading=!1,a.selected={},a.openAdvanceSearch=!1,a.extras={activity:{action:"list"}},a.search=function(){c.updateSearchQuery(a.criteria),e()},a.preview=function(b){a.selected.preview=b},a.openLightbox=function(){a.selected.view=a.selected.preview},a.closeLightbox=function(){a.selected.view=null},a.clear=function(){c.criteria=a.criteria={},a.search()},a.$watch(function(){return _.omit(b.search(),"_id")},e,!0),a.setview=function(b){a.view=b||"mgrid",f["archive:view"].view=b||"mgrid",d.update(f,"archive:view")},a.search(),d.get("archive:view").then(function(b){var c=b.view;a.view=c&&"undefined"!==c?c:"mgrid"})}a.$inject=["$q","api","notify","$location","gettext"],b.$inject=["$scope","$location","legal","preferencesService"];var c=angular.module("superdesk.legal_archive",["superdesk.activity","superdesk.api"]);return c.service("legal",a).directive("sdLegalItemSortbar",["legal","asset",function(a,b){return{scope:{},templateUrl:b.templateUrl("superdesk-search/views/item-sortbar.html"),link:function(b){function c(){b.active=a.getSort()}b.sortOptions=a.sortOptions,b.sort=function(b){a.setSort(b)},b.toggleDir=function(b){a.toggleSortDir()},b.$on("$routeUpdate",c),c()}}}]).config(["apiProvider",function(a){a.api("legal_archive",{type:"http",backend:{rel:"legal_archive"}}),a.api("legal_archive_versions",{type:"http",backend:{rel:"legal_archive_versions"}})}]).config(["superdeskProvider",function(a){a.activity("/legal_archive/",{label:gettext("Legal Archive"),description:gettext("Confidential data"),priority:100,controller:b,templateUrl:"scripts/superdesk-legal-archive/views/legal_archive.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html",reloadOnSearch:!1,filters:[],privileges:{legal_archive:1}})}]),c}(),function(){"use strict";var a=angular.module("superdesk.stream",["superdesk.activity","superdesk.asset"]);a.controller("StreamController",["$scope","api","$rootScope","desks",function(a,b,c,d){a.desk=null,a.activities=null,a.pageLength=10,a.max_results=a.pageLength,a.loadMore=function(){a.activities._meta.total>a.max_results&&(a.max_results+=a.pageLength,e())},a.showDateHeader=function(b){if(a.currentDate=new Date(a.activities._items[b.index]._created),0===b.index)return!0;var c=new Date(a.activities._items[b.index-1]._created);return c.getYear()!==a.currentDate.getYear()||c.getMonth()!==a.currentDate.getMonth()||c.getDate()!==a.currentDate.getDate()};var e=function(){var c={embedded:{user:1,item:1},max_results:a.max_results};a.desk&&(c.where={desk:a.desk._id}),b("activity").query(c).then(function(b){a.activities=b})};a.$watch("desk",function(){e()}),c.$on("activity",function(a,b){e()})}]).directive("sdActivityStream",["asset",function(a){return{scope:{activities:"=",max_results:"=maxResults",loadMore:"&"},templateUrl:a.templateUrl("superdesk-stream/views/activity-stream.html")}}]).directive("sdActivityMessage",[function(){return{scope:{activity:"="},template:"{{display_message}}",link:function(a,b,c){if("notify"!==a.activity.name){a.display_message=a.activity.message;for(var d in a.activity.data)if(a.activity.data.hasOwnProperty(d)){var e=new RegExp("{{\\s*"+d+"\\s*}}","gi");a.display_message=a.display_message.replace(e,a.activity.data[d])}}}}}]).config(["superdeskProvider","assetProvider","gettext",function(a,b,c){a.activity("/workspace/stream",{label:c("Workspace"),controller:"StreamController",templateUrl:b.templateUrl("superdesk-stream/views/workspace-stream.html"),topTemplateUrl:b.templateUrl("superdesk-dashboard/views/workspace-topnav.html")})}])}(),function(){"use strict";function a(a,b,c,d,e,f){function g(a,b){var c=[];return a&&c.push({headline:a.headline||"",residRef:a._id,location:"archive",slugline:a.slugline||"",renditions:a.renditions||{}}),{refs:c,id:b,role:"grpRole:"+b}}function h(a,b){return(angular.isUndefined(b)||!_.isObject(b))&&(b={}),c.addTaskToArticle(b),_.merge(a,b)}var i=this;this.groupList=["main","story","sidebars","fact box"],this.fetch=function(b){return a.find("archive",b).then(function(a){return a})},this.open=function(a,b){return f.open(a,b)},this.createPackageFromItems=function(b,c){var d="main",e=b[0],f={headline:e.headline||e.description||"",slugline:e.slugline||"",description:e.description||"",state:"draft",type:"composite",version:0},i=[{role:"grpRole:NEP",refs:[{idRef:d}],id:"root"},g(null,d)];return f=h(f,c),f.groups=i,this.addItemsToPackage(f,d,b),a.archive.save(f)},this.createEmptyPackage=function(b,c){c=c||"main";var d={headline:"",slugline:"",description:"",type:"composite",groups:[{role:"grpRole:NEP",refs:[{idRef:c}],id:"root"},g(null,c)]};return d=h(d,b),a.save("archive",d)},this.addItemsToPackage=function(a,b,c){var d=_.cloneDeep(a.groups),e=_.find(d,function(a){return a.id.toLowerCase()===b});if(!e){var f=_.find(d,{id:"root"});f.refs.push({idRef:b}),e={id:b,refs:[],role:"grpRole:"+b},d.push(e)}_.each(c,function(a){e.refs.push(i.getReferenceFor(a))}),_.extend(a,{groups:d})},this.isAdded=function(a,b){return a.groups.some(function(a){return a.refs.some(function(a){return a.guid===b._id})})},this.fetchItem=function(b){var c=b.location||"ingest";return a(c).getById(b.residRef).then(function(a){return a},function(a){404===a.status&&console.log("Item not found")})},this.getReferenceFor=function(a){return{headline:a.headline||"",residRef:a._id,location:"archive",slugline:a.slugline||"",renditions:a.renditions||{},itemClass:a.type?"icls:"+a.type:""}}}function b(a,b,c,d,e,f,g,h){a.origItem=b,a.action="edit",a.lock=function(){h.intent("author","package",b)},a.highlight=!!b.highlight}function c(a,b,c,d){function e(){if(h){var b={};b.q=a.query,b.ignoreKilled=!0,b.ignoreDigital=!0,b.ignoreScheduled=!0;var e=d.query(b);e.filter({not:{exists:{field:"embargo"}}}),e.size(25),a.highlight&&e.filter({term:{highlights:a.highlight.toString()}});var f=e.getCriteria(!0);f.repo="archive,published",c.query("search",f).then(function(b){a.contentItems=b._items})}}function f(){var b=[];a.item.groups&&_.each(a.item.groups,function(a){"root"!==a.id&&_.each(a.refs,function(a){b.push(a.residRef)})}),g=b}a.selected=null,a.multiSelected=[],a.query=null,a.highlight=null;var g=null,h=!1;a.groupList=b.groupList,e(),a.$watch("query",function(a){e()}),a.$watch("highlight",function(a){e()}),a.$watch("item",function(b){a.highlight=b.highlight,a.highlight?c("highlights").getById(a.highlight).then(function(b){a.groupList=b.groups,h=!0,e()},function(a){h=!0,e()}):(h=!0,e())}),a.$watch("item.groups",function(){f()},!0),a.addItemToGroup=function(c,d){b.addItemsToPackage(a.item,c,[d]),a.autosave(a.item)},a.preview=function(b){a.selected=b},a.itemInPackage=function(a){return _.indexOf(g,a._id)>-1},a.addToSelected=function(b){b.multi?a.multiSelected.push(b):_.remove(a.multiSelected,b)},a.addMultiItemsToGroup=function(c){b.addItemsToPackage(a.item,c,a.multiSelected),a.autosave(a.item),_.each(a.multiSelected,function(a){a.multi=!1}),a.multiSelected=[]}}function d(){return{link:function(a,b){function c(b){0===$(b.target).closest(".group-select").length&&a.$apply(function(){a.preview(a.pitem)})}b.bind("click",c),a.$on("$destroy",function(){b.unbind("click",c)})}}}function e(a){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-edit.html",link:function(b){b.limits=a.limits,b._editable=b.origItem._editable,b._isInPublishedStates=a.isPublished(b.origItem)}}}function f(a,b){return{scope:!1,require:"ngModel",templateUrl:"scripts/superdesk-packaging/views/sd-package-items-edit.html",link:function(c,d,e,f){function g(){f.$setViewValue({list:c.list}),c.autosave(c.item)}function h(a){return c.list.some(function(b){return b.items.some(function(b){return b.residRef===a._id})})}c.$on("package:addItems",function(d,e){var f=_.findIndex(c.list,{id:e.group});-1===f&&(c.list.push({id:e.group,items:[]}),f=c.list.length-1);for(var i=0;i<e.items.length;i++)h(e.items[i])?b.error(gettext("Item is already in this package.")):c.list[f].items.unshift(a.getReferenceFor(e.items[i]));g()}),f.$render=function(){c.list=f.$viewValue},f.$parsers.unshift(function(a){var b=null;return a&&a.list&&(b=[],b.push({role:"grpRole:NEP",refs:_.map(a.list,function(a){return{idRef:a.id}}),id:"root"}),_.each(a.list,function(a){b.push({id:a.id,role:"grpRole:"+a.id,refs:a.items})})),b}),f.$formatters.unshift(function(a){function b(d){var e=_.find(a,{id:d}),f=[];return _.each(e.refs,function(a){c(a)?f=_.union(f,b(a.idRef)):f.push(a)}),f}function c(a){return angular.isDefined(a.idRef)}var d=_.find(a,{id:"root"}),e=_.map(d.refs,function(a){return{id:a.idRef,items:[]}});return _.each(e,function(a){a.items=b(a.id)}),e}),c.remove=function(a,b){var d=_.find(c.list,{id:a});_.remove(d.items,{residRef:b}),g()},c.reorder=function(a,b){var d=_.find(c.list,{id:a.group}),e=_.find(c.list,{id:b.group});a.index!==b.index||a.group!==b.group?e.items.splice(b.index,0,d.items.splice(a.index,1)[0]):e.items=_.cloneDeep(e.items),g()}}}}function g(){return{link:function(a,b){var c=!1;b.sortable({items:".package-edit-items li",cursor:"move",containment:".package-edit-container",tolerance:"pointer",placeholder:{element:function(a){var b=a.height()-40;return $('<li class="placeholder" style="height:'+b+'px"></li>')[0]},update:function(){}},start:function(a,b){b.item.data("start_index",b.item.parent().find("li.sort-item").index(b.item)),b.item.data("start_group",b.item.parent().data("group"))},stop:function(b,d){if(c){c=!1;var e={index:d.item.data("start_index"),group:d.item.data("start_group")},f={index:d.item.parent().find("li.sort-item").index(d.item),group:d.item.parent().data("group")};d.item.remove(),a.reorder(e,f),a.$apply()}},update:function(a,b){c=!0},cancel:".fake"})}}}function h(a,b,c){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-item-preview.html",link:function(d){if(d.data=null,d.error=null,d.item.location){var e="";d.item._current_version&&(e="?version="+d.item._current_version),a[d.item.location].getByUrl(d.item.location+"/"+d.item.residRef+e).then(function(a){d.data=a,d.isLocked=b.isLocked(d.data),d.isPublished="published"===d.data.state},function(a){d.error=!0})}d.$on("item:lock",function(a,c){d.data&&d.data._id===c.item&&d.$applyAsync(function(){d.data.lock_user=c.user,d.isLocked=b.isLocked(d.data)})}),d.$on("item:unlock",function(a,b){d.data&&d.data._id===b.item&&d.$applyAsync(function(){d.data.lock_user=null,d.isLocked=!1})}),d.$on("item:publish",function(a,b){d.data&&d.data._id===b.item&&d.$applyAsync(function(){d.isPublished=!0})}),d.open=function(a){c.intent("view","item",a).then(null,function(){c.intent("edit","item",a)})}}}}function i(){var a=function(b,c){var d={childId:"_items",childData:[]},e=[d];return _.each(b.refs,function(b){b.idRef?e.push({childId:b.idRef,childData:a(_.find(c,{id:b.idRef}),c)}):b.residRef&&d.childData.push(b)}),e};return{templateUrl:"scripts/superdesk-packaging/views/sd-package.html",scope:{item:"=",setitem:"&"},link:function(b,c,d){b.mode=d.mode||"tree",b.$watchGroup(["item","item.groups"],function(){b.item&&b.item.groups&&(b.tree=a(_.find(b.item.groups,{id:"root"}),b.item.groups))})}}}function j(){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-item.html",scope:{id:"=",item:"=",setitem:"&",mode:"="},link:function(a,b){}}}function k(a){var b='<div sd-package-item data-id="id" data-item="item" data-setitem="setitem({selected: selected})" data-mode="mode"></div>';return{scope:{id:"=",item:"=",setitem:"&",mode:"="},link:function(c,d){d.append(a(b)(c))}}}function l(a,b){return{templateUrl:"scripts/superdesk-packaging/views/sd-package-ref.html",scope:{item:"=",setitem:"&"}}}function m(a,b){return{templateUrl:"scripts/superdesk-packaging/views/sd-add-package-dropdown.html",link:function(c){c.groupList=b.groupList,c.select=function(b){a.$broadcast("package:addItems",{items:[c.item],group:b})}}}}a.$inject=["api","$q","archiveService","lock","autosave","authoring"],b.$inject=["$scope","item","packages","api","modal","notify","gettext","superdesk"],c.$inject=["$scope","packages","api","search"],e.$inject=["authoring"],f.$inject=["packages","notify"],h.$inject=["api","lock","superdesk"],k.$inject=["$compile"],l.$inject=["api","$rootScope"],m.$inject=["$rootScope","packages"];var n=angular.module("superdesk.packaging",["superdesk.api","superdesk.activity","superdesk.authoring"]);return n.service("packages",a).directive("sdPackageEdit",e).directive("sdPackageItemsEdit",f).directive("sdSortPackageItems",g).directive("sdPackage",i).directive("sdPackageItem",j).directive("sdPackageItemProxy",k).directive("sdPackageRef",l).directive("sdPackageItemPreview",h).directive("sdWidgetPreventPreview",d).directive("sdAddPackageDropdown",m).config(["superdeskProvider",function(a){a.activity("create.package",{label:gettext("Create package"),controller:["data","packages","authoringWorkspace",function(a,b,c){function d(a){c.edit(a)}if(a&&a.items)b.createPackageFromItems(a.items,a.defaults).then(d);else{var e=a&&a.defaults?a.defaults:{};b.createEmptyPackage(e).then(d)}}],filters:[{action:"create",type:"package"}],condition:function(a){return a?"killed"!==a.state&&"takes"!==a.package_type:!0}}).activity("packageitem",{label:gettext("Create package"),priority:50,icon:"package-create",controller:["data","packages","authoringWorkspace","notify","gettext",function(a,b,c,d,e){b.createPackageFromItems([a.item]).then(function(a){c.edit(a)},function(a){403===a.status&&a.data&&a.data._message&&d.error(e(a.data._message),3e3)})}],filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).package_item}],group:"packaging"}).activity("addtopackage",{label:gettext("Add to current"),priority:5,dropdown:!0,icon:"package-plus",templateUrl:"scripts/superdesk-packaging/views/add-to-package.html",filters:[{action:"list",type:"archive"}],condition:function(a){return a.task&&a.task.desk},additionalCondition:["authoringWorkspace","item",function(a,b){var c=a.getItem();return c&&"composite"===c.type&&c._id!==b._id}],group:"packaging"}).activity("combineinpackage",{label:gettext("Combine with current"),priority:49,icon:"package-plus",controller:["data","packages","authoringWorkspace","notify","gettext",function(a,b,c,d,e){var f=c.getItem();b.createPackageFromItems([a.item,f]).then(function(a){c.edit(a)},function(a){403===a.status&&a.data&&a.data._message&&d.error(e(a.data._message),3e3)})}],filters:[{action:"list",type:"archive"}],condition:function(a){return a.task&&a.task.desk},additionalCondition:["authoringWorkspace","item",function(a,b){var c=a.getItem();return c&&"composite"!==c.type&&c._id!==b._id}],group:"packaging"})}]).config(["apiProvider",function(a){a.api("archive",{type:"http",backend:{rel:"archive"}})}]).config(["authoringWidgetsProvider",function(a){a.widget("search",{icon:"view",label:gettext("Search"),template:"scripts/superdesk-packaging/views/search.html",order:4,side:"left",extended:!0,display:{authoring:!1,packages:!0,legalArchive:!1}})}]).controller("SearchWidgetCtrl",c),n}(),function(){"use strict";function a(a,b,c,d){var e={},f={},g=c("highlightList");return e.get=function(c){var d="_nodesk",e=c||d,h=g.get(e);if(h)return b.when(h);if(f[e])return f[e];var i={};return c&&(i={where:{$or:[{desks:c},{desks:{$size:0}}]}}),f[e]=a("highlights").query(i).then(function(a){return g.put(e,a),f[e]=null,b.when(a)}),f[e]},e.clearCache=function(){g.removeAll(),f={}},e.markItem=function(b,c){return a.markForHighlights.create({highlights:b,marked_item:c})},e.createEmptyHighlight=function(a){var b={headline:a.name,highlight:a._id},c=null;return a.groups&&a.groups.length>0&&(c=a.groups[0]),d.createEmptyPackage(b,c)},e.find=function(b){return a.find("highlights",b)},e}function b(a,b){return{templateUrl:"scripts/superdesk-highlights/views/mark_highlights_dropdown_directive.html",link:function(c){c.markItem=function(a){b.markItem(a._id,c.item._id),c.item.highlights?c.item.highlights=[a._id].concat(c.item.highlights):c.item.highlights=[a._id]},c.isMarked=function(a){return c.item&&c.item.highlights&&c.item.highlights.indexOf(a._id)>=0},b.get(a.getCurrentDeskId()).then(function(a){c.highlights=a._items})}}}function c(a,b,c){return{templateUrl:"scripts/superdesk-highlights/views/mark_highlights_dropdown_directive.html",link:function(d){d.markItem=function(a){angular.forEach(c.getItems(),function(c){if(c.highlights){if(-1!==c.highlights.indexOf(a._id))return;c.highlights=[a._id].concat(c.highlights)}else c.highlights=[a._id];b.markItem(a._id,c._id)}),c.reset()},d.isMarked=function(a){var b=_.find(c.getItems(),function(b){return!b.highlights||-1===b.highlights.indexOf(a._id)});return!b},b.get(a.getCurrentDeskId()).then(function(a){d.highlights=a._items})}}}function d(a,b){return{scope:{item:"=item",orientation:"=?"},templateUrl:"scripts/superdesk-highlights/views/highlights_title_directive.html",link:function(c,d){function e(){b(function(){j[0].dispatchEvent(new CustomEvent("toggle"))},0,!1)}function f(b){a.markItem(b,c.item._id).then(function(){c.item.highlights=_.without(c.item.highlights,b)})}var g,h,i=d.find(".unmark").hide(),j=d.find("i");c.orientation=c.orientation||"right",c.$watch("item.highlights",function(b){b&&a.get().then(function(a){c.highlights=_.filter(a._items,function(a){return b.indexOf(a._id)>=0}),c.$applyAsync(function(){c.htmlTooltip=i.html()})})}),c.openTooltip=function(){b.cancel(h),h=null,g||(e(),g=!0)},c.closeTooltip=function(){g&&!h&&(h=b(function(){e(),g=!1},100,!1))},d.on("click",function(a){a.preventDefault(),a.stopPropagation();var b="BUTTON"===a.target.nodeName?a.target:a.target.parentNode,c=b.attributes["data-highlight"];c&&f(c.value)})}}}function e(a){return{scope:{highlight_id:"=highlight"},templateUrl:"scripts/superdesk-highlights/views/search_highlights_dropdown_directive.html",link:function(b){b.selectHighlight=function(a){b.highlight_id=null,a&&(b.highlight_id=a._id)},b.hasHighlights=function(){return _.size(b.highlights)>0},a.get().then(function(a){b.highlights=a._items})}}}function f(a,b,c,d){return{scope:!0,templateUrl:"scripts/superdesk-highlights/views/package_highlights_dropdown_directive.html",link:function(e){e.$watch(function(){return a.active},function(a){e.selected=a,b.get(a.desk).then(function(a){e.highlights=a._items,e.hasHighlights=_.size(e.highlights)>0})}),e.listHighlight=function(a){c.url("workspace/highlights?highlight="+a._id),d.reload()}}}}function g(a,b){return{scope:{highlight_id:"=highlight"},template:"<span translate>{{ highlightItem.name }}</span>",link:function(c){b.get(a.getCurrentDeskId()).then(function(a){c.highlightItem=_.find(a._items,{_id:c.highlight_id})})}}}function h(a,b){return{scope:{highlight_id:"=highlight"},templateUrl:"scripts/superdesk-highlights/views/create_highlights_button_directive.html",link:function(c){c.createHighlight=function(){a.find(c.highlight_id).then(a.createEmptyHighlight).then(b.edit)}}}}function i(a,b){b.initialize().then(function(){a.desks=b.deskLookup}),a.hours=_.range(1,25),a.auto={day:"now/d",week:"now/w"}}function j(a,b,c,d,e,f,g){function h(b){return _.map(a.desks,function(a){return{_id:a._id,name:a.name,included:i(b,a._id)}})}function i(a,b){return _.findIndex(a,function(a){return a===b})>-1}function j(){return _.map(_.filter(a.assignedDesks,{included:!0}),function(a){return a._id})}b.get().then(function(b){a.configurations=b}),a.configEdit={},a.modalActive=!1,a.limits=45;var k;a.edit=function(b){a.message=null,a.modalActive=!0,a.configEdit=_.create(b),a.assignedDesks=h(b.desks),a.editingGroup=null,a.selectedGroup=null,k=b,a.configEdit.auto_insert||(a.configEdit.auto_insert="now/d"),a.configEdit.groups||(a.configEdit.groups=[])},a.cancel=function(){a.modalActive=!1},a.save=function(){function c(b){b.data&&b.data._issues&&b.data._issues.name&&b.data._issues.name.unique?a.message=e("Highlight configuration with the same name already exists."):a.message=e("There was a problem while saving highlights configuration")}var f=!k._id;a.configEdit.desks=j(),0===a.configEdit.groups.length?a.configEdit.groups=["main"]:a.configEdit.groups=a.configEdit.groups.slice(0),d.highlights.save(k,a.configEdit).then(function(c){a.message=null,f&&a.configurations._items.unshift(c),b.clearCache(),a.modalActive=!1},function(a){c(a)})},a.remove=function(b){g.confirm(e("Are you sure you want to delete configuration?")).then(function(){d.highlights.remove(b).then(function(){_.remove(a.configurations._items,b),f.success(e("Configuration deleted."),3e3)})})},a.getHourVal=function(a){return"now-"+a+"h"},a.isActiveGroup=function(b){return a.editingGroup&&a.editingGroup.id&&a.configEdit.groups[a.editingGroup.id-1]===b},a.editGroup=function(b){""!==b?a.editingGroup={name:b,id:a.configEdit.groups.indexOf(b)+1}:a.editingGroup={name:"",id:0}},a.removeGroup=function(b){a.configEdit.groups.splice(a.configEdit.groups.indexOf(b),1)},a.cancelGroup=function(){a.editingGroup=null,a.selectedGroup=null},a.saveGroup=function(){0===a.editingGroup.id?a.configEdit.groups.push(a.editingGroup.name):a.editingGroup.id>0&&(a.configEdit.groups[a.editingGroup.id-1]=a.editingGroup.name),a.cancelGroup()},a.handleGroupEdit=function(b){a._errorLimits=null,a.editingGroup&&a.editingGroup.name&&(a._errorLimits=a.editingGroup.name.length>a.limits?!0:null)}}a.$inject=["api","$q","$cacheFactory","packages"],b.$inject=["desks","highlightsService"],c.$inject=["desks","highlightsService","multi"],d.$inject=["highlightsService","$timeout"],e.$inject=["highlightsService"],f.$inject=["desks","highlightsService","$location","$route"],
g.$inject=["desks","highlightsService"],h.$inject=["highlightsService","authoringWorkspace"],i.$inject=["$scope","desks"],j.$inject=["$scope","highlightsService","desks","api","gettext","notify","modal"];var k=angular.module("superdesk.highlights",["superdesk.desks","superdesk.packaging","superdesk.activity","superdesk.api"]);return k.service("highlightsService",a).directive("sdCreateHighlightsButton",h).directive("sdMarkHighlightsDropdown",b).directive("sdMultiMarkHighlightsDropdown",c).directive("sdPackageHighlightsDropdown",f).directive("sdHighlightsTitle",d).directive("sdSearchHighlights",e).directive("sdHighlightsConfig",function(){return{controller:j}}).directive("sdHighlightsConfigModal",function(){return{require:"^sdHighlightsConfig",templateUrl:"scripts/superdesk-highlights/views/highlights_config_modal.html",link:function(a,b,c,d){}}}).directive("sdHighlightLabel",g).config(["superdeskProvider",function(a){a.activity("mark.item",{label:gettext("Mark for highlight"),priority:30,icon:"list-plus",dropdown:!0,templateUrl:"scripts/superdesk-highlights/views/mark_highlights_dropdown.html",filters:[{action:"list",type:"archive"}],additionalCondition:["authoring","item",function(a,b){return a.itemActions(b).mark_item}],group:"packaging"}).activity("/settings/highlights",{label:gettext("Highlights"),controller:i,templateUrl:"scripts/superdesk-highlights/views/settings.html",category:a.MENU_SETTINGS,priority:-800,privileges:{highlights:1}}).activity("/workspace/highlights",{label:gettext("Highlights View"),priority:100,templateUrl:"scripts/superdesk-monitoring/views/highlights-view.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}]).config(["apiProvider",function(a){a.api("highlights",{type:"http",backend:{rel:"highlights"}}),a.api("markForHighlights",{type:"http",backend:{rel:"marked_for_highlights"}}),a.api("generate_highlights",{type:"http",backend:{rel:"generate_highlights"}})}]),k}(),function(){"use strict";function a(a){this.productionTestFilter=function(a){return a},this.getFilterConditionParameters=function(){return a.query("filter_conditions/parameters").then(angular.bind(this,function(a){return a._items}))},this.saveFilterCondition=function(b,c){return a.save("filter_conditions",b,c)},this.remove=function(b){return a.remove(b)},this.getAllFilterConditions=function(a,c){return b("filter_conditions",a,c)},this.getFilterSearchResults=function(b){return a.query("subscribers",{filter_condition:b}).then(angular.bind(this,function(a){return a._items}))},this.getAllContentFilters=function(a,c){return b("content_filters",a,c)},this.saveContentFilter=function(b,c){return a.save("content_filters",b,c)},this.testContentFilter=function(b){return a.save("content_filter_tests",{},b)},this.getGlobalContentFilters=function(){return a.query("content_filters",{is_global:!0}).then(angular.bind(this,function(a){return a._items}))};var b=function(c,d,e){return d=d||1,e=e||[],a(c).query({max_results:200,page:d}).then(function(a){return e=e.concat(a._items),a._links.next?(d++,b(d,e)):e})}}function b(){var a=this;a.TEMPLATES_DIR="scripts/superdesk-content-filters/views",a.activeTab="filters",a.changeTab=function(b){a.activeTab=b}}function c(a,b,c,d){a.filterConditions=null,a.filterCondition=null,a.origFilterCondition=null,a.filterConditionParameters=null,a.operatorLookup={},a.valueLookup={},a.valueFieldLookup={},a.edit=function(c){b.getFilterConditionParameters().then(function(b){a.filterConditionParameters=b,_.each(b,function(b){a.operatorLookup[b.field]=b.operators,a.valueLookup[b.field]=b.values,a.valueFieldLookup[b.field]=b.value_field}),a.origFilterCondition=c||{},a.filterCondition=_.create(a.origFilterCondition),a.filterCondition.values=[],f()})},a.isListValue=function(){return _.contains(["in","nin"],a.filterCondition.operator)&&a.valueLookup[a.filterCondition.field]},a.cancel=function(){a.origFilterCondition=null,a.filterCondition=null},a.save=function(){a.filterCondition.value=e(),delete a.filterCondition.values,b.saveFilterCondition(a.origFilterCondition,a.filterCondition).then(function(){c.success(gettext("Filter condition saved.")),a.cancel()},function(a){angular.isDefined(a.data._issues)?a.data._issues.name&&a.data._issues.name.unique?c.error(gettext("Error: "+gettext("Name needs to be unique"))):c.error(gettext("Error: "+JSON.stringify(a.data._issues))):angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):c.error(gettext("Error: Failed to save filter condition."))}).then(g)},a.remove=function(e){d.confirm(gettext("Are you sure you want to delete filter condition?")).then(function(){return b.remove(e)}).then(function(b){_.remove(a.filterConditions,e)},function(a){angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):c.error(gettext("There is an error. Filter condition cannot be deleted."))})};var e=function(){if(a.isListValue()){var b=[];return _.each(a.filterCondition.values,function(c){b.push(c[a.valueFieldLookup[a.filterCondition.field]])}),b.join()}return a.filterCondition.value},f=function(){if(a.isListValue()){var b=a.filterCondition.value.split(","),c=a.valueLookup[a.filterCondition.field],d=a.valueFieldLookup[a.filterCondition.field];_.each(b,function(b){var e=_.find(c,function(a){return a[d].toString()===b});a.filterCondition.values.push(e)})}},g=function(){b.getAllFilterConditions().then(function(b){a.filterConditions=b})};g()}function d(a,b,c,d){a.filterConditions=null,a.contentFilters=null,a.contentFilter=null,a.origContentFilter=null,a.preview=null,a.filterConditionLookup={},a.contentFiltersLookup={},a.editFilter=function(b){a.origContentFilter=b||{},a.contentFilter=_.create(a.origContentFilter),a.contentFilter.name=a.origContentFilter.name,a.contentFilter.content_filter=_.cloneDeep(a.origContentFilter.content_filter),f(),a.previewContentFilter()},a.close=function(){a.previewContentFilter(),a.origContentFilter=null,a.contentFilter=null,a.test.test_result=null,a.test.article_id=null},a.saveFilter=function(){delete a.contentFilter.article_id,b.saveContentFilter(a.origContentFilter,a.contentFilter).then(function(){c.success(gettext("Content filter saved.")),a.close()},function(a){angular.isDefined(a.data._issues)&&angular.isDefined(a.data._issues["validator exception"])?c.error(gettext("Error: "+a.data._issues["validator exception"])):angular.isDefined(a.data._issues)?a.data._issues.name&&a.data._issues.name.unique?c.error(gettext("Error: "+gettext("Name needs to be unique"))):c.error(gettext("Error: "+JSON.stringify(a.data._issues))):angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):500===a.status?c.error(gettext("Error: Internal error in Filter testing")):c.error(gettext("Error: Failed to test content filter."))}).then(h)},a.remove=function(e){d.confirm(gettext("Are you sure you want to delete content filter?")).then(function(){return b.remove(e)}).then(function(b){_.remove(a.contentFilters,e)},function(a){angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):c.error(gettext("There is an error. Content filter cannot be deleted."))})},a.addStatement=function(){a.contentFilter.content_filter.push({expression:{}})},a.removeStatement=function(b){a.contentFilter.content_filter.splice(b,1),a.previewContentFilter()},a.addFilter=function(b,c){c in b.expression||(b.expression[c]=[]),b.selected&&!_.includes(b.expression[c],b.selected)&&(b.expression[c].push(b.selected),delete b.selected,a.previewContentFilter())},a.removeFilter=function(b,c,d){b.expression[d]=_.without(b.expression[d],c),a.previewContentFilter()},a.productionTest=function(b){a.$broadcast("triggerTest",b)},a.test=function(){return a.test.article_id?void b.testContentFilter({filter:a.contentFilter,article_id:a.test.article_id}).then(function(b){a.test.test_result=b.match_results?"Does Match":"Doesn't Match"},function(a){angular.isDefined(a.data._issues)?c.error(gettext("Error: "+a.data._issues)):angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):c.error(gettext("Error: Failed to save content filter."))}):void c.error(gettext("Please provide an article id"))},a.previewContentFilter=function(){a.preview=e(a.contentFilter.content_filter)};var e=function(b){var c=[];return _.each(b,function(b){var d=[];"pf"in b.expression&&_.each(b.expression.pf,function(b){var c=a.contentFiltersLookup[b];d.push(e(c.content_filter))}),"fc"in b.expression&&_.each(b.expression.fc,function(b){var c=a.filterConditionLookup[b];d.push("("+c.field+" "+c.operator+' "'+c.value+'")')}),d.length>0&&c.push("["+d.join(" AND ")+"]")}),c.length>0?c.join(" OR "):""},f=function(){a.contentFilter.content_filter&&0!==a.contentFilter.content_filter.length||(a.contentFilter.content_filter=[{expression:{}}])},g=function(){b.getAllFilterConditions().then(function(b){a.filterConditions=b,_.each(b,function(b){a.filterConditionLookup[b._id]=b})})},h=function(){b.getAllContentFilters().then(function(b){a.contentFilters=b,_.each(a.contentFilters,function(b){a.contentFiltersLookup[b._id]=b})})};g(),h()}function e(){return{templateUrl:"scripts/superdesk-content-filters/views/manage-filters.html",controller:d}}function f(a,b,c,d,e){function f(){a.selectedItem=_.find(a.testResult,{_id:d.search()._id})||null,a.selectedItem?a.selected.preview=a.selectedItem:a.selected.preview=null}function g(b,c){var d,e,f=_.findIndex(a.testResult,a.selectedItem);-1===f?d=a.testResult[0]:(e=Math.max(0,Math.min(a.testResult.length-1,f+b)),d=a.testResult[e]),i(a.testResult[e],c)}function h(b){a.selectedItem=b,d.search("_id",b?b._id:b)}function i(a,b){h(a),b&&(b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation())}a.preview=null,a.selected={},a.selectedItem={},a.selectedfilter=null,a.testResult=null;var j=-1,k=1,l={38:j,40:k};a.resultType=[{id:"Matching",value:"true"},{id:"Non-Matching",value:"false"}],a.model={selectedType:"true"},a.close=function(){a.filter_test=null,a.testResult=null},a.preview=function(a){d.search("_id",a?a._id:a)},a.openView=function(b){a.openLightbox(b)},a.openLightbox=function(b){a.selected.view=b},a.closeLightbox=function(){a.selected.view=null},a.hideActions=function(){return!0},a.$on("$routeUpdate",f),a.handleKeyEvent=function(a){var b=a.keyCode||a.which;l[b]&&(a.preventDefault(),a.stopPropagation(),g(l[b],a))},a.fetchResults=function(){m()},a.$on("triggerTest",function(b,c){a.productionTest=!0,a.testResult=null,a.selectedfilter=c._id,m()});var m=function(){b.testContentFilter({filter_id:a.selectedfilter,return_matching:a.$eval(a.model.selectedType)}).then(function(b){a.testResult=b.match_results},function(a){angular.isDefined(a.data._issues)?c.error(gettext("Error: "+a.data._issues)):angular.isDefined(a.data._message)?c.error(gettext("Error: "+a.data._message)):c.error(gettext("Error: Failed to fetch production test results."))})}}function g(a,b,c){function d(){b.getAllContentFilters().then(function(b){a.contentFilters=b,_.each(a.contentFilters,function(b){a.contentFiltersLookup[b._id]=b})})}function e(){return b.getFilterConditionParameters().then(function(b){a.filterConditionParameters=b,_.each(b,function(b){a.operatorLookup[b.field]=b.operators,a.valueLookup[b.field]=b.values,a.valueFieldLookup[b.field]=b.value_field}),a.origFilterCondition={},a.filterCondition=_.create(a.origFilterCondition),a.filterCondition.values=[],f()})}function f(){var b=null!=a.filterCondition.value?a.filterCondition.value.split(","):[],c=a.valueLookup[a.filterCondition.field],d=a.valueFieldLookup[a.filterCondition.field];_.each(b,function(b){var e=_.find(c,function(a){return a[d].toString()===b});a.filterCondition.values.push(e)})}function g(){if(a.isListValue()){var b=[];return _.each(a.filterCondition.values,function(c){b.push(c[a.valueFieldLookup[a.filterCondition.field]])}),b.join()}return a.filterCondition.value}a.filterCondition=null,a.operatorLookup={},a.valueLookup={},a.valueFieldLookup={},a.searchResult=null,a.contentFiltersLookup={},a.isListValue=function(){return null!=a.filterCondition?_.contains(["in","nin"],a.filterCondition.operator)&&a.valueLookup[a.filterCondition.field]:void 0},a.hideList=!0,a.handleKey=function(b){return a.filterCondition.values.length>0?(c.error(gettext("single value is required")),b.preventDefault(),b.stopPropagation(),!1):void 0},a.resetValues=function(){a.searchResult=null,a.filterCondition.values.length=0,a.filterCondition.value=null},a.getFilter=function(b){return _.find(a.contentFilters,{_id:b})},a.search=function(){if(!a.loading){a.searchResult=null,a.filterCondition.value=g();var d={field:a.filterCondition.field,operator:a.filterCondition.operator,value:a.filterCondition.value};a.loading=!0,b.getFilterSearchResults(d).then(function(b){a.searchResult=b,0===b.length&&c.error(gettext("no results found")),a.filterCondition.value=null})["finally"](function(){a.loading=!1})}},e().then(function(){d()})}a.$inject=["api"],b.$inject=[],c.$inject=["$scope","contentFilters","notify","modal"],d.$inject=["$scope","contentFilters","notify","modal"],f.$inject=["$scope","contentFilters","notify","$location","$window"],g.$inject=["$scope","contentFilters","notify"];var h=angular.module("superdesk.content_filters",["superdesk.publish"]);h.config(["superdeskProvider",function(a){var c="scripts/superdesk-content-filters/views/settings.html";a.activity("/settings/content-filters",{label:gettext("Content Filters"),controller:b,controllerAs:"ctrl",templateUrl:c,category:a.MENU_SETTINGS,priority:-800,privileges:{dictionaries:1}})}]).service("contentFilters",a).controller("ContentFiltersConfigCtrl",b).controller("FilterConditionsCtrl",c).controller("ManageContentFiltersCtrl",d).controller("ProductionTestCtrl",f).controller("FilterSearchCtrl",g).directive("sdManageFiltersTab",e)}(),function(){"use strict";function a(a,b,c,d,e){function f(a){a.user&&(a.name=a.user+":"+a.language_id)}function g(b){function d(b){return a.find("dictionaries",b._id)}return c.getIdentity().then(function(c){return a.query("dictionaries",{projection:{content:0},where:{language_id:b,is_active:{$in:["true",null]},$or:[{user:c._id},{user:{$exists:!1}}]}}).then(function(a){return e.all(a._items.map(d))})})}function h(b){return c.getIdentity().then(function(c){return a.query("dictionaries",{where:{language_id:b,user:c._id}}).then(function(a){return a._items.length?a._items[0]:{name:c._id+":"+b,content:{},language_id:b,user:c._id}})})}function i(b,c){return h(c).then(function(c){var d=c.content||{};return d[b]=d[b]?d[b]+1:1,c.content=d,a.save("dictionaries",c)})}this.dictionaries=null,this.currDictionary=null,this.getActive=g,this.getUserDictionary=h,this.addWordToUserDictionary=i,this.fetch=function(b,d){return c.getIdentity().then(function(c){return a.query("dictionaries",{projection:{content:0},where:{$or:[{user:{$exists:!1}},{user:c._id}]}}).then(b,d)})},this.open=function(b,c,d){return a.find("dictionaries",b._id).then(c,d)},this.upload=function(a,c,e,g,h,i){var j=_.has(a,"_id")&&null!==a._id,k=j?"PATCH":"POST",l=j?{"If-Match":a._etag}:{},m={};angular.forEach(c,function(a,b){"content"!==b&&(m[b]=null===a?a:a.toString())}),f(m),c.hasOwnProperty("content")&&(m.content_list=angular.toJson(c.content)),b.resource("dictionaries").then(function(b){return j&&(b+="/"+a._id),d.upload({url:b,method:k,data:m,file:e,headers:l}).then(g,h,i)},h)},this.update=function(b,c,d,e){var g={};return angular.forEach(c,function(a,b){g[b]="is_active"===b?a.toString():a}),f(g),a.save("dictionaries",b,g).then(d,e)},this.remove=function(b,c,d){return a.remove(b).then(c,d)}}function b(a,b,c,d,e,f){a.dictionaries=null,a.origDictionary=null,a.dictionary=null,a.fetchDictionaries=function(){b.fetch(function(b){a.dictionaries=b})},a.createDictionary=function(){a.dictionary={is_active:"true"},a.origDictionary={}},a.createPersonalDictionary=function(){return d.getIdentity().then(function(b){a.dictionary={is_active:"true",user:b._id,name:b._id},a.origDictionary={}})},a.openDictionary=function(c){b.open(c,function(b){a.origDictionary=b,a.dictionary=_.create(b),a.dictionary.content=_.create(b.content||{}),a.dictionary.is_active="false"!==a.dictionary.is_active})},a.closeDictionary=function(){a.dictionary=a.origDictionary=null},a.remove=function(d){e.confirm(c("Please confirm you want to delete dictionary.")).then(function(){b.remove(d,function(){_.remove(a.dictionaries._items,d),f.success(c("Dictionary deleted."),3e3)})})},a.fetchDictionaries()}function c(a,b,c,d,e,f){function g(b){return a.closeDictionary(),a.fetchDictionaries(),e.success(d("Dictionary saved succesfully")),a.progress=null,b}function h(b){angular.isDefined(b.data._issues)?angular.isDefined(b.data._issues["validator exception"])?e.error(d("Error: "+b.data._issues["validator exception"])):angular.isDefined(b.data._issues.name)&&(e.error(d("Error: The dictionary already exists.")),a._errorUniqueness=!0):e.error(d("Error. Dictionary not saved.")),a.progress=null}function i(a,b){return b.length>=a.length&&b.substr(0,a.length)===a}function j(a){k.hasOwnProperty(a[0])?k[a[0]].push(a):k[a[0]]=[a]}a.$on("fileSelected",function(b,c){a.$apply(function(){a.file=c.file})}),a.save=function(){a._errorUniqueness=!1,a.progress={width:1},a.file?b.upload(a.origDictionary,a.dictionary,a.file,g,h,function(b){a.progress.width=Math.round(b.loaded/b.total*100)}):b.update(a.origDictionary,a.dictionary,g,h)},a.cancel=function(){a._errorUniqueness=!1,a.closeDictionary()},a.addWord=function(b){a.dictionary.content.hasOwnProperty(b)||j(b),a.dictionary.content[b]=1,a.filterWords(b),a.wordsCount++},a.removeWord=function(b,c){a.dictionary.content[b]=0,a.filterWords(c),a.wordsCount--},a.filterWords=function(b){if(a.words=[],a.isNew=!!b,b&&k[b[0]]){for(var c,d=k[b[0]],e=d.length,f=[],g=0;e>g;g++)c=d[g],a.dictionary.content[c]>0&&i(b,c)&&(f.push(c),c.length===b.length&&(a.isNew=!1));var h=10;f.sort(),f.splice(h,f.length-h),a.words=f}};var k={};a.wordsCount=0;for(var l in a.dictionary.content)(a.dictionary.content.hasOwnProperty(l)||a.origDictionary.content.hasOwnProperty(l))&&(j(l),a.wordsCount++)}a.$inject=["api","urls","session","$upload","$q"],b.$inject=["$scope","dictionaries","gettext","session","modal","notify"],c.$inject=["$scope","dictionaries","upload","gettext","notify","modal"];var d=angular.module("superdesk.dictionaries",["superdesk.activity","superdesk.upload"]);d.config(["superdeskProvider",function(a){a.activity("/settings/dictionaries",{label:gettext("Dictionaries"),controller:b,templateUrl:"scripts/superdesk-dictionaries/views/settings.html",category:a.MENU_SETTINGS,priority:-800,privileges:{dictionaries:1}})}]).service("dictionaries",a).controller("DictionaryEdit",c).directive("sdDictionaryConfig",function(){return{controller:b}}).directive("sdDictionaryConfigModal",function(){return{controller:"DictionaryEdit",require:"^sdDictionaryConfig",templateUrl:"scripts/superdesk-dictionaries/views/dictionary-config-modal.html"}}).directive("fileUpload",function(){return{scope:!0,link:function(a,b,c){b.bind("change",function(b){a.$emit("fileSelected",{file:b.target.files[0]})})}}})}(),function(){"use strict";function a(a,b){var c=this;this.getVocabularies=function(){return"undefined"==typeof c.vocabularies?a.query("vocabularies").then(function(a){return c.vocabularies=a,c.vocabularies}):b.when(c.vocabularies)}}function b(a,b){a.openVocabulary=function(b){a.vocabulary=b},b.getVocabularies().then(function(b){a.vocabularies=b})}function c(a,b,c,d,e,f){function g(){a.vocabulary=null}function h(a){return c.success(b("Vocabulary saved succesfully")),g(),a}function i(a){angular.isDefined(a.data._issues)&&(angular.isDefined(a.data._issues["validator exception"])?c.error(b("Error: "+a.data._issues["validator exception"])):c.error(b("Error. Vocabulary not saved.")))}var j=_.cloneDeep(a.vocabulary.items);a.save=function(){a._errorUniqueness=!1,d.save("vocabularies",a.vocabulary).then(h,i),f.loaded=null,f.initialize()},a.cancel=function(){a.vocabulary.items=j,g()},a.addItem=function(){a.vocabulary.items.push(k)},a.removeItem=function(b){a.vocabulary.items.splice(a.vocabulary.items.indexOf(b),1)};var k=_.mapValues(_.indexBy(_.uniq(_.flatten(_.map(a.vocabulary.items,function(a){return _.keys(a)})))),function(){return null});a.model=k}a.$inject=["api","$q"],b.$inject=["$scope","vocabularies"],c.$inject=["$scope","gettext","notify","api","vocabularies","metadata"];var d=angular.module("superdesk.vocabularies",["superdesk.activity"]);d.config(["superdeskProvider",function(a){a.activity("/settings/vocabularies",{label:gettext("Vocabularies"),templateUrl:"scripts/superdesk-vocabularies/views/settings.html",category:a.MENU_SETTINGS,priority:-800,privileges:{vocabularies:1}})}]).service("vocabularies",a).controller("VocabularyEdit",c).controller("VocabularyConfig",b).directive("sdVocabularyConfig",function(){return{scope:{vocabulary:"="},controller:"VocabularyConfig",templateUrl:"scripts/superdesk-vocabularies/views/vocabulary-config.html"}}).directive("sdVocabularyConfigModal",function(){return{scope:{vocabulary:"="},controller:"VocabularyEdit",templateUrl:"scripts/superdesk-vocabularies/views/vocabulary-config-modal.html"}})}(),function(){"use strict";return angular.module("superdesk.archive.directives",["superdesk.filters","superdesk.authoring","superdesk.ingest","superdesk.workflow"]).directive("sdItemLock",["api","lock","privileges",function(a,b,c){return{templateUrl:"scripts/superdesk-archive/views/item-lock.html",scope:{item:"="},link:function(d){function e(){d.privileges=c.privileges,d.lock={user:null,lockbyme:!1}}e(),d.$watch("item.lock_session",function(){e(),d.item&&b.isLocked(d.item)&&a("users").getById(d.item.lock_user).then(function(a){d.lock.user=a,d.lock.lockbyme=b.isLockedByMe(d.item)})}),d.unlock=function(){b.unlock(d.item).then(function(){d.item.lock_user=null,d.item.lock_session=null,d.lock=null,d.isLocked=!1})},d.can_unlock=function(){return b.can_unlock(d.item)},d.$on("item:lock",function(a,b){d.item&&d.item._id===b.item&&(d.item.lock_user=b.user,d.item.lock_time=b.lock_time,d.item.lock_session=b.lock_session,d.$digest())}),d.$on("item:unlock",function(a,b){d.item&&d.item._id===b.item&&(d.item.lock_user=null,d.item.lock_session=null,d.$digest())})}}}]).directive("sdInlineMeta",function(){return{templateUrl:"scripts/superdesk-archive/views/inline-meta.html",scope:{placeholder:"@",showmeta:"=",item:"=",setmeta:"&"}}}).directive("sdMediaPreview",[function(){return{templateUrl:"scripts/superdesk-archive/views/preview.html"}}]).directive("sdMediaPreviewWidget",[function(){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/archive-widget/item-preview.html"}}]).directive("sdItemPreviewContainer",function(){return{template:'<div ng-if="item" sd-media-view data-item="item" data-close="close()"></div>',scope:{},link:function(a){a.item=null,a.$on("intent:preview:item",function(b,c){a.item=c.data}),a.close=function(){a.item=null}}}}).directive("sdMediaView",["keyboardManager","packages",function(a,b){return{templateUrl:"scripts/superdesk-archive/views/media-view.html",scope:{items:"=",item:"=",close:"&"},link:function(c,d){var e=[];c.singleItem=null,c.packageItem=null,c.prevEnabled=!0,c.nextEnabled=!0;var f=function(a){return _.findIndex(c.items,{_id:a._id})},g=function(a){i(),c.item=a,c.openItem(a);var b=f(c.item);c.prevEnabled=b>-1&&!!c.items[b-1],c.nextEnabled=b>-1&&!!c.items[b+1]};c.prev=function(){var a=f(c.item);a>0&&g(c.items[a-1])},c.next=function(){var a=f(c.item);-1!==a&&a<c.items.length-1&&g(c.items[a+1])},a.push("left",c.prev),a.push("right",c.next),c.$on("$destroy",function(){a.pop("left"),a.pop("right")}),c.setPackageSingle=function(a){b.fetchItem(a).then(function(a){c.openItem(a)})},c.openItem=function(a){"composite"===a.type&&(e.push(a),h()),c.setSingleItem(a)},c.setSingleItem=function(a){c.singleItem=a},c.nested=function(){return e.length>1},c.previousPackage=function(){_.remove(e,_.last(e)),h(),c.setSingleItem(c.packageItem)};var h=function(){c.packageItem=_.last(e)||null},i=function(){e=[],c.packageItem=null};g(c.item)}}}]).directive("sdMediaMetadata",["userList","archiveService",function(a,b){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/views/metadata-view.html",link:function(c,d){function e(){c.originalCreator=c.item.original_creator,c.versionCreator=c.item.version_creator,b.isLegal(c.item)||(c.item.original_creator&&a.getUser(c.item.original_creator).then(function(a){c.originalCreator=a.display_name}),c.item.version_creator&&a.getUser(c.item.version_creator).then(function(a){c.versionCreator=a.display_name}))}c.$watch("item",e)}}}]).directive("sdMediaRelated",["familyService","superdesk",function(a,b){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/views/related-view.html",link:function(c,d){c.$watch("item",function(){a.fetchItems(c.item.family_id||c.item._id,c.item).then(function(a){c.relatedItems=a})}),c.open=function(a){b.intent("read_only","content_article",a)}}}}]).directive("sdFetchedDesks",["desks","familyService","$location",function(a,b,c){return{scope:{item:"="},templateUrl:"scripts/superdesk-archive/views/fetched-desks.html",link:function(d,e){d.$watchGroup(["item","item.archived"],function(){d.item&&b.fetchDesks(d.item,!1).then(function(a){d.desks=a})}),d.selectFetched=function(b){a.setCurrentDeskId(b.desk._id),c.path("/workspace/content").search("_id="+b.itemId)}}}}]).directive("sdMetaIngest",["ingestSources",function(a){return{scope:{item:"="},template:"{{name}}",link:function(b){b.$watch("item",function(){b.name="",!b.item.ingest_provider&&"source"in b.item&&(b.name=b.item.source),a.initialize().then(function(){b.item.ingest_provider&&b.item.ingest_provider in a.providersLookup&&(b.name=a.providersLookup[b.item.ingest_provider].name)})})}}}]).directive("sdSingleItem",[function(){return{templateUrl:"scripts/superdesk-archive/views/single-item-preview.html",scope:{item:"=",contents:"=",setitem:"&"}}}]).directive("sdMediaBox",["$location","lock","multi","archiveService",function(a,b,c,d){return{restrict:"A",templateUrl:"scripts/superdesk-archive/views/media-box.html",link:function(e,f,g){e.lock={isLocked:!1},e.$watch("view",function(a){switch(a){case"mlist":case"compact":e.itemTemplate="scripts/superdesk-archive/views/media-box-list.html";break;default:e.itemTemplate="scripts/superdesk-archive/views/media-box-grid.html"}}),e.$watch("item",function(a){e.lock.isLocked=a&&(b.isLocked(a)||b.isLockedByMe(a))}),e.$on("item:lock",function(a,b){e.item&&e.item._id===b.item&&(e.lock.isLocked=!0,e.item.lock_user=b.user,e.item.lock_session=b.lock_session,e.item.lock_time=b.lock_time,e.$digest())}),e.$on("item:unlock",function(a,b){e.item&&e.item._id===b.item&&(e.lock.isLocked=!1,e.item.lock_user=null,e.item.lock_session=null,e.item.lock_time=null,e.$digest())}),e.$on("task:progress",function(a,b){b.task===e.item.task_id&&(0===b.progress.total?e._progress=10:e._progress=Math.min(100,Math.round(100*b.progress.current/b.progress.total)),e.$digest())}),e.clickAction=function(b){return"function"==typeof e.preview?(a.search("fetch",null),e.preview(b)):!1},e.toggleSelected=function(a){c.toggle(a)},e.getType=function(a){return d.getType(a)}}}}]).directive("sdItemCrops",["metadata",function(a){return{templateUrl:"scripts/superdesk-archive/views/item-crops.html",scope:{item:"="},link:function(b,c){a.initialize().then(function(){b.crop_sizes=a.values.crop_sizes})}}}]).directive("sdItemRendition",function(){return{templateUrl:"scripts/superdesk-archive/views/item-rendition.html",scope:{item:"=",rendition:"@",ratio:"=?"},link:function(a,b){function c(){var c=b.find("figure");if(c&&a.ratio){var d=c.find("img")[0],e=d?d.naturalWidth/d.naturalHeight:1;a.ratio>e?c.parent().addClass("portrait"):c.parent().removeClass("portrait")}}a.$watch("item.renditions[rendition].href",function(a){var d=b.find("figure"),e=d.find("img").css("opacity",.5);if(a){var f=new Image;f.onload=function(){e.length?e.replaceWith(f):d.html(f),c()},f.onerror=function(){d.html("")},f.src=a}});var d=a.$watch("ratio",function(a){void 0===a&&d(),e()}),e=_.debounce(c,150)}}}).directive("sdRatioCalc",["$window",function(a){return{link:function(b,c){function d(){b.ratio=c.outerWidth()/c.outerHeight()}function e(){d(),b.$apply()}var f=angular.element(a);d(),f.bind("resize",e),b.$on("$destroy",function(){f.unbind("resize",e)})}}}]).directive("sdHtmlPreview",["$sce",function(a){return{scope:{sdHtmlPreview:"="},template:'<div ng-bind-html="html"></div>',link:function(b,c,d){b.$watch("sdHtmlPreview",function(c){b.html=a.trustAsHtml(c)})}}}]).directive("sdProviderMenu",["$location",function(a){return{scope:{items:"="},templateUrl:"scripts/superdesk-archive/views/provider-menu.html",link:function(b,c,d){b.setProvider=function(c){b.selected=c,a.search("provider",b.selected)},b.$watchCollection(function(){return a.search()},function(a){a.provider&&(b.selected=a.provider)})}}}]).directive("sdGridLayout",function(){return{templateUrl:"scripts/superdesk-items-common/views/grid-layout.html",scope:{items:"="},link:function(a,b,c){a.view="mgrid",a.preview=function(b){a.previewItem=b}}}}).directive("sdContentResults",["$location","preferencesService","packages","tags","asset",function(a,b,c,d,e){var f={"archive:view":{allowed:["mgrid","compact"],category:"archive",view:"mgrid","default":"mgrid",label:"Users archive view format",type:"string"}};return{require:"^sdSearchContainer",templateUrl:e.templateUrl("superdesk-search/views/search-results.html"),link:function(d,e,g,h){function i(a){d.view=a||"mgrid",f["archive:view"].view=a||"mgrid",b.update(f,"archive:view")}function j(){var a=d.view===l?k:l;return i(a)}var k="mgrid",l="compact",m=void 0===g.multiSelectable?!1:!0;d.flags=h.flags,d.selected=d.selected||{},d.preview=function(b){m&&(-1===_.findIndex(d.selectedList,{_id:b._id})?d.selectedList.push(b):_.remove(d.selectedList,{_id:b._id})),d.selected.preview=b,a.search("_id",b?b._id:null)},d.openLightbox=function(){d.selected.view=d.selected.preview},d.closeLightbox=function(){d.selected.view=null},d.openSingleItem=function(a){c.fetchItem(a).then(function(a){d.selected.view=a})},d.setview=i;var n;b.get("archive:view").then(function(a){n=a.view,d.view=n&&"undefined"!==n?n:"mgrid"}),d.$on("key:v",j),d.generateTrackIdentifier=function(a){return"ingested"===a.state?a._id:a._id+":"+(a._current_version||a.item_version)}}}}]).service("familyService",["api","desks",function(a,b){this.fetchItems=function(b,c){var d="archive";c&&"published"===c._type&&(d="published");var e=[{not:{term:{state:"spiked"}}},{term:{family_id:b}}];return c&&"published"!==c._type&&e.push({not:{term:{_id:c._id}}}),a(d).query({source:{query:{filtered:{filter:{and:e}}},sort:[{versioncreated:"desc"}],size:100,from:0}})},this.fetchDesks=function(a,c){return this.fetchItems("ingested"===a.state?a._id:a.family_id,c?a:void 0).then(function(a){var c=[],d=[];return _.each(a._items,function(a){a.task&&a.task.desk&&b.deskLookup[a.task.desk]&&(d.indexOf(a.task.desk)<0?(c.push({desk:b.deskLookup[a.task.desk],count:1,itemId:a._id}),d.push(a.task.desk)):c[d.indexOf(a.task.desk)].count+=1)}),c})}}])}(),function(){"use strict";function a(a,b,c){function d(){return f?(g||(g=c.getActive(f).then(function(a){return g.content={},angular.forEach(a,e),g.content})),g):a.reject()}function e(a){angular.extend(g.content,a.content||{})}var f,g,h;this.setLanguage=function(a){f!==a&&(f=a,g=null)},this.errors=function(a){return d().then(function(b){for(var c,d=[],e=/[0-9a-zA-Z\u00C0-\u1FFF\u2C00-\uD7FF]+/g,f=0,i=document.createTreeWalker(a,NodeFilter.SHOW_TEXT);i.nextNode();){for(;null!=(c=e.exec(i.currentNode.textContent));){var j=c[0];isNaN(j)&&!g.content[j.toLowerCase()]&&d.push({word:j,index:f+c.index})}f+=i.currentNode.length}return h=d.length,d})},this.countErrors=function(){return h},this.suggest=function(a){return b.save("spellcheck",{word:a,language_id:f}).then(function(a){return a.corrections||[]})},this.addWordToUserDictionary=function(a){a=a.toLowerCase(),c.addWordToUserDictionary(a,f),g.content[a]=g.content[a]?g.content[a]+1:1;
}}function b(a,b){function c(){a.setSettings({spellcheck:!0}),a.render(),a.setSettings({spellcheck:!1})}function d(){a.setSettings({spellcheck:e.isAuto})}this.isAuto=a.settings.spellcheck||!0,this.spellcheck=c,this.pushSettings=d;var e=this}a.$inject=["$q","api","dictionaries"],b.$inject=["editor","$rootScope"],angular.module("superdesk.editor.spellcheck",["superdesk.dictionaries","superdesk.editor"]).service("spellcheck",a).controller("SpellcheckMenu",b)}(),function(){"use strict";function a(a){a.activity("/workspace/monitoring",{label:gettext("Monitoring"),priority:100,templateUrl:"scripts/superdesk-monitoring/views/monitoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}function b(a){a.activity("/workspace/spike-monitoring",{label:gettext("Spike Monitoring"),priority:100,templateUrl:"scripts/superdesk-monitoring/views/spike-monitoring.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}function c(a){a.activity("/workspace/personal",{label:gettext("Personal"),priority:100,templateUrl:"scripts/superdesk-monitoring/views/personal.html",topTemplateUrl:"scripts/superdesk-dashboard/views/workspace-topnav.html",sideTemplateUrl:"scripts/superdesk-workspace/views/workspace-sidenav.html"})}function d(a,b,c){function d(a,d,e){var f={};"search"===a.type&&a.search&&a.search.filter.query?(f=a.search.filter.query,a.query&&(a.search.filter.query.q?f.q="("+a.query+") "+a.search.filter.query.q:f.q="("+a.query+") ")):f.q=a.query,f.spike="spike"===a.type||"spike-personal"===a.type;var g=b.query(f);switch(a.type){case"search":break;case"spike-personal":case"personal":g.filter({bool:{must:{term:{original_creator:c.identity._id}},must_not:{exists:{field:"task.desk"}}}});break;case"spike":g.filter({term:{"task.desk":a._id}});break;case"highlights":g.filter({and:[{term:{highlights:e.highlight}}]});break;default:g.filter({term:{"task.stage":a._id}})}a.fileType&&g.filter({terms:{type:JSON.parse(a.fileType)}}),d&&g.filter({query:{query_string:{query:d,lenient:!1}}});var h={source:g.getCriteria()};return"search"===a.type&&a.search&&a.search.filter.query.repo&&(h.repo=a.search.filter.query.repo),h.source.from=0,h.source.size=25,h}function e(a,b){switch(a.type){case"stage":return!!b.stages[a._id];case"personal":return b.user===c.identity._id;default:return!0}}this.criteria=d,this.shouldUpdate=e}function e(a){function b(a){f.previewItem=a,f.state["with-preview"]=!!a}function c(){b(null)}function d(a){f.editItem=a,f.state["with-authoring"]=!!a}function e(a){f.singleGroup=a}this.state={},this.preview=b,this.closePreview=c,this.previewItem=null,this.singleGroup=null,this.viewSingleGroup=e,this.queryParam=a.search(),this.edit=d,this.editItem=null;var f=this}function f(){return{templateUrl:"scripts/superdesk-monitoring/views/monitoring-view.html",controller:"Monitoring",controllerAs:"monitoring",scope:{type:"=",state:"="}}}function g(){return{templateUrl:"scripts/superdesk-monitoring/views/monitoring-group-header.html"}}function h(a,b,c,d,e,f,g){function h(a){return"ingested"===a.state?a._id:a._id+":"+a._current_version}var i=57,j=5,k=8,l=-1,m=1,n=13,o={38:l,40:m};return{templateUrl:"scripts/superdesk-monitoring/views/monitoring-group.html",require:["^sdMonitoringView"],scope:{group:"=",numItems:"=",viewType:"="},link:function(c,l,m,p){function q(){e.cancel(F),F=e(u,50,!1)}function r(a,b){if("spiked"!==a.state)if("ingest"===a._type){var c={action:"list",type:"ingest"},e=f.findActivities(c,a)[0];g.start(e,{data:{item:a}}).then(function(a){d.edit(a,!b),E.preview(null)})}else d.edit(a,!b),E.preview(null)}function s(a){c.selected=a,E.preview(a)}function t(a){s(a)}function u(){return I=a.criteria(c.group,null,E.queryParam),I.source.size=0,c.loading=!0,c.total=null,w().then(function(a){c.total=a._meta.total,c.$applyAsync(v)})["finally"](function(){c.loading=!1})}function v(){var a=H[0].scrollTop,b=Math.floor(a/i),d=Math.max(0,b-k),e=c.numItems||j,f=Math.min(c.total,b+e+k);return parseInt(G.style.height,10)!==c.total*i&&(G.style.height=c.total*i+"px"),I.source.from=d,I.source.size=f-d,w().then(function(a){c.$applyAsync(function(){c.total!==a._meta.total&&(c.total=a._meta.total,G.style.height=c.total*i+"px"),G.style.paddingTop=d*i+"px",c.items=z(a._items)})})}function w(){var a="search";return"search"===c.group.type?I.repo&&-1===I.repo.indexOf(",")&&(a=I.repo,I.source.size||(I.source.size=25)):a="archive",b.query(a,I)}function x(){c.total+=c.newItemsCount,c.newItemsCount=0,v()}function y(a){E.viewSingleGroup(a)}function z(a){var b=[],d=c.items||[];return angular.forEach(a,function(a){var c="ingested"===a.state?{_id:a._id}:{_id:a._id,_current_version:a._current_version},e=_.find(d,c);b.push(e?angular.extend(e,a):a)}),b}function A(a){e.cancel(J),J=e(v,100,!1)}function B(a){var b=a.keyCode||a.which;o[b]?(a.preventDefault(),a.stopPropagation(),e.cancel(J),D(o[b],a),A()):b===n&&c.$applyAsync(function(){r(c.selected)})}function C(a,b){c.select(a),b&&(b.preventDefault(),b.stopPropagation(),b.stopImmediatePropagation())}function D(a,b){var d,f,g=_.findIndex(c.items,c.selected),h=c.numItems||j;-1===g?d=c.items[0]:(f=Math.max(0,Math.min(c.items.length-1,g+a)),d=c.items[f],e.cancel(K),K=e(function(){var a=H[0].scrollTop,b=Math.ceil(a/i),c=Math.floor((a+H[0].clientHeight)/i),d=f+I.source.from;b>d?H[0].scrollTop=Math.max(0,d*i):d>=c&&(H[0].scrollTop=(d-h+1)*i)},50,!1)),c.$apply(function(){C(c.items[f],b)})}var E=p[0];c.view="compact",c.page=1,c.fetching=!1,c.cacheNextItems=[],c.cachePreviousItems=[],c.limited=E.singleGroup||"highlights"===c.group.type?!1:!0,c.uuid=h,c.edit=r,c.select=s,c.preview=t,c.renderNew=x,c.viewSingleGroup=y,c.$watchCollection("group",u),c.$on("task:stage",u),c.$on("ingest:update",u),c.$on("item:spike",u),c.$on("item:unspike",u),c.$on("$routeUpdate",u),c.$on("content:update",function(b,d){a.shouldUpdate(c.group,d)&&q()});var F,G=l[0].getElementsByClassName("inline-content-items")[0],H=l.find(".stage-content").first();H.on("keydown",B),H.on("scroll",A),c.$on("$destroy",function(){H.off()});var I,J,K}}}function i(a,b,c,d){return{scope:{item:"=",active:"="},templateUrl:"scripts/superdesk-monitoring/views/item-actions-menu.html",link:function(e){function f(b){var d={action:"list",type:g(b)},f={};return a.findActivities(d,b).forEach(function(a){if(c.isActionAllowed(e.item,a.action)){var b=a.group||"default";f[b]=f[b]||[],f[b].push(a)}}),f}function g(a){return d.getType(a)}e.toggleActions=function(a){e.actions=a?f(e.item):e.actions,e.open=a},e.stopEvent=function(a){a.stopPropagation()},e.run=function(a){return b.start(a,{data:{item:e.item}})}}}}angular.module("superdesk.monitoring",["superdesk.api","superdesk.aggregate","superdesk.search","superdesk.ui"]).service("cards",d).controller("Monitoring",e).directive("sdMonitoringView",f).directive("sdMonitoringGroup",h).directive("sdMonitoringGroupHeader",g).directive("sdItemActionsMenu",i).config(a).config(b).config(c),a.$inject=["superdeskProvider"],b.$inject=["superdeskProvider"],c.$inject=["superdeskProvider"],d.$inject=["api","search","session"],e.$inject=["$location"],h.$inject=["cards","api","desks","authoringWorkspace","$timeout","superdesk","activityService"],i.$inject=["superdesk","activityService","workflowService","archiveService"]}(),function(){"use strict";function a(a,b,c,d,e){function f(b,d){return d?a.save(t,b,d).then(j):(b.user=b.user||c.identity._id,a.save(t,b).then(j))}function g(b){return a.remove(b).then(function(){return u.active&&u.active._id===b._id?u.queryUserWorkspaces():e.when()}).then(function(a){a&&a.length?u.setActive(a[0]):u.setActive(null),u.getActive()})}function h(a){var b={};return b[s]={workspace:a._id},d.update(b,s),p(a._id).then(j)}function i(a){j(a);var b={};b[s]={workspace:a?a._id:""},d.update(b,s)}function j(a){return u.active=a||null,a}function k(){return d.get(s).then(function(a){return a&&a.workspace?a.workspace:null})}function l(){return b.initialize().then(k).then(function(a){var c=null,d=null;return b.activeDeskId&&b.deskLookup[b.activeDeskId]?(c="desk",d=b.activeDeskId):a&&b.deskLookup[a]?(c="desk",d=a,b.setCurrentDeskId(a)):a?(c="workspace",d=a):b.getCurrentDeskId()&&(c="desk",d=b.getCurrentDeskId()),u.workspaceType=c,{id:d,type:c}})}function m(){return l().then(function(a){return"desk"===a.type?p(a.id):"workspace"===a.type?o(a.id):void 0})}function n(){return l().then(function(a){return"desk"===a.type?p(a.id):"workspace"===a.type?o(a.id):q()}).then(j)}function o(b){return a.find(t,b)}function p(b){return a.query("workspaces",{where:{desk:b}}).then(function(a){return 1===a._items.length?a._items[0]:{desk:b,widgets:[]}})}function q(){return{user:c.identity._id,widgets:c.identity.workspace?c.identity.workspace.widgets:[]}}function r(){return c.getIdentity().then(function(b){return a.query(t,{where:{user:b._id}})}).then(function(a){return a._items})}this.active=null,this.save=f,this["delete"]=g,this.setActive=i,this.setActiveDesk=h,this.getActive=n,this.getActiveId=l,this.readActive=m,this.queryUserWorkspaces=r;var s="workspace:active",t="workspaces",u=this}function b(a,b,c,d,e,f,g){return{templateUrl:"scripts/superdesk-workspace/views/workspace-dropdown.html",link:function(c){function d(){e.search("_id",null)}function g(){var d=null;b.getActiveId().then(function(a){d=a}).then(angular.bind(a,a.fetchCurrentUserDesks)).then(function(a){c.desks=a._items}).then(b.queryUserWorkspaces).then(function(a){c.wsList=a,c.workspaceType=d.type,"desk"===d.type?c.selected=_.find(c.desks,{_id:d.id}):"workspace"===d.type?c.selected=_.find(c.wsList,{_id:d.id}):c.selected=null})}c.workspaces=b,c.wsList=null,c.edited=null,c.afterSave=function(d){a.setCurrentDeskId(null),b.setActive(d),c.selected=d},c.selectDesk=function(e){d(),c.selected=e,c.workspaceType="desk",a.setCurrentDeskId(e._id),b.setActiveDesk(e),f.activeDesk=a.active.desk},c.selectWorkspace=function(e){d(),c.selected=e,c.workspaceType="workspace",a.setCurrentDeskId(null),b.setActive(e)},c.createWorkspace=function(){c.edited={}},c.$watch(function(){return b.active},g,!0)}}}function c(){return{templateUrl:"scripts/superdesk-workspace/views/workspace-sidenav-items.html",link:function(a){a.hideMonitoring=function(b,c){var d=a.$parent.flags;d.authoring&&b?(c.preventDefault(),d.hideMonitoring=!d.hideMonitoring):d.hideMonitoring=!1}}}}function d(a){return{templateUrl:"scripts/superdesk-workspace/views/edit-workspace-modal.html",scope:{workspace:"=",done:"="},link:function(b){b.workspaces=a,b.save=function(){a.save(b.workspace).then(function(){b.errors=null;var a=b.workspace;return b.workspace=null,b.done?b.done(a):void 0},function(a){b.errors=a.data._issues})},b.cancel=function(){b.workspace=null}}}}angular.module("superdesk.workspace",["superdesk.workspace.content"]).service("workspaces",a).directive("sdDeskDropdown",b).directive("sdWorkspaceSidenav",c).directive("sdEditWorkspace",d),a.$inject=["api","desks","session","preferencesService","$q"],b.$inject=["desks","workspaces","$route","preferencesService","$location","reloadService","notifyConnectionService"],c.$inject=[],d.$inject=["workspaces"]}();